<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>استمارات الرصد التفاعلية</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <!-- PDF -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- OCR عربي (اختياري - لاستيراد أسماء من صورة) -->
  <script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#0ea5e9;

      --p1:#e9f5e9;
      --p2:#eaf1ff;
      --sum:#fdebdc;
      --avg:#fff6cf;
      --final:#ffd7dc;
      --total:#efefef;

      --ok:#16a34a;
      --bad:#ef4444;
      --neu:#9ca3af;

      --c-part:#c59a00;
      --c-home:#2aa7df;
      --c-perf:#7b8ea6;
      --c-class:#a8d18d;

      --printScale: 1; /* يتم ضبطها تلقائيًا عند الطباعة */
    }

    *{box-sizing:border-box}
    html, body{width:100%; max-width:100%; overflow-x:hidden;}
    body{
      margin:0;
      font-family:"Cairo", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg);
    }

    header{
      padding:18px 16px 10px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title{display:flex; gap:10px; align-items:center;}
    .badge{
      width:44px; height:44px; border-radius:12px;
      background:linear-gradient(135deg,#22c55e,#0ea5e9);
      display:grid; place-items:center;
      color:white; font-weight:900;
      flex:0 0 auto;
    }
    h1{margin:0; font-size:18px}
    .sub{color:var(--muted); font-size:12px; margin-top:2px}

    .top-actions{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      max-width:100%;
    }

    button, .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-family:inherit;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
    }
    button.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:white;
    }
    button.danger{
      background:#ef4444;
      border-color:#ef4444;
      color:white;
    }
    button:disabled{opacity:.6; cursor:not-allowed}

    main{
      padding:0 16px 18px;
      display:grid;
      grid-template-columns: 390px 1fr;
      gap:12px;
      max-width:100%;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 1px 0 rgba(17,24,39,.04);
      max-width:100%;
    }
    .card-hd{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .card-hd .hd-title{font-weight:900;font-size:14px;}
    .card-bd{padding:12px}

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:800;
    }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      font-family:inherit;
      font-size:13px;
      background:#fff;
      outline:none;
      max-width:100%;
    }
    textarea{min-height:88px; resize:vertical}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    @media (max-width: 980px){
      .row,.row3{grid-template-columns:1fr}
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.6;
    }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      max-width:100%;
    }
    .dot{width:10px;height:10px;border-radius:50%;}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .dot.neu{background:#f59e0b}

    #printArea{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      max-width:100%;
    }

    .form-header{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .form-header h2{
      margin:0;
      font-size:16px;
      font-weight:900;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      max-width:100%;
    }
    .meta .kv{
      border:1px solid var(--line);
      border-radius:10px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      background:#fff;
      font-weight:900;
      white-space:nowrap;
      max-width:100%;
    }

    .wrapX{width:100%; overflow:auto; -webkit-overflow-scrolling:touch;}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      table-layout:fixed;
      min-width:900px; /* للجوال: يسمح بالتمرير داخل المعاينة فقط */
    }
    .fit-table table{min-width:0;} /* عند الطباعة: لا حد أدنى */
    th, td{
      border:1px solid #111;
      padding:6px 6px;
      text-align:center;
      vertical-align:middle;
      white-space:normal;
      word-break:break-word;
    }
    th{font-weight:900}
    .p1{background:var(--p1)}
    .p2{background:var(--p2)}
    .sum{background:var(--sum)}
    .avg{background:var(--avg)}
    .final{background:var(--final)}
    .total{background:var(--total)}
    .namecell{text-align:right; font-weight:900}

    /* إدخالات داخل الجداول (كتابة مباشرة + أرقام كاملة) */
    .inline-input{
      width:100%;
      padding:6px 6px;
      border:1px solid #000;
      border-radius:6px;
      font-family:inherit;
      font-size:12px;
      text-align:center;
      background:#fff;
      max-width:100%;
    }
    .inline-input.name{text-align:right;font-weight:900}
    .inline-input.num{
      text-align:center;
      direction:ltr;
      unicode-bidi:plaintext;
      font-variant-numeric: tabular-nums;
    }
    input.inline-input.num{
      -moz-appearance:textfield;
    }
    input.inline-input.num::-webkit-outer-spin-button,
    input.inline-input.num::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0; }

    .footer-note{
      padding:10px 14px 14px;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }

    .signatures{
      margin:10px 14px 14px;
      border-top:1px solid var(--line);
      padding-top:10px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width: 820px){
      .signatures{grid-template-columns:1fr}
    }
    .sig-box{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#fafafa;
    }
    .sig-box b{display:block;margin-bottom:8px}
    .sig-line{
      border:none;
      border-bottom:2px dotted #111;
      border-radius:0;
      padding:6px 8px;
      background:transparent;
      width:100%;
      font-weight:900;
    }

    .status{
      font-size:12px;
      color:var(--muted);
      line-height:1.6;
      margin-top:8px;
      padding:8px 10px;
      border:1px dashed var(--line);
      border-radius:10px;
      background:#fafafa;
    }

    .mark-btn{
      width:26px;height:26px;
      border-radius:6px;
      border:1px solid #111;
      display:inline-grid;
      place-items:center;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      background:#fff;
      font-size:14px;
      padding:0;
    }
    .mark-btn.ok{background:#dcfce7; border-color:#16a34a; color:#14532d}
    .mark-btn.bad{background:#fee2e2; border-color:#ef4444; color:#7f1d1d}
    .mark-btn.neu{background:#fff; border-color:#111; color:#111}

    .crit-h.part{background:color-mix(in oklab, var(--c-part) 30%, white)}
    .crit-h.home{background:color-mix(in oklab, var(--c-home) 30%, white)}
    .crit-h.perf{background:color-mix(in oklab, var(--c-perf) 30%, white)}
    .crit-h.class{background:color-mix(in oklab, var(--c-class) 30%, white)}

    .overlay{
      position:fixed; inset:0;
      background:rgba(17,24,39,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .overlay.show{display:flex;}
    .overlay .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      border:1px solid var(--line);
      overflow:hidden;
      box-shadow:0 10px 40px rgba(0,0,0,.15);
    }
    .modal-hd{
      padding:14px 14px;
      border-bottom:1px solid var(--line);
      font-weight:900;
    }
    .modal-bd{padding:14px;}
    .modal-bd p{margin:0 0 10px; color:var(--muted); font-size:13px; line-height:1.7;}
    .modal-actions{display:flex; gap:8px; padding:0 14px 14px; flex-wrap:wrap;}
    .modal-actions button{flex:1}

    /* ===== الطباعة المتناسبة تلقائيًا للجوال/الكمبيوتر ===== */
    @media print{
      body{background:#fff}
      header, .card.left, .top-actions, .no-print, .overlay{display:none !important}
      main{display:block; padding:0}
      #printArea{
        border:none !important;
        border-radius:0 !important;
        transform: scale(var(--printScale));
        transform-origin: top left;
      }
      .wrapX{overflow:visible !important;}
      .fit-table table{min-width:0 !important;}
      table{table-layout:fixed;}
      .sig-line{border-bottom:2px solid #111 !important;}
    }
  </style>

  <!-- سيتم تعديله تلقائيًا قبل الطباعة لتحديد اتجاه الصفحة -->
  <style id="printStyle">
    @page{ size: A4 landscape; margin: 10mm; }
  </style>
</head>

<body>

<div class="overlay" id="loginOverlay">
  <div class="modal">
    <div class="modal-hd">تسجيل دخول المعلمة</div>
    <div class="modal-bd">
      <p>اكتبي اسم المعلمة (يستخدم للحفظ السحابي). سيتم فتح الرابط بهذا الشكل: <b>?user=اسم_المعلمة</b></p>
      <label>اسم المعلمة</label>
      <input id="loginName" placeholder="مثال: معلمة نورة" />
      <div class="hint">كل معلمة تدخل باسمها ليصير لها سجلاتها الخاصة.</div>
    </div>
    <div class="modal-actions">
      <button class="primary" id="btnLoginGo">دخول</button>
      <button id="btnLoginClose">إغلاق (استخدام افتراضي)</button>
    </div>
  </div>
</div>

<header>
  <div class="title">
    <div class="badge">✓</div>
    <div>
      <h1>استمارات الرصد التفاعلية</h1>
      <div class="sub">سجلات متعددة + حفظ سحابي + طباعة/PDF متناسب تلقائيًا</div>
    </div>
  </div>

  <div class="top-actions no-print">
    <span class="pill" id="cloudPill"><span class="dot neu"></span> سحابي: …</span>
    <span class="pill" id="globalPill">زيارات عالمية: …</span>
    <span class="pill" id="visitPill">زيارات الجهاز: …</span>
    <span class="pill" id="userPill">مستخدم: …</span>
    <button class="btn" id="btnSwitchUser">تبديل المعلمة</button>
    <button class="btn" id="btnCloudReload">استرجاع من السحابة الآن</button>
    <button class="btn" id="btnExportJSON">تصدير بيانات (JSON)</button>
    <button class="btn" id="btnImportJSON">استيراد بيانات (JSON)</button>
    <input id="jsonFile" type="file" accept="application/json" hidden />
    <button class="danger" id="btnResetLocal">تصفير محلي فقط</button>
  </div>
</header>

<main>
  <section class="card left">
    <div class="card-hd">
      <div class="hd-title">السجلات المحفوظة</div>
      <span class="pill" id="autosavePill">حفظ تلقائي: يعمل</span>
    </div>

    <div class="card-bd">
      <div>
        <label>اختيار السجل</label>
        <select id="recordSelect"></select>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="primary" id="btnNewRecord">سجل جديد</button>
        <button id="btnDuplicateRecord">نسخ سجل</button>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="danger" id="btnDeleteRecord">حذف السجل</button>
        <button id="btnFocusTitle">تسمية السجل</button>
      </div>

      <div class="status">
        ✅ السجلات تحفظ <b>محليًا + سحابيًا</b> ويمكن الرجوع لها حتى بعد سنة.<br>
        ✅ الطباعة/PDF تتكيف تلقائيًا: الكمبيوتر (أفقي) — الجوال (طولي).
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0">

      <div>
        <label>إنشاء سجلات متعددة (كل صف/شعبة في سطر)</label>
        <textarea id="bulkRecords" placeholder="مثال:
سادس/أ
سادس/ب
خامس/أ"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="primary" id="btnCreateMany">إنشاء السجلات</button>
          <button id="btnClearMany">مسح</button>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0">

      <div class="card-hd" style="padding:0 0 10px;border:0">
        <div class="hd-title">إعدادات السجل الحالي</div>
      </div>

      <div class="row">
        <div>
          <label>نوع الاستمارة</label>
          <select id="formType">
            <option value="yearwork">سجل أعمال السنة لعام …</option>
            <option value="monthly">كشف متابعة شهري (صح/خطأ)</option>
            <option value="plans">متابعة الخطط العلاجية والإثرائية</option>
            <option value="counselor">تحويل للموجهة الطلابية</option>
            <option value="principal">تحويل للمديرة</option>
            <option value="parent">تبليغ لولي الأمر</option>
          </select>
        </div>
        <div>
          <label>المادة / العنوان</label>
          <input id="subject" placeholder="مثال: علوم - سادس" />
        </div>
      </div>

      <div class="row3" style="margin-top:10px">
        <div>
          <label>المدرسة</label>
          <input id="school" placeholder="اسم المدرسة" />
        </div>
        <div>
          <label>الصف / الشعبة</label>
          <input id="classroom" placeholder="مثال: سادس/أ" />
        </div>
        <div>
          <label>التاريخ</label>
          <input id="date" type="date" />
        </div>
      </div>

      <div class="row3" style="margin-top:10px">
        <div>
          <label>الفصل الدراسي (بالعربي)</label>
          <select id="termAr">
            <option value="الأول">الأول</option>
            <option value="الثاني">الثاني</option>
            <option value="الثالث">الثالث</option>
          </select>
        </div>
        <div>
          <label>العام الدراسي (مثل 1447 أو ١٤٤٧)</label>
          <input id="academicYearAr" class="numlike" inputmode="numeric" placeholder="مثال: 1447 أو ١٤٤٧هـ" />
          <div class="hint">لن يتم تحويل الأرقام أثناء الكتابة. التحويل عند الخروج من الخانة.</div>
        </div>
        <div>
          <label>عنوان السجل (احفظيه هنا)</label>
          <input id="recordTitle" placeholder="مثال: سجل أعمال السنة لعام ١٤٤٧هـ - علوم - سادس/أ" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>اسم المعلمة (يظهر في الطباعة)</label>
          <input id="teacherName" placeholder="مثال: أ/ بدرية الزهراني" />
        </div>
        <div>
          <label>اسم المديرة (يظهر في الطباعة)</label>
          <input id="principalName" placeholder="مثال: قائدة المدرسة/ …" />
        </div>
      </div>

      <div class="status" id="cloudStatus">
        <b>الحفظ السحابي:</b> يحفظ كل السجلات حسب المعلمة (userKey).
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0">

      <div class="card-hd" style="padding:0 0 10px;border:0">
        <div class="hd-title">أسماء الطالبات (للسجل الحالي)</div>
      </div>

      <div class="row">
        <div>
          <label>استيراد CSV (عمود أسماء)</label>
          <input id="csvFile" type="file" accept=".csv,text/csv" />
        </div>
        <div>
          <label>استيراد من صورة (ألبوم الكاميرا)</label>
          <input id="imgFile" type="file" accept="image/*" />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>أو الصقي الأسماء (كل اسم في سطر)</label>
        <textarea id="namesPaste" placeholder="سارة محمد&#10;ريم عبدالله"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="primary" id="btnApplyNames">تطبيق الأسماء</button>
          <button id="btnAddRow">إضافة طالبة</button>
        </div>
      </div>

      <div class="hint" id="namesCountHint">عدد الطالبات: 0</div>
    </div>
  </section>

  <section class="card">
    <div class="card-hd no-print">
      <div class="hd-title">معاينة الاستمارة (السجل الحالي)</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnPrint">طباعة</button>
        <button class="primary" id="btnPDF">حفظ/تصدير PDF</button>
      </div>
    </div>

    <div id="printArea"></div>
  </section>
</main>

<script>
/* ========== إعدادات قوقل شيت (Apps Script) ========== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxMZOvfhuzGY3Unz2jqyFVfSLkvN5xQKxuXyOqpUV9hkdcokD4vxjjDxjZtqkoWzvir/exec";
const APP_TOKEN = "";

/* ========== قواميس ========== */
const LEVEL_WORDS = ["متفوق","جيد","يحتاج متابعة","تحسن بتفوق","ضعيف جدا","ضعيف","جيد وبحتاج متابعة"];
const ACTION_TYPES = ["جلسة علاجية فردية","جلسة علاجية جماعية","واجب علاجي","خطة إثرائية","تعلّم تعاوني","تعليم مقلوب","أنشطة تطبيقية","تدريب إضافي","غير ذلك"];
const YEARWORK_SCHEMA = { p1A: 40, p1B: 20, p2A: 40, p2B: 20, final: 40 };
const MONTHS_AR = ["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];

const SKILLS = {
  "الأول": {
    "علوم": ["تمييز الكائنات الحية وغير الحية", "استكشاف الحواس الخمس", "السلامة في المختبر"],
    "رياضيات": ["العد حتى 100", "الجمع والطرح البسيط", "الأشكال الهندسية الأساسية"],
    "لغتي": ["قراءة كلمات وجمل قصيرة", "كتابة الحروف والكلمات", "فهم النص البسيط"],
  },
  "الثاني": {
    "علوم": ["تصنيف المواد (صلبة/سائلة/غازية)", "تغيرات المادة", "الطقس وفصول السنة"],
    "رياضيات": ["الجمع والطرح حتى 1000", "القياس بالوحدات البسيطة", "الوقت والنقود"],
    "لغتي": ["استخراج الفكرة العامة", "ترتيب أحداث النص", "قواعد لغوية بسيطة"],
  },
  "الثالث": {
    "علوم": [
      "تطبيق الطريقة العلمية ...", "معرفة مفهوم المادة", "قياس بعض صفات المادة", "تصنيف المواد", "تمييز المخلوط عن المحلول",
      "تفسير التغيرات على المادة", "تمييز الشفافة والمعتمة", "انتقال الحرارة", "مصادر الصوت", "أثر الضوء في الرؤية"
    ],
    "رياضيات": ["الجمع والطرح", "الضرب", "القسمة", "الكسور"],
    "لغتي": ["الفكرة الرئيسة", "المرادف والضد", "القواعد الأساسية"],
  },
  "الرابع": {
    "علوم": ["الأنظمة البيئية", "التكيفات", "الطاقة والتحول"],
    "رياضيات": ["الكسور", "العوامل والمضاعفات", "القياس"],
    "لغتي": ["استنتاج", "تلخيص", "علامات الترقيم"],
  },
  "الخامس": {
    "علوم": [
      "ممارسة الطريقة العلمية ...", "استنتاج أهمية أجزاء النبات", "العلاقة بين المادة والذرة", "تمييز المركبات",
      "حالات المادة وتغيراتها", "التفاعلات الكيميائية", "أنواع الطاقة", "انتقال الحرارة", "الكهرباء الساكنة"
    ],
    "رياضيات": ["العمليات على الكسور", "النسبة", "المساحة والحجم"],
    "لغتي": ["تحليل النص", "الاستنتاج", "أساليب لغوية"],
  },
  "السادس": {
    "علوم": [
      "ممارسة الطريقة العلمية ...", "المقارنة بين الخلية النباتية والحيوانية", "الصفة الموروثة والمكتسبة",
      "السائدة والمتنحية", "الأجهزة الحيوية", "السلاسل الغذائية", "تغيرات سطح الأرض", "حركة الصفائح"
    ],
    "رياضيات": ["النسبة والتناسب", "المعادلات البسيطة", "الإحصاء"],
    "لغتي": ["فهم مقروء", "البلاغة البسيطة", "الكتابة الوظيفية"],
  },
};

/* ========== أدوات ========== */
const el = (id)=>document.getElementById(id);
function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function uid(){ return "r_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }
function toArabicDigits(str){
  const map = {'0':'٠','1':'١','2':'٢','3':'٣','4':'٤','5':'٥','6':'٦','7':'٧','8':'٨','9':'٩'};
  return (str ?? "").toString().replace(/[0-9]/g, d=>map[d]);
}
function normalizeAcademicYear(input){
  const s = (input ?? "").toString().trim();
  if(!s) return "";
  let t = toArabicDigits(s).replace(/\s+/g," ");
  if(!t.includes("هـ")) t += "هـ";
  return t;
}
function parseLooseNumber(v){
  // يسمح بكتابة عربي/إنجليزي + نقط
  const s = (v ?? "").toString().trim()
    .replace(/[٠١٢٣٤٥٦٧٨٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d))
    .replace(/[^\d.]/g,"");
  if(s === "" || s === ".") return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}
function clampNumber(v, max){
  const n = parseLooseNumber(v);
  if(n === null) return "";
  const c = Math.max(0, Math.min(max, n));
  // لا نحول لثابت، نرجعه كما رقم (لكن كتابيًا)
  return String(c);
}
function isMobileLike(){
  return window.matchMedia("(max-width: 820px)").matches;
}

/* ========== المستخدم/المفتاح ========== */
function getUserKey(){
  const params = new URLSearchParams(location.search);
  const u = (params.get("user") || "").trim();
  return u ? u : "default";
}
let USER_KEY = getUserKey();
let STORAGE_KEY = "irs_records_v4_" + USER_KEY;

/* ========== حالة التطبيق ========== */
const state = { version: 4, userKey: USER_KEY, records: [], activeId: null };

function defaultStudent(name=""){
  return {
    id: uid(),
    name,
    // درجات أعمال السنة
    yearwork: { p1A:"", p1B:"", p2A:"", p2B:"", final:"" },
    // شهري: 12 شهر، كل شهر: 0 فارغ، 1 صح، -1 خطأ
    monthly: Array.from({length:12}, ()=>0),
  };
}

function defaultRecord(overrides={}){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const date = `${yyyy}-${mm}-${dd}`;

  return {
    id: uid(),
    title: overrides.title || "سجل جديد",
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    formType: overrides.formType || "yearwork",
    subject: overrides.subject || "",
    school: overrides.school || "",
    classroom: overrides.classroom || "",
    date: overrides.date || date,
    termAr: overrides.termAr || "الأول",
    academicYearAr: overrides.academicYearAr || "١٤٤٦هـ",
    signatures: { teacherName: overrides.teacherName || "", principalName: overrides.principalName || "" },
    students: overrides.students || [],
    plans: { entries: [] },
    referral: { studentName:"", receiver:"", reason:"", details:"", suggestedActions:"", notes:"" },
    parent: { studentName:"", parentName:"", parentPhone:"", message:"", notes:"" }
  };
}
function getActiveRecord(){
  if(!state.activeId && state.records.length) state.activeId = state.records[0].id;
  return state.records.find(r=>r.id===state.activeId) || null;
}
function touchRecord(rec){ rec.updatedAt = new Date().toISOString(); }

/* ========== حفظ محلي/سحابي ========== */
function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return false;
  try{
    const parsed = JSON.parse(raw);
    if(parsed && parsed.records) Object.assign(state, parsed);
    return true;
  }catch(e){ return false; }
}

let saveTimer = null;
function setCloudPill(status, ok=null){
  const pill = el("cloudPill");
  let cls = "dot neu";
  if(ok === true) cls = "dot ok";
  if(ok === false) cls = "dot bad";
  pill.innerHTML = `<span class="${cls}"></span> سحابي: ${escapeHtml(status)}`;
}
async function fetchWithTimeout(url, opts={}, timeoutMs=15000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{ return await fetch(url, {...opts, signal: ctrl.signal}); }
  finally{ clearTimeout(t); }
}
async function cloudLoad(){
  try{
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("action","load");
    url.searchParams.set("userKey", USER_KEY);
    url.searchParams.set("token", APP_TOKEN);

    const res = await fetchWithTimeout(url.toString(), {method:"GET"});
    const data = await res.json();

    if(data.ok && data.found && data.state){
      Object.assign(state, data.state);
      state.userKey = USER_KEY;
      if(!state.records) state.records = [];
      if(!state.activeId) state.activeId = state.records[0]?.id || null;

      setCloudPill("متصل ✓ (تم التحميل)", true);
      saveLocal();
      syncUI();
      render();
    }else if(data.ok){
      setCloudPill("متصل ✓ (لا يوجد بيانات بعد)", true);
    }else{
      setCloudPill("مشكلة صلاحية/توكن", false);
    }
  }catch(e){
    setCloudPill("غير متصل (محليًا)", false);
  }
}
function cloudSaveDebounced(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>cloudSave(), 900);
}
async function cloudSave(){
  try{
    const payload = { action:"save", token: APP_TOKEN, userKey: USER_KEY, state };
    const res = await fetchWithTimeout(SCRIPT_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.ok) setCloudPill("متصل ✓ (تم الحفظ)", true);
    else setCloudPill("رفض/توكن غير صحيح", false);
  }catch(e){
    setCloudPill("انقطاع (تم الحفظ محليًا)", false);
  }
}
async function cloudVisit(){
  try{
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("action","visit");
    url.searchParams.set("userKey", USER_KEY);
    url.searchParams.set("token", APP_TOKEN);
    const res = await fetchWithTimeout(url.toString(), {method:"GET"});
    const data = await res.json();
    el("globalPill").textContent = "زيارات عالمية: " + (data.globalVisits ?? "—");
  }catch(e){
    el("globalPill").textContent = "زيارات عالمية: —";
  }
}
function saveAll(){ saveLocal(); cloudSaveDebounced(); }

/* ========== زيارات محلية ========== */
function bumpLocalVisits(){
  const vk = "irs_visits_" + USER_KEY;
  const v = parseInt(localStorage.getItem(vk) || "0", 10) + 1;
  localStorage.setItem(vk, String(v));
  el("visitPill").textContent = "زيارات الجهاز: " + v;
}
function showUser(){ el("userPill").textContent = "مستخدم: " + USER_KEY; }

/* ========== عناوين ========== */
function buildRecordTitle(rec){
  const typeLabel =
    rec.formType === "yearwork" ? "سجل أعمال السنة" :
    rec.formType === "monthly" ? "كشف متابعة شهري" :
    rec.formType === "plans" ? "خطط علاجية/إثرائية" :
    rec.formType === "counselor" ? "تحويل للموجهة" :
    rec.formType === "principal" ? "تحويل للمديرة" :
    rec.formType === "parent" ? "تبليغ ولي الأمر" : "سجل";
  const parts = [];
  parts.push(typeLabel);
  if(rec.academicYearAr) parts.push(rec.academicYearAr);
  if(rec.subject) parts.push(rec.subject);
  if(rec.classroom) parts.push(rec.classroom);
  return parts.join(" - ");
}
function getFormTitle(rec){
  switch(rec.formType){
    case "yearwork": return `سجل أعمال السنة لعام ${rec.academicYearAr || "…"}`;
    case "monthly": return "كشف متابعة شهري";
    case "plans": return "متابعة الخطط العلاجية والإثرائية";
    case "counselor": return "نموذج تحويل للموجهة الطلابية";
    case "principal": return "نموذج تحويل للمديرة";
    case "parent": return "تبليغ لولي الأمر";
    default: return "استمارة";
  }
}

/* ========== UI Sync ========== */
function refreshRecordSelect(){
  const sel = el("recordSelect");
  sel.innerHTML = "";
  state.records.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.id;
    opt.textContent = (r.title && r.title.trim()) ? r.title.trim() : buildRecordTitle(r);
    if(r.id === state.activeId) opt.selected = true;
    sel.appendChild(opt);
  });
}
function syncUI(){
  refreshRecordSelect();
  const rec = getActiveRecord();
  if(!rec){
    el("namesCountHint").textContent = "عدد الطالبات: 0";
    return;
  }
  el("formType").value = rec.formType;
  el("subject").value = rec.subject || "";
  el("school").value = rec.school || "";
  el("classroom").value = rec.classroom || "";
  el("date").value = rec.date || "";
  el("termAr").value = rec.termAr || "الأول";
  el("academicYearAr").value = rec.academicYearAr || "";
  el("recordTitle").value = rec.title || "";
  el("teacherName").value = rec.signatures?.teacherName || "";
  el("principalName").value = rec.signatures?.principalName || "";
  el("namesCountHint").textContent = "عدد الطالبات: " + (rec.students?.length || 0);
}

/* ========== Render ========== */
function makeFooter(text){
  const f = document.createElement("div");
  f.className = "footer-note";
  f.innerHTML = `<div>${escapeHtml(text)}</div>`;
  return f;
}
function makeSignatures(rec){
  const s = document.createElement("div");
  s.className = "signatures";
  s.innerHTML = `
    <div class="sig-box">
      <b>المعلمة:</b>
      <input class="sig-line" data-sig="teacherName" value="${escapeHtml(rec.signatures?.teacherName || "")}" placeholder="اكتبي اسم المعلمة هنا">
    </div>
    <div class="sig-box">
      <b>قائدة المدرسة:</b>
      <input class="sig-line" data-sig="principalName" value="${escapeHtml(rec.signatures?.principalName || "")}" placeholder="اكتبي اسم المديرة هنا">
    </div>
  `;
  return s;
}

function render(){
  const area = el("printArea");
  area.innerHTML = "";
  const rec = getActiveRecord();
  if(!rec){
    area.innerHTML = `<div style="padding:16px;color:var(--muted);font-weight:900">لا يوجد سجلات بعد. اضغطي “سجل جديد”.</div>`;
    return;
  }

  const header = document.createElement("div");
  header.className = "form-header";
  header.innerHTML = `
    <div>
      <h2>${escapeHtml(getFormTitle(rec))}</h2>
      <div class="sub" style="margin-top:4px;color:var(--muted)">
        ${rec.subject ? "العنوان/المادة: " + escapeHtml(rec.subject) : ""}
      </div>
      <div class="sub" style="margin-top:4px;color:var(--muted)">
        العام الدراسي: <b>${escapeHtml(rec.academicYearAr || "—")}</b> — الفصل: <b>${escapeHtml(rec.termAr || "—")}</b>
      </div>
    </div>
    <div class="meta">
      <div class="kv">المدرسة: ${escapeHtml(rec.school || "—")}</div>
      <div class="kv">الصف/الشعبة: ${escapeHtml(rec.classroom || "—")}</div>
      <div class="kv">التاريخ: ${escapeHtml(rec.date || "—")}</div>
      <div class="kv">السجل: ${escapeHtml((rec.title||"").trim() || buildRecordTitle(rec))}</div>
    </div>
  `;
  area.appendChild(header);

  if(rec.formType === "yearwork"){
    area.appendChild(renderYearwork(rec));
    area.appendChild(makeFooter("ملاحظة: يمكنك تعميم درجة عمود كامل (مثلاً 5) بضغطة واحدة."));
  } else if(rec.formType === "monthly"){
    area.appendChild(renderMonthly(rec));
    area.appendChild(makeFooter("التقييم الشهري: اضغطي داخل أي مربع للتبديل بين (✓) و (✗) و (فارغ)."));
  } else if(rec.formType === "plans"){
    area.appendChild(renderPlans(rec));
    area.appendChild(makeFooter("الخطط العلاجية/الإثرائية: تشمل اسم الطالبة (منسدل + إدخال يدوي) + مهارات حسب الصف والمادة."));
  } else if(rec.formType === "counselor"){
    area.appendChild(renderReferral(rec, "الموجهة الطلابية"));
  } else if(rec.formType === "principal"){
    area.appendChild(renderReferral(rec, "قائدة المدرسة"));
  } else if(rec.formType === "parent"){
    area.appendChild(renderParent(rec));
  }

  area.appendChild(makeSignatures(rec));
  wireDynamicInputs(rec);
}

/* ========== 1) سجل أعمال السنة (تفاعلي + تعميم عمود) ========== */
function yearworkRowTotals(st){
  const p1A = parseLooseNumber(st.yearwork.p1A) ?? 0;
  const p1B = parseLooseNumber(st.yearwork.p1B) ?? 0;
  const p2A = parseLooseNumber(st.yearwork.p2A) ?? 0;
  const p2B = parseLooseNumber(st.yearwork.p2B) ?? 0;
  const fin = parseLooseNumber(st.yearwork.final) ?? 0;
  const sum = p1A + p1B + p2A + p2B;
  const avg = sum / 2; // متوسط الفصلين (إذا رغبتِ)
  const total = sum + fin;
  return {sum, avg, total};
}

function renderYearwork(rec){
  if(!rec.students) rec.students = [];
  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  const controls = document.createElement("div");
  controls.className = "no-print";
  controls.style.border = "1px solid var(--line)";
  controls.style.borderRadius = "12px";
  controls.style.padding = "10px";
  controls.style.marginBottom = "10px";
  controls.innerHTML = `
    <div class="row3">
      <div>
        <label>تعميم درجة المشاركة (حدها ${YEARWORK_SCHEMA.p1A})</label>
        <input class="inline-input num" inputmode="decimal" data-bulk="p1A" placeholder="مثال: 5">
        <button class="primary" data-apply="p1A" style="margin-top:6px;width:100%">تطبيق على جميع الطالبات</button>
      </div>
      <div>
        <label>تعميم درجة الواجبات (حدها ${YEARWORK_SCHEMA.p1B})</label>
        <input class="inline-input num" inputmode="decimal" data-bulk="p1B" placeholder="مثال: 10">
        <button class="primary" data-apply="p1B" style="margin-top:6px;width:100%">تطبيق على جميع الطالبات</button>
      </div>
      <div>
        <label>تعميم درجة النهائي (حدها ${YEARWORK_SCHEMA.final})</label>
        <input class="inline-input num" inputmode="decimal" data-bulk="final" placeholder="مثال: 35">
        <button class="primary" data-apply="final" style="margin-top:6px;width:100%">تطبيق على جميع الطالبات</button>
      </div>
    </div>
    <div class="hint">يمكنك أيضًا إدخال أي درجة مباشرة داخل الجدول (بدون أسهم).</div>
  `;
  wrap.appendChild(controls);

  const box = document.createElement("div");
  box.className = "wrapX fit-table";
  const table = document.createElement("table");
  table.innerHTML = `
    <thead>
      <tr>
        <th class="total" style="width:40px">م</th>
        <th class="total" style="width:240px">اسم الطالبة</th>
        <th class="p1">المشاركة (${YEARWORK_SCHEMA.p1A})</th>
        <th class="p1">الواجبات (${YEARWORK_SCHEMA.p1B})</th>
        <th class="p2">المهام الأدائية (${YEARWORK_SCHEMA.p2A})</th>
        <th class="p2">أنشطة صفية (${YEARWORK_SCHEMA.p2B})</th>
        <th class="sum">مجموع أعمال السنة</th>
        <th class="avg">المتوسط</th>
        <th class="final">الاختبار النهائي (${YEARWORK_SCHEMA.final})</th>
        <th class="total">المجموع الكلي</th>
      </tr>
    </thead>
    <tbody id="ywBody"></tbody>
  `;
  box.appendChild(table);
  wrap.appendChild(box);

  const body = table.querySelector("#ywBody");
  rec.students.forEach((st, idx)=>{
    const t = yearworkRowTotals(st);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="total">${idx+1}</td>
      <td class="namecell">
        <input class="inline-input name" data-st="name" data-idx="${idx}" value="${escapeHtml(st.name||"")}" placeholder="اسم الطالبة">
      </td>
      <td class="p1"><input class="inline-input num" inputmode="decimal" data-yw="p1A" data-idx="${idx}" value="${escapeHtml(st.yearwork.p1A)}" placeholder="0-${YEARWORK_SCHEMA.p1A}"></td>
      <td class="p1"><input class="inline-input num" inputmode="decimal" data-yw="p1B" data-idx="${idx}" value="${escapeHtml(st.yearwork.p1B)}" placeholder="0-${YEARWORK_SCHEMA.p1B}"></td>
      <td class="p2"><input class="inline-input num" inputmode="decimal" data-yw="p2A" data-idx="${idx}" value="${escapeHtml(st.yearwork.p2A)}" placeholder="0-${YEARWORK_SCHEMA.p2A}"></td>
      <td class="p2"><input class="inline-input num" inputmode="decimal" data-yw="p2B" data-idx="${idx}" value="${escapeHtml(st.yearwork.p2B)}" placeholder="0-${YEARWORK_SCHEMA.p2B}"></td>
      <td class="sum"><b>${t.sum.toFixed(0)}</b></td>
      <td class="avg"><b>${t.avg.toFixed(1)}</b></td>
      <td class="final"><input class="inline-input num" inputmode="decimal" data-yw="final" data-idx="${idx}" value="${escapeHtml(st.yearwork.final)}" placeholder="0-${YEARWORK_SCHEMA.final}"></td>
      <td class="total"><b>${t.total.toFixed(0)}</b></td>
    `;
    body.appendChild(tr);
  });

  // تعميم العمود
  setTimeout(()=>{
    controls.querySelectorAll("[data-apply]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const key = btn.getAttribute("data-apply");
        const inp = controls.querySelector(`[data-bulk="${key}"]`);
        const max = YEARWORK_SCHEMA[key];
        const v = clampNumber(inp.value, max);
        rec.students.forEach(st=> st.yearwork[key] = v);
        touchRecord(rec); saveAll(); render();
      });
    });
  },0);

  return wrap;
}

/* ========== 2) كشف متابعة شهري (صح/خطأ داخل كل مربع) ========== */
function toggleMonthlyCell(rec, idx, m){
  const st = rec.students[idx];
  if(!st) return;
  const cur = st.monthly[m] ?? 0;
  // 0 -> 1 -> -1 -> 0
  const next = cur === 0 ? 1 : (cur === 1 ? -1 : 0);
  st.monthly[m] = next;
  touchRecord(rec); saveAll(); render();
}
function renderMonthly(rec){
  if(!rec.students) rec.students = [];
  // ضمان بنية monthly
  rec.students.forEach(st=>{
    if(!Array.isArray(st.monthly) || st.monthly.length !== 12){
      st.monthly = Array.from({length:12}, ()=>0);
    }
  });

  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  const box = document.createElement("div");
  box.className = "wrapX fit-table";
  const table = document.createElement("table");
  table.innerHTML = `
    <thead>
      <tr>
        <th class="total" style="width:40px">م</th>
        <th class="total" style="width:240px">اسم الطالبة</th>
        ${MONTHS_AR.map(m=>`<th class="total">${m}</th>`).join("")}
      </tr>
    </thead>
    <tbody id="moBody"></tbody>
  `;
  box.appendChild(table);
  wrap.appendChild(box);

  const body = table.querySelector("#moBody");
  rec.students.forEach((st, idx)=>{
    const tr = document.createElement("tr");
    const cells = st.monthly.map((v, m)=>{
      const cls = v===1 ? "mark-btn ok" : (v===-1 ? "mark-btn bad" : "mark-btn neu");
      const txt = v===1 ? "✓" : (v===-1 ? "✗" : "");
      return `
        <td>
          <button class="${cls}" data-mo="${m}" data-idx="${idx}" title="اضغط للتبديل">${txt}</button>
        </td>
      `;
    }).join("");
    tr.innerHTML = `
      <td class="total">${idx+1}</td>
      <td class="namecell">
        <input class="inline-input name" data-st="name" data-idx="${idx}" value="${escapeHtml(st.name||"")}" placeholder="اسم الطالبة">
      </td>
      ${cells}
    `;
    body.appendChild(tr);
  });

  return wrap;
}

/* ========== 3) الخطط العلاجية/الإثرائية مع اسم الطالبة ========== */
function getStudentOptions(rec, current){
  const list = (rec.students || []).map(s=> (s.name||"").trim()).filter(Boolean);
  const uniq = Array.from(new Set(list));
  const opts = [`<option value="" ${!current?"selected":""}>— اختر الطالبة —</option>`]
    .concat(uniq.map(n=>`<option value="${escapeHtml(n)}" ${current===n?"selected":""}>${escapeHtml(n)}</option>`).join(""))
    .concat(current && !uniq.includes(current) ? [`<option value="${escapeHtml(current)}" selected>${escapeHtml(current)}</option>`] : []);
  return opts.join("");
}
function getSkillOptions(grade, subject, current){
  const g = grade || "السادس";
  const s = subject || "علوم";
  const list = (SKILLS[g] && SKILLS[g][s]) ? SKILLS[g][s] : ["أضيفي مهاراتك هنا"];
  const opts = [`<option value="" ${!current?"selected":""}>— اختر المهارة —</option>`]
    .concat(list.map(x=>`<option value="${escapeHtml(x)}" ${current===x?"selected":""}>${escapeHtml(x)}</option>`).join(""))
    .concat(current && !list.includes(current) ? [`<option value="${escapeHtml(current)}" selected>${escapeHtml(current)}</option>`] : []);
  return opts.join("");
}
function renderPlans(rec){
  const wrap = document.createElement("div");
  wrap.style.padding = "12px";
  rec.plans = rec.plans || { entries: [] };

  const controls = document.createElement("div");
  controls.className = "no-print";
  controls.style.border = "1px solid var(--line)";
  controls.style.borderRadius = "12px";
  controls.style.padding = "10px";
  controls.style.marginBottom = "10px";
  controls.innerHTML = `
    <div class="row3">
      <button class="primary" id="btnAddPlanRow">إضافة خطة جديدة</button>
      <button class="danger" id="btnClearPlans">مسح كل الخطط في هذا السجل</button>
      <button id="btnSyncStudentNames">تحديث قائمة الطالبات</button>
    </div>
  `;
  wrap.appendChild(controls);

  const box = document.createElement("div");
  box.className = "wrapX fit-table";
  const table = document.createElement("table");
  table.innerHTML = `
    <thead>
      <tr>
        <th class="total" style="width:40px">م</th>
        <th class="total" style="width:110px">التاريخ</th>
        <th class="total" style="width:220px">اسم الطالبة</th>
        <th class="total" style="width:90px">الصف</th>
        <th class="total" style="width:120px">المادة</th>
        <th class="total" style="width:90px">نوع الخطة</th>
        <th class="total" style="width:240px">المهارة</th>
        <th class="total" style="width:120px">القبلي</th>
        <th class="total" style="width:120px">البعدي</th>
        <th class="total" style="width:160px">نوع الإجراء</th>
        <th class="total" style="width:220px">ملاحظات</th>
        <th class="total" style="width:70px">حذف</th>
      </tr>
    </thead>
    <tbody id="plansBody"></tbody>
  `;
  box.appendChild(table);
  wrap.appendChild(box);

  const body = table.querySelector("#plansBody");
  const entries = rec.plans.entries || [];
  const gradeOpts = ["الأول","الثاني","الثالث","الرابع","الخامس","السادس"];
  const subjectOpts = ["علوم","رياضيات","لغتي","دراسات","انجليزي","مهارات رقمية","أخرى"];

  entries.forEach((row, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="total">${idx+1}</td>
      <td><input class="inline-input" data-plan="date" data-idx="${idx}" type="date" value="${escapeHtml(row.date||"")}"></td>

      <td>
        <select class="inline-input" data-plan="studentName" data-idx="${idx}">
          ${getStudentOptions(rec, row.studentName)}
        </select>
        <div class="no-print" style="margin-top:6px">
          <input class="inline-input" data-plan="student_custom" data-idx="${idx}" placeholder="أو اكتبي اسم الطالبة ثم Enter">
        </div>
      </td>

      <td>
        <select class="inline-input" data-plan="grade" data-idx="${idx}">
          ${gradeOpts.map(g=>`<option value="${g}" ${row.grade===g?"selected":""}>${g}</option>`).join("")}
        </select>
      </td>

      <td>
        <select class="inline-input" data-plan="subject" data-idx="${idx}">
          ${subjectOpts.map(s=>`<option value="${s}" ${row.subject===s?"selected":""}>${s}</option>`).join("")}
        </select>
      </td>

      <td>
        <select class="inline-input" data-plan="type" data-idx="${idx}">
          <option value="علاجية" ${row.type==="علاجية"?"selected":""}>علاجية</option>
          <option value="إثرائية" ${row.type==="إثرائية"?"selected":""}>إثرائية</option>
        </select>
      </td>

      <td>
        <select class="inline-input" data-plan="skill" data-idx="${idx}">
          ${getSkillOptions(row.grade, row.subject, row.skill)}
        </select>
        <div class="no-print" style="margin-top:6px">
          <input class="inline-input" data-plan="skill_custom" data-idx="${idx}" placeholder="أو اكتبي مهارة جديدة ثم Enter">
        </div>
      </td>

      <td>
        <select class="inline-input" data-plan="pre" data-idx="${idx}">
          ${LEVEL_WORDS.map(x=>`<option value="${x}" ${row.pre===x?"selected":""}>${x}</option>`).join("")}
        </select>
      </td>

      <td>
        <select class="inline-input" data-plan="post" data-idx="${idx}">
          ${LEVEL_WORDS.map(x=>`<option value="${x}" ${row.post===x?"selected":""}>${x}</option>`).join("")}
        </select>
      </td>

      <td>
        <select class="inline-input" data-plan="action" data-idx="${idx}">
          ${ACTION_TYPES.map(x=>`<option value="${x}" ${row.action===x?"selected":""}>${x}</option>`).join("")}
        </select>
      </td>

      <td><input class="inline-input" data-plan="notes" data-idx="${idx}" value="${escapeHtml(row.notes||"")}" placeholder="ملاحظات"></td>
      <td class="total"><button class="danger no-print" data-plan="del" data-idx="${idx}">حذف</button></td>
    `;
    body.appendChild(tr);
  });

  setTimeout(()=>{
    const addRow = ()=>{
      rec.plans.entries.push({
        date: rec.date || "",
        studentName: "",
        grade: "السادس",
        subject: "علوم",
        type: "علاجية",
        skill: "",
        pre: LEVEL_WORDS[1],
        post: LEVEL_WORDS[1],
        action: ACTION_TYPES[0],
        notes: ""
      });
      touchRecord(rec); saveAll(); render();
    };
    document.getElementById("btnAddPlanRow")?.addEventListener("click", addRow);
    document.getElementById("btnClearPlans")?.addEventListener("click", ()=>{
      if(!confirm("تأكيد مسح كل الخطط في هذا السجل؟")) return;
      rec.plans.entries = [];
      touchRecord(rec); saveAll(); render();
    });
    document.getElementById("btnSyncStudentNames")?.addEventListener("click", ()=> render());
  },0);

  return wrap;
}

/* ========== 4) تحويل للموجهة/المديرة ========== */
function renderReferral(rec, receiverLabel){
  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  const r = rec.referral || (rec.referral = { studentName:"", receiver:"", reason:"", details:"", suggestedActions:"", notes:"" });
  if(!r.receiver) r.receiver = receiverLabel;

  wrap.innerHTML = `
    <div style="padding:12px">
      <div class="row">
        <div>
          <label>اسم الطالبة</label>
          <input class="inline-input name" data-ref="studentName" value="${escapeHtml(r.studentName||"")}" placeholder="اسم الطالبة">
        </div>
        <div>
          <label>جهة التحويل</label>
          <input class="inline-input" data-ref="receiver" value="${escapeHtml(r.receiver||receiverLabel)}" placeholder="${receiverLabel}">
        </div>
      </div>

      <div style="margin-top:10px">
        <label>سبب التحويل</label>
        <textarea data-ref="reason" class="inline-input" style="min-height:80px;text-align:right">${escapeHtml(r.reason||"")}</textarea>
      </div>

      <div style="margin-top:10px">
        <label>تفاصيل الحالة</label>
        <textarea data-ref="details" class="inline-input" style="min-height:110px;text-align:right">${escapeHtml(r.details||"")}</textarea>
      </div>

      <div style="margin-top:10px">
        <label>إجراءات مقترحة</label>
        <textarea data-ref="suggestedActions" class="inline-input" style="min-height:90px;text-align:right">${escapeHtml(r.suggestedActions||"")}</textarea>
      </div>

      <div style="margin-top:10px">
        <label>ملاحظات</label>
        <textarea data-ref="notes" class="inline-input" style="min-height:70px;text-align:right">${escapeHtml(r.notes||"")}</textarea>
      </div>
    </div>
  `;
  return wrap;
}

/* ========== 5) تبليغ ولي الأمر ========== */
function renderParent(rec){
  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  const p = rec.parent || (rec.parent = { studentName:"", parentName:"", parentPhone:"", message:"", notes:"" });

  wrap.innerHTML = `
    <div style="padding:12px">
      <div class="row3">
        <div>
          <label>اسم الطالبة</label>
          <input class="inline-input name" data-par="studentName" value="${escapeHtml(p.studentName||"")}" placeholder="اسم الطالبة">
        </div>
        <div>
          <label>اسم ولي الأمر</label>
          <input class="inline-input" data-par="parentName" value="${escapeHtml(p.parentName||"")}" placeholder="اسم ولي الأمر">
        </div>
        <div>
          <label>رقم الجوال</label>
          <input class="inline-input num" inputmode="numeric" data-par="parentPhone" value="${escapeHtml(p.parentPhone||"")}" placeholder="05xxxxxxxx">
        </div>
      </div>

      <div style="margin-top:10px">
        <label>نص التبليغ</label>
        <textarea data-par="message" class="inline-input" style="min-height:120px;text-align:right" placeholder="اكتبي رسالة التبليغ...">${escapeHtml(p.message||"")}</textarea>
      </div>

      <div style="margin-top:10px">
        <label>ملاحظات</label>
        <textarea data-par="notes" class="inline-input" style="min-height:70px;text-align:right">${escapeHtml(p.notes||"")}</textarea>
      </div>
    </div>
  `;
  return wrap;
}

/* ========== Wiring Inputs ========== */
function wireDynamicInputs(rec){
  // signatures
  document.querySelectorAll("#printArea [data-sig]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const key = inp.dataset.sig;
      rec.signatures = rec.signatures || {};
      rec.signatures[key] = inp.value;
      touchRecord(rec); saveAll(); syncUI();
    });
  });

  // student name edits
  document.querySelectorAll("#printArea [data-st='name']").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const idx = Number(inp.dataset.idx);
      if(!rec.students[idx]) return;
      rec.students[idx].name = inp.value;
      touchRecord(rec); saveAll(); syncUI();
    });
  });

  // yearwork inputs (validate on blur to avoid cutting numbers أثناء الكتابة)
  document.querySelectorAll("#printArea [data-yw]").forEach(inp=>{
    const idx = Number(inp.dataset.idx);
    const key = inp.dataset.yw;
    const max = YEARWORK_SCHEMA[key];

    inp.addEventListener("input", ()=>{
      // حفظ كما هو أثناء الكتابة
      if(!rec.students[idx]) return;
      rec.students[idx].yearwork[key] = inp.value;
      touchRecord(rec); saveAll();
    });
    inp.addEventListener("blur", ()=>{
      if(!rec.students[idx]) return;
      const cleaned = clampNumber(inp.value, max);
      rec.students[idx].yearwork[key] = cleaned;
      inp.value = cleaned;
      touchRecord(rec); saveAll(); render();
    });
  });

  // monthly toggles
  document.querySelectorAll("#printArea [data-mo]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx = Number(btn.dataset.idx);
      const m = Number(btn.dataset.mo);
      toggleMonthlyCell(rec, idx, m);
    });
  });

  // plans (delegation)
  document.querySelectorAll("#printArea [data-plan]").forEach(inp=>{
    const idx = Number(inp.dataset.idx);
    const key = inp.dataset.plan;

    if(key === "del"){
      inp.addEventListener("click", ()=>{
        rec.plans.entries.splice(idx,1);
        touchRecord(rec); saveAll(); render();
      });
      return;
    }

    if(key === "skill_custom"){
      inp.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          const row = rec.plans?.entries?.[idx]; if(!row) return;
          const val = (inp.value||"").trim(); if(!val) return;
          row.skill = val;
          inp.value = "";
          touchRecord(rec); saveAll(); render();
        }
      });
      return;
    }

    if(key === "student_custom"){
      inp.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          const row = rec.plans?.entries?.[idx]; if(!row) return;
          const val = (inp.value||"").trim(); if(!val) return;
          row.studentName = val;
          inp.value = "";
          touchRecord(rec); saveAll(); render();
        }
      });
      return;
    }

    inp.addEventListener("input", ()=>{
      const row = rec.plans?.entries?.[idx]; if(!row) return;
      row[key] = (inp.value ?? "").toString();
      touchRecord(rec); saveAll();
    });

    inp.addEventListener("change", ()=>{
      const row = rec.plans?.entries?.[idx]; if(!row) return;
      row[key] = (inp.value ?? "").toString();
      touchRecord(rec); saveAll();
      if(key==="grade" || key==="subject") render();
    });
  });

  // referral
  document.querySelectorAll("#printArea [data-ref]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const k = inp.dataset.ref;
      rec.referral = rec.referral || {};
      rec.referral[k] = inp.value;
      touchRecord(rec); saveAll();
    });
  });

  // parent
  document.querySelectorAll("#printArea [data-par]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const k = inp.dataset.par;
      rec.parent = rec.parent || {};
      rec.parent[k] = inp.value;
      touchRecord(rec); saveAll();
    });
  });
}

/* ========== أسماء الطالبات: CSV + لصق + OCR ========== */
function parseCSV(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  // نتوقع أن أول عمود هو الاسم
  return lines.map(l=> l.split(",")[0].trim()).filter(Boolean);
}
function applyNamesToRecord(rec, names){
  const clean = names.map(s=>s.trim()).filter(Boolean);
  rec.students = clean.map(n=> defaultStudent(n));
  touchRecord(rec); saveAll(); syncUI(); render();
}
async function ocrNamesFromImage(file){
  const { createWorker } = Tesseract;
  const worker = await createWorker("ara");
  try{
    const imgUrl = URL.createObjectURL(file);
    const { data } = await worker.recognize(imgUrl);
    URL.revokeObjectURL(imgUrl);
    const text = (data.text || "").trim();
    // استخراج أسماء على شكل أسطر
    const names = text.split(/\r?\n/).map(x=>x.trim()).filter(x=>x.length >= 2);
    return names;
  } finally {
    await worker.terminate();
  }
}

/* ========== الطباعة/PDF المتناسبة للجوال/الكمبيوتر ========== */
function setPrintMode(){
  const mobile = isMobileLike();
  // اتجاه الصفحة + مقياس (إذا كانت الصفحة طويلة/عريضة)
  const printStyle = document.getElementById("printStyle");
  if(mobile){
    printStyle.textContent = "@page{ size: A4 portrait; margin: 10mm; }";
    document.documentElement.style.setProperty("--printScale", "1");
  } else {
    printStyle.textContent = "@page{ size: A4 landscape; margin: 10mm; }";
    document.documentElement.style.setProperty("--printScale", "1");
  }
}
function doPrint(){
  setPrintMode();
  window.print();
}

async function exportPDF(){
  const btn = el("btnPDF");
  btn.disabled = true;
  btn.textContent = "جاري تجهيز PDF…";
  try{
    setPrintMode();
    const rec = getActiveRecord();
    const area = el("printArea");

    // جودة أعلى للجوال
    const scale = isMobileLike() ? 2.2 : 2;

    const canvas = await html2canvas(area, {
      scale,
      useCORS: true,
      backgroundColor:"#ffffff",
      windowWidth: area.scrollWidth,
      windowHeight: area.scrollHeight
    });

    const imgData = canvas.toDataURL("image/png");
    const { jsPDF } = window.jspdf;
    const portrait = isMobileLike();
    const pdf = new jsPDF({ orientation: portrait ? "portrait" : "landscape", unit:"mm", format:"a4" });

    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();

    // حساب الأبعاد مع تعدد الصفحات (قص طولي)
    const imgW = pageW;
    const imgH = (canvas.height * imgW) / canvas.width;

    let y = 0;
    let remaining = imgH;

    // نرسم الصورة على عدة صفحات إذا كانت أطول من الصفحة
    while(remaining > 0){
      pdf.addImage(imgData, "PNG", 0, y, imgW, imgH);
      remaining -= pageH;
      if(remaining > 0){
        pdf.addPage();
        y -= pageH; // نرفع الصورة لأعلى بمقدار صفحة
      }
    }

    const safeTitle = ((rec.title||"سجل").trim() || "سجل").replace(/[\\/:*?"<>|]/g,"-");
    const filename = safeTitle + ".pdf";
    const blob = pdf.output("blob");
    const file = new File([blob], filename, {type:"application/pdf"});

    if(navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
      await navigator.share({ files:[file], title: filename });
    } else {
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank");
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 8000);
    }
  } finally {
    btn.disabled = false;
    btn.textContent = "حفظ/تصدير PDF";
  }
}

/* ========== سجلات ========== */
function addRecord(rec){ state.records.push(rec); state.activeId = rec.id; }
function ensureAtLeastOneRecord(){
  if(state.records.length === 0){
    const r = defaultRecord({title:"سجل أول", formType:"yearwork"});
    addRecord(r);
  }
}

/* ========== Login overlay ========== */
function showLoginOverlay(force=false){
  const overlay = el("loginOverlay");
  if(force) overlay.classList.add("show");
  else overlay.classList.toggle("show");
}
function redirectToUser(name){
  const u = (name||"").trim();
  const params = new URLSearchParams(location.search);
  if(u) params.set("user", u);
  else params.delete("user");
  location.search = params.toString();
}

/* ========== Events ========== */
function attachTopEvents(){
  el("recordSelect").addEventListener("change", (e)=>{
    state.activeId = e.target.value;
    saveLocal(); syncUI(); render();
  });

  el("btnNewRecord").addEventListener("click", ()=>{
    const base = getActiveRecord();
    const r = defaultRecord({
      school: base?.school || "",
      termAr: base?.termAr || "الأول",
      academicYearAr: base?.academicYearAr || "١٤٤٦هـ",
      teacherName: base?.signatures?.teacherName || "",
      principalName: base?.signatures?.principalName || "",
      formType: base?.formType || "yearwork"
    });
    r.title = "سجل جديد (اكتبي الاسم هنا)";
    addRecord(r);
    saveAll(); syncUI(); render();
    setTimeout(()=>{ el("recordTitle").focus(); el("recordTitle").select(); }, 60);
  });

  el("btnDuplicateRecord").addEventListener("click", ()=>{
    const rec = getActiveRecord();
    if(!rec) return;
    const clone = JSON.parse(JSON.stringify(rec));
    clone.id = uid();
    clone.title = ((rec.title||"سجل") + " (نسخة)");
    clone.createdAt = new Date().toISOString();
    clone.updatedAt = new Date().toISOString();
    addRecord(clone);
    saveAll(); syncUI(); render();
  });

  el("btnDeleteRecord").addEventListener("click", ()=>{
    const rec = getActiveRecord();
    if(!rec) return;
    if(!confirm("تأكيد حذف السجل الحالي؟")) return;
    state.records = state.records.filter(r=>r.id !== rec.id);
    state.activeId = state.records[0]?.id || null;
    saveAll(); syncUI(); render();
  });

  el("btnFocusTitle").addEventListener("click", ()=>{
    el("recordTitle").focus();
    el("recordTitle").select();
  });

  el("btnCreateMany").addEventListener("click", ()=>{
    const txt = el("bulkRecords").value.trim();
    if(!txt) return;
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const base = getActiveRecord();
    lines.forEach(line=>{
      const r = defaultRecord({
        school: base?.school || "",
        termAr: base?.termAr || "الأول",
        academicYearAr: base?.academicYearAr || "١٤٤٦هـ",
        classroom: line,
        teacherName: base?.signatures?.teacherName || "",
        principalName: base?.signatures?.principalName || "",
        formType: base?.formType || "yearwork"
      });
      r.title = `${getFormTitle(r)} - ${line}`;
      addRecord(r);
    });
    saveAll(); syncUI(); render();
    alert("تم إنشاء السجلات: " + lines.length);
  });
  el("btnClearMany").addEventListener("click", ()=> el("bulkRecords").value = "");

  el("formType").addEventListener("change", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.formType = e.target.value;
    if(!rec.title || rec.title.includes("اكتبي الاسم")) rec.title = buildRecordTitle(rec);
    touchRecord(rec); saveAll(); syncUI(); render();
  });

  el("subject").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.subject = e.target.value;
    touchRecord(rec); saveAll(); syncUI();
  });
  el("subject").addEventListener("blur", ()=> render());

  el("school").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.school = e.target.value;
    touchRecord(rec); saveAll(); syncUI();
  });
  el("school").addEventListener("blur", ()=> render());

  el("classroom").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.classroom = e.target.value;
    touchRecord(rec); saveAll(); syncUI();
  });
  el("classroom").addEventListener("blur", ()=> render());

  el("date").addEventListener("change", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.date = e.target.value;
    touchRecord(rec); saveAll(); syncUI(); render();
  });

  el("termAr").addEventListener("change", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.termAr = e.target.value;
    touchRecord(rec); saveAll(); syncUI(); render();
  });

  el("academicYearAr").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.academicYearAr = e.target.value;
    touchRecord(rec); saveAll(); syncUI();
  });
  el("academicYearAr").addEventListener("blur", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.academicYearAr = normalizeAcademicYear(e.target.value);
    el("academicYearAr").value = rec.academicYearAr;
    touchRecord(rec); saveAll(); syncUI(); render();
  });

  el("recordTitle").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.title = e.target.value;
    touchRecord(rec); saveAll();
    refreshRecordSelect();
  });

  el("teacherName").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.signatures.teacherName = e.target.value;
    touchRecord(rec); saveAll(); syncUI();
  });
  el("principalName").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.signatures.principalName = e.target.value;
    touchRecord(rec); saveAll(); syncUI();
  });

  el("btnPrint").addEventListener("click", doPrint);
  el("btnPDF").addEventListener("click", exportPDF);

  el("btnCloudReload").addEventListener("click", async ()=>{
    await cloudLoad(); await cloudVisit();
  });

  el("btnExportJSON").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `سجلات_${USER_KEY}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  el("btnImportJSON").addEventListener("click", ()=> el("jsonFile").click());
  el("jsonFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    try{
      const parsed = JSON.parse(await f.text());
      if(parsed && parsed.records){
        Object.assign(state, parsed);
        state.userKey = USER_KEY;
        ensureAtLeastOneRecord();
        saveAll(); syncUI(); render();
      } else alert("الملف لا يحتوي سجلات.");
    } catch(err){ alert("الملف غير صالح."); }
    finally{ e.target.value = ""; }
  });

  el("btnResetLocal").addEventListener("click", ()=>{
    if(!confirm("سيتم تصفير البيانات محليًا فقط (السحابة تبقى محفوظة).")) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  });

  el("btnSwitchUser").addEventListener("click", ()=> showLoginOverlay(true));

  // Names: CSV
  el("csvFile").addEventListener("change", async (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    const f = e.target.files?.[0];
    if(!f) return;
    const txt = await f.text();
    const names = parseCSV(txt);
    applyNamesToRecord(rec, names);
    e.target.value = "";
  });

  // Names: Paste
  el("btnApplyNames").addEventListener("click", ()=>{
    const rec = getActiveRecord(); if(!rec) return;
    const names = el("namesPaste").value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    applyNamesToRecord(rec, names);
  });

  // Add one student
  el("btnAddRow").addEventListener("click", ()=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.students.push(defaultStudent(""));
    touchRecord(rec); saveAll(); syncUI(); render();
  });

  // Names: OCR image
  el("imgFile").addEventListener("change", async (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    const f = e.target.files?.[0];
    if(!f) return;
    try{
      setCloudPill("OCR جاري استخراج الأسماء…", null);
      const names = await ocrNamesFromImage(f);
      applyNamesToRecord(rec, names);
      setCloudPill("OCR تم ✓", true);
    }catch(err){
      alert("تعذر استخراج الأسماء من الصورة. جرّبي صورة أوضح.");
    } finally {
      e.target.value = "";
    }
  });
}

/* ========== Init ========== */
(function init(){
  if(getUserKey() === "default"){
    el("loginOverlay").classList.add("show");
  }
  el("btnLoginGo").onclick = ()=>{
    const nm = el("loginName").value.trim();
    if(!nm) return alert("اكتبي اسم المعلمة.");
    redirectToUser(nm);
  };
  el("btnLoginClose").onclick = ()=> el("loginOverlay").classList.remove("show");

  showUser();
  bumpLocalVisits();

  loadLocal();
  if(!state.records) state.records = [];
  if(!state.activeId) state.activeId = state.records[0]?.id || null;

  if(state.records.length === 0){
    const r = defaultRecord({title:"سجل أعمال السنة (أول)", formType:"yearwork"});
    r.students = [];
    state.records.push(r);
    state.activeId = r.id;
  }

  saveLocal();
  attachTopEvents();
  syncUI();
  render();

  setCloudPill("جاري الاتصال…", null);
  cloudLoad();
  cloudVisit();

  // عند فتح نافذة الطباعة من النظام (اختصارات)، نضبط نمطها
  window.addEventListener("beforeprint", setPrintMode);
})();
</script>
</body>
</html>
