<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>استمارات الرصد التفاعلية</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- PDF -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- OCR عربي (اختياري) -->
  <script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#0ea5e9;

      --p1:#e9f5e9;
      --p2:#eaf1ff;
      --sum:#fdebdc;
      --avg:#fff6cf;
      --final:#ffd7dc;
      --total:#efefef;

      --ok:#16a34a;
      --bad:#ef4444;
      --neu:#9ca3af;

      --c-part:#c59a00;
      --c-home:#2aa7df;
      --c-perf:#7b8ea6;
      --c-class:#a8d18d;
    }

    *{box-sizing:border-box}
    html, body{width:100%; max-width:100%; overflow-x:hidden;}
    body{
      margin:0;
      font-family:"Cairo", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg);
    }

    header{
      padding:18px 16px 10px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title{display:flex; gap:10px; align-items:center;}
    .badge{
      width:44px; height:44px; border-radius:12px;
      background:linear-gradient(135deg,#22c55e,#0ea5e9);
      display:grid; place-items:center;
      color:white; font-weight:900;
      flex:0 0 auto;
    }
    h1{margin:0; font-size:18px}
    .sub{color:var(--muted); font-size:12px; margin-top:2px}

    .top-actions{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      max-width:100%;
    }

    button, .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-family:inherit;
      font-weight:800;
      font-size:13px;
    }
    button.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:white;
    }
    button.danger{
      background:#ef4444;
      border-color:#ef4444;
      color:white;
    }
    button:disabled{opacity:.6; cursor:not-allowed}

    main{
      padding:0 16px 18px;
      display:grid;
      grid-template-columns: 390px 1fr;
      gap:12px;
      max-width:100%;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 1px 0 rgba(17,24,39,.04);
      max-width:100%;
    }
    .card-hd{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .card-hd .hd-title{font-weight:900;font-size:14px;}
    .card-bd{padding:12px}

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:800;
    }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      font-family:inherit;
      font-size:13px;
      background:#fff;
      outline:none;
      max-width:100%;
    }
    textarea{min-height:88px; resize:vertical}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    @media (max-width: 980px){
      .row,.row3{grid-template-columns:1fr}
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.6;
    }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      max-width:100%;
    }
    .dot{width:10px;height:10px;border-radius:50%;}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .dot.neu{background:#f59e0b}

    #printArea{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      max-width:100%;
    }

    .form-header{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .form-header h2{
      margin:0;
      font-size:16px;
      font-weight:900;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      max-width:100%;
    }
    .meta .kv{
      border:1px solid var(--line);
      border-radius:10px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      background:#fff;
      font-weight:900;
      white-space:nowrap;
      max-width:100%;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      table-layout:fixed;
    }
    th, td{
      border:1px solid #111;
      padding:6px 6px;
      text-align:center;
      vertical-align:middle;
      white-space:normal;
      word-break:break-word;
    }
    th{font-weight:900}
    .p1{background:var(--p1)}
    .p2{background:var(--p2)}
    .sum{background:var(--sum)}
    .avg{background:var(--avg)}
    .final{background:var(--final)}
    .total{background:var(--total)}
    .namecell{text-align:right; font-weight:900}

    .inline-input{
      width:100%;
      padding:6px 6px;
      border:1px solid #000;
      border-radius:6px;
      font-family:inherit;
      font-size:12px;
      text-align:center;
      background:#fff;
      max-width:100%;
    }
    .inline-input.name{text-align:right;font-weight:900}

    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    .footer-note{
      padding:10px 14px 14px;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }

    .status{
      font-size:12px;
      color:var(--muted);
      line-height:1.6;
      margin-top:8px;
      padding:8px 10px;
      border:1px dashed var(--line);
      border-radius:10px;
      background:#fafafa;
    }

    @media (max-width: 820px){
      .grades-table-desktop{display:none !important;}
      .grades-cards-mobile{display:block !important;}
      .monthly-table-desktop{display:none !important;}
      .monthly-cards-mobile{display:block !important;}
    }
    @media (min-width: 821px){
      .grades-table-desktop{display:block !important;}
      .grades-cards-mobile{display:none !important;}
      .monthly-table-desktop{display:block !important;}
      .monthly-cards-mobile{display:none !important;}
    }

    .student-card{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      margin:10px 12px;
      background:#fff;
    }
    .student-card .head{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .student-card .idx{
      font-weight:900;
      color:var(--muted);
      font-size:12px;
    }
    .student-card .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    .student-card .field{
      border:1px solid var(--line);
      border-radius:10px;
      padding:8px;
      background:#fafafa;
      text-align:right;
    }
    .student-card .field b{
      display:block;
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
    }

    .mark-btn{
      width:26px;height:26px;
      border-radius:6px;
      border:1px solid #111;
      display:inline-grid;
      place-items:center;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      background:#fff;
      font-size:14px;
      padding:0;
    }
    .mark-btn.ok{background:#dcfce7; border-color:#16a34a; color:#14532d}
    .mark-btn.bad{background:#fee2e2; border-color:#ef4444; color:#7f1d1d}
    .mark-btn.neu{background:#fff; border-color:#111; color:#111}

    .crit-h.part{background:color-mix(in oklab, var(--c-part) 30%, white)}
    .crit-h.home{background:color-mix(in oklab, var(--c-home) 30%, white)}
    .crit-h.perf{background:color-mix(in oklab, var(--c-perf) 30%, white)}
    .crit-h.class{background:color-mix(in oklab, var(--c-class) 30%, white)}

    .mini-title{font-weight:900;margin:0 12px 6px;color:#111;font-size:13px;}

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      padding:2px 8px;
      border:1px solid var(--line);
      border-radius:8px;
      background:#fff;
      color:#111;
      font-weight:800;
    }

    /* login overlay */
    .overlay{
      position:fixed; inset:0;
      background:rgba(17,24,39,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .overlay.show{display:flex;}
    .overlay .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      border:1px solid var(--line);
      overflow:hidden;
      box-shadow:0 10px 40px rgba(0,0,0,.15);
    }
    .modal-hd{
      padding:14px 14px;
      border-bottom:1px solid var(--line);
      font-weight:900;
    }
    .modal-bd{padding:14px;}
    .modal-bd p{margin:0 0 10px; color:var(--muted); font-size:13px; line-height:1.7;}
    .modal-actions{display:flex; gap:8px; padding:0 14px 14px; flex-wrap:wrap;}
    .modal-actions button{flex:1}

    @media print{
      body{background:#fff}
      header, .card.left, .top-actions, .no-print, .overlay{display:none !important}
      main{display:block; padding:0}
      #printArea{border:none !important;border-radius:0 !important;}
      @page{ size: A4 landscape; margin: 10mm; }
      table{font-size:10.5px}
      .mark-btn{width:22px;height:22px;font-size:12px}
    }
  </style>
</head>

<body>

<!-- Login overlay (إذا ما في ?user= ) -->
<div class="overlay" id="loginOverlay">
  <div class="modal">
    <div class="modal-hd">تسجيل دخول المعلمة</div>
    <div class="modal-bd">
      <p>اكتبي اسم المعلمة (يستخدم للحفظ السحابي). سيتم فتح الرابط تلقائيًا بهذا الشكل: <span class="kbd">?user=اسم_المعلمة</span></p>
      <label>اسم المعلمة</label>
      <input id="loginName" placeholder="مثال: معلمة نورة" />
      <div class="hint">إذا كان عندكم أكثر من معلمة تستخدم نفس الموقع: كل معلمة تدخل باسمها ليصير لها سجلاتها الخاصة.</div>
    </div>
    <div class="modal-actions">
      <button class="primary" id="btnLoginGo">دخول</button>
      <button id="btnLoginClose">إغلاق (استخدام افتراضي)</button>
    </div>
  </div>
</div>

<header>
  <div class="title">
    <div class="badge">✓</div>
    <div>
      <h1>استمارات الرصد التفاعلية</h1>
      <div class="sub">سجلات متعددة لكل معلمة + حفظ سحابي Google Sheet + PDF + متابعة شهرية (صح/خطأ)</div>
    </div>
  </div>

  <div class="top-actions no-print">
    <span class="pill" id="cloudPill"><span class="dot neu"></span> سحابي: …</span>
    <span class="pill" id="globalPill">زيارات عالمية: …</span>
    <span class="pill" id="visitPill">زيارات الجهاز: …</span>
    <span class="pill" id="userPill">مستخدم: …</span>
    <button class="btn" id="btnSwitchUser">تبديل المعلمة</button>
    <button class="btn" id="btnCloudReload">استرجاع من السحابة الآن</button>
    <button class="btn" id="btnExportJSON">تصدير بيانات (JSON)</button>
    <button class="btn" id="btnImportJSON">استيراد بيانات (JSON)</button>
    <input id="jsonFile" type="file" accept="application/json" hidden />
    <button class="danger" id="btnResetLocal">تصفير محلي فقط</button>
  </div>
</header>

<main>
  <!-- يسار -->
  <section class="card left">
    <div class="card-hd">
      <div class="hd-title">السجلات المحفوظة</div>
      <span class="pill" id="autosavePill">حفظ تلقائي: يعمل</span>
    </div>

    <div class="card-bd">
      <!-- سجل/Record picker -->
      <div>
        <label>اختيار السجل</label>
        <select id="recordSelect"></select>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="primary" id="btnNewRecord">إضافة سجل جديد</button>
        <button id="btnRenameRecord">إعادة تسمية</button>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnDuplicateRecord">نسخ سجل</button>
        <button class="danger" id="btnDeleteRecord">حذف السجل</button>
      </div>

      <div class="status">
        ✅ كل سجل مستقل (صف/شعبة/مادة/استمارة).<br>
        ✅ يمكن إنشاء سجلات بعدد الصفوف دفعة واحدة من القسم التالي.
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0">

      <!-- Bulk create records by classes -->
      <div>
        <label>إنشاء سجلات متعددة (كل صف/شعبة في سطر)</label>
        <textarea id="bulkRecords" placeholder="مثال:
سادس/أ
سادس/ب
خامس/أ"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="primary" id="btnCreateMany">إنشاء السجلات</button>
          <button id="btnClearMany">مسح</button>
        </div>
        <div class="hint">ينشئ لكل سطر سجلًا جديدًا بنفس الإعدادات (يمكنك تعديل المادة/النوع لاحقًا داخل كل سجل).</div>
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0">

      <div class="card-hd" style="padding:0 0 10px;border:0">
        <div class="hd-title">إعدادات السجل الحالي</div>
      </div>

      <div class="row">
        <div>
          <label>نوع الاستمارة</label>
          <select id="formType">
            <option value="grades">سجل درجات مادة …</option>
            <option value="monthly">كشف متابعة شهري (صح/خطأ)</option>
            <option value="plans">متابعة الخطط العلاجية والإثرائية</option>
            <option value="counselor">تحويل للموجهة الطلابية</option>
            <option value="principal">تحويل للمديرة</option>
            <option value="parent">تبليغ لولي الأمر</option>
          </select>
        </div>
        <div>
          <label>المادة / العنوان</label>
          <input id="subject" placeholder="مثال: علوم - سادس" />
        </div>
      </div>

      <div class="row3" style="margin-top:10px">
        <div>
          <label>المدرسة</label>
          <input id="school" placeholder="اسم المدرسة" />
        </div>
        <div>
          <label>الصف / الشعبة</label>
          <input id="classroom" placeholder="مثال: سادس/أ" />
        </div>
        <div>
          <label>التاريخ</label>
          <input id="date" type="date" />
        </div>
      </div>

      <div class="row3" style="margin-top:10px">
        <div>
          <label>الفصل الدراسي (بالعربي)</label>
          <select id="termAr">
            <option value="الأول">الأول</option>
            <option value="الثاني">الثاني</option>
            <option value="الثالث">الثالث</option>
          </select>
        </div>
        <div>
          <label>العام الدراسي (بالعربي)</label>
          <input id="academicYearAr" placeholder="مثال: ١٤٤٧هـ" />
          <div class="hint">يحوّل 1447 تلقائيًا إلى ١٤٤٧</div>
        </div>
        <div>
          <label>عنوان السجل</label>
          <input id="recordTitle" placeholder="مثال: سجل درجات علوم - سادس/أ" />
        </div>
      </div>

      <div class="status" id="cloudStatus">
        <b>الحفظ السحابي:</b> يحفظ كل السجلات (وليس سجل واحد) داخل Google Sheet حسب المعلمة.  
        <br><b>معلومة:</b> يمكنك فتح رابط المعلمة مباشرة: <span class="kbd">?user=اسم_المعلمة</span>
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0">

      <div class="card-hd" style="padding:0 0 10px;border:0">
        <div class="hd-title">أسماء الطالبات (للسجل الحالي)</div>
      </div>

      <div class="row">
        <div>
          <label>استيراد CSV (عمود أسماء)</label>
          <input id="csvFile" type="file" accept=".csv,text/csv" />
          <div class="hint">الاسم في أول عمود أو عمود واحد فقط.</div>
        </div>
        <div>
          <label>استيراد من صورة (ألبوم الكاميرا)</label>
          <input id="imgFile" type="file" accept="image/*" />
          <div class="hint">OCR عربي (الدقة تعتمد على وضوح الصورة).</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>أو الصقي الأسماء (كل اسم في سطر)</label>
        <textarea id="namesPaste" placeholder="سارة محمد&#10;ريم عبدالله"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="primary" id="btnApplyNames">تطبيق الأسماء</button>
          <button id="btnAddRow">إضافة طالبة</button>
        </div>
      </div>

      <div class="hint" id="namesCountHint">عدد الطالبات: 0</div>
    </div>
  </section>

  <!-- يمين -->
  <section class="card">
    <div class="card-hd no-print">
      <div class="hd-title">معاينة الاستمارة (السجل الحالي)</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnPrint">طباعة</button>
        <button class="primary" id="btnPDF">تصدير PDF</button>
      </div>
    </div>

    <div id="printArea"></div>
  </section>
</main>

<script>
/* =========================
   Google Sheet Web App
   ========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxMZOvfhuzGY3Unz2jqyFVfSLkvN5xQKxuXyOqpUV9hkdcokD4vxjjDxjZtqkoWzvir/exec";
const APP_TOKEN = ""; // إذا كان عندك توكن اكتبيه هنا

/* =========================
   Helpers
   ========================= */
const el = (id)=>document.getElementById(id);

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"quot;")
    .replaceAll("'","&#039;");
}
function uid(){
  return "r_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function toArabicDigits(str){
  const map = {'0':'٠','1':'١','2':'٢','3':'٣','4':'٤','5':'٥','6':'٦','7':'٧','8':'٨','9':'٩'};
  return (str ?? "").toString().replace(/[0-9]/g, d=>map[d]);
}
function normalizeAcademicYear(input){
  // يترك هـ إن وجدت، ويحوّل الأرقام
  const s = (input ?? "").toString().trim();
  if(!s) return "";
  const converted = toArabicDigits(s);
  return converted.includes("هـ") ? converted : (converted.endsWith("ه") ? converted : converted + (converted.match(/[٠-٩]/) ? "هـ" : ""));
}
function clampNum(x, max){
  const cleaned = (x ?? "").toString().replace(/[^\d.]/g,"");
  const n = Number(cleaned);
  if(Number.isNaN(n)) return 0;
  return Math.max(0, Math.min(max, n));
}
function arabicMonthName(m){
  const months = ["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];
  return months[(m-1)] || "";
}

/* =========================
   userKey from URL
   ========================= */
function getUserKey(){
  const params = new URLSearchParams(location.search);
  const u = (params.get("user") || "").trim();
  return u ? u : "default";
}
let USER_KEY = getUserKey();
let STORAGE_KEY = "irs_records_v1_" + USER_KEY;

/* =========================
   State: multi-records per teacher
   ========================= */
const GRADES_SCHEMA = { p1A: 40, p1B: 20, p2A: 40, p2B: 20, final: 40 };

const EVAL_LEVELS = [
  "متفوق",
  "تحسن بتفوق",
  "جيد",
  "جيد ويحتاج متابعة",
  "يحتاج متابعة",
  "ضعيف",
  "ضعيف جدًا"
];
const EVAL_RANK = {
  "متفوق": 6,
  "تحسن بتفوق": 5,
  "جيد": 4,
  "جيد ويحتاج متابعة": 3,
  "يحتاج متابعة": 2,
  "ضعيف": 1,
  "ضعيف جدًا": 0
};
function normalizeEval(v){
  const s = (v || "").toString().trim();
  return EVAL_LEVELS.includes(s) ? s : "يحتاج متابعة";
}
function getChangeLabel(pre, post){
  const a = EVAL_RANK[normalizeEval(pre)];
  const b = EVAL_RANK[normalizeEval(post)];
  if(b > a) return {text:"تحسن ✅", cls:"ok"};
  if(b < a) return {text:"تراجع ⚠️", cls:"bad"};
  return {text:"ثابت ➖", cls:"warn"};
}

const SUBJECTS = ["لغتي","رياضيات","علوم","إنجليزي","إسلامية","اجتماعيات"];
const PROCEDURES = ["ورقة عمل مركزة","تعليم فردي (1:1)","مجموعة علاجية صغيرة","مجموعة إثرائية","تعلم بالأقران","لعبة تعليمية رقمية","واجب علاجي منزلي","نشاط عملي/تجربة","بطاقات/شفهي","اختبار قصير"];

const SCI_SKILLS_FROM_FILES = {
  3: ["تطبيق الطريقة العلمية التي يستخدمها العلماء بصورة مبسطة في تعلم العلوم ..","تعداد خصائص المخلوقات الحية","استنتاج حاجات المخلوقات الحية .","تفسير مفهوم دورة الحياة.","تعداد مراحل دورة الحياة في الحيوان والنبات","استنتاج العلاقة بين التكاثر وبقاء النوع","ذكر أنواع التكاثر في المخلوقات الحية","ذكر خصائص كل من التكاثر الجنسي واللاجنسي","تفسير كيف يكون التكاثر اللاجنسي في الهيدرا والنجم.","ذكر مفهوم الإخصاب في التكاثر الجنسي","تحديد أجزاء الزهرة ووظيفة كل جزء منها","تفسير كيفية حدوث الإخصاب في الأزهار","توضيح معنى التلقيح مع ذكر أهم طرقه","توضيح مفهوم الثمرة وكيف تتكون","ذكر مفهوم البذرة وكيف تتكون","تفسير ما معنى الإنبات","ذكر العوامل اللازمة للإنبات","تفسير ما المقصود بعملية البناء الضوئي","تحديد مكان حدوث البناء الضوئي في النبات","توضيح مفهوم التنفس الخلوي","المقارنة بين البناء الضوئي والتنفس الخلوي","توضيح مفهوم الغذاء في المخلوقات الحية","توضيح مفهوم السلسلة الغذائية","ترتيب مكونات السلسلة الغذائية","توضيح مفهوم الشبكة الغذائية","شرح مفهوم المستهلك والمنتج والمحلل في النظام البيئي","توضيح مفهوم الجماعة الحيوية والمجتمع الحيوي","تفسير مفهوم التكيف في المخلوقات الحية","ذكر أنواع التكيف في المخلوقات الحية","توضيح كيف تتكيف الحيوانات والنباتات للبقاء","توضيح مفهوم السلوك في المخلوقات الحية","توضيح مفهوم الغريزة في السلوك","تفسير مفهوم تعلم السلوك","ذكر أنواع السلوك المكتسب","توضيح مفهوم الهجرة في السلوك","توضيح مفهوم السبات في السلوك","توضيح مفهوم التضاد في السلوك","تفسير مفهوم التنافس في السلوك","توضيح مفهوم الافتراس في السلوك","تفسير مفهوم التمويه في السلوك","استنتاج الفرق بين دورة حياة الضفدع والجمل من خلال قراءة مجموعة من الرسوم التوضيحية ."],
  5: ["ممارسة الطريقة العلمية التي يتبعها العلماء في دراسة العلوم بصورة مبسطة ..","تعداد الممالك الست في المخلوقات الحية مع رسم مخطط مبسط لإحدى الممالك","تعداد أقسام النبات في المملكة النباتية","تعداد خصائص النباتات الوعائية واللاوعائية","تعداد خصائص النباتات الوعائية البذرية واللا بذرية","توضيح مفهوم البذرة وأهميتها","تحديد أجزاء البذرة ووظيفة كل جزء","تفسير مفهوم الإنبات","تحديد العوامل اللازمة للإنبات","توضيح مفهوم التبرعم","توضيح مفهوم التطعيم","توضيح مفهوم التركيب الضوئي","تفسير مفهوم التمثيل الضوئي","تحديد العوامل اللازمة لحدوث التمثيل الضوئي","تفسير مفهوم التنفس الخلوي","توضيح مفهوم الهرم الغذائي","تحديد مستويات الهرم الغذائي","توضيح مفهوم السلسلة الغذائية","ترتيب مكونات السلسلة الغذائية","توضيح مفهوم الشبكة الغذائية","توضيح مفهوم التحلل","تفسير مفهوم التحلل الحيوي","توضيح مفهوم البيئة","تحديد العوامل الحيوية واللاحيوية في البيئة","توضيح مفهوم الموارد الطبيعية","توضيح مفهوم الموارد المتجددة والغير متجددة","تفسير مفهوم الوقود الأحفوري","توضيح كيفية تكون الوقود الأحفوري","توضيح مفهوم الطاقة","تحديد أشكال الطاقة","توضيح مفهوم تحول الطاقة","ذكر أمثلة على تحول الطاقة","توضيح مفهوم الحرارة","تفسير مفهوم درجة الحرارة","تفسير مفهوم الموصل والعازل الحراري","توضيح مفهوم الإشعاع الحراري","توضيح مفهوم الحمل الحراري","توضيح مفهوم التوصيل الحراري","توضيح مفهوم الانعكاس","توضيح مفهوم الانكسار","تحديد العلاقة بين سرعة الضوء والكثافة","توضيح مفهوم الصوت","توضيح مفهوم طبقة الأوزون وأهميتها","تفسير مفهوم التلوث","توضيح مفهوم التلوث البيئي","ذكر أنواع التلوث","تحديد أثر التلوث على البيئة","توضيح مفهوم إعادة التدوير","ذكر طرق المحافظة على البيئة","توضيح مفهوم الاحتباس الحراري","ذكر أسباب الاحتباس الحراري"],
  6: ["ممارسة الطريقة العلمية التي يستخدمها العلماء في دراسة العلوم بصورة مبسطة ..","ذكر مفهوم النظرية الخلوية","توضيح أن الخلية هي وحدة البناء والوظيفة في المخلوقات الحية","رسم مخطط يوضح تسلسل مستويات التنظيم في المخلوقات الحية","ذكر بعض المركبات الموجودة في خلايا المخلوقات الحية ووظائفها","المقارنة بين الخلية النباتية والخلية الحيوانية","تحديد وظيفة كل عضو من أعضاء الخلية","توضيح مفهوم الانتشار والتناضح","تحديد الفرق بين النقل السلبي والنقل النشط ..","توضيح مفهوم البناء الضوئي","توضيح مفهوم التنفس الخلوي","التمييز بين عمليتي البناء الضوئي والتنفس الخلوي","تلخيص دورة حياة الخلية","تعداد أنواع الانقسام في الخلية","المقارنة بين الانقسام المنصف والانقسام المتساوي","معرفة مفهوم الوراثة","توضيح مفهوم الصفة الوراثية","توضيح مفهوم الجين","توضيح مفهوم الكروموسوم","توضيح مفهوم الطفرة","توضيح مفهوم التكيف","تفسير مفهوم الانتخاب الطبيعي","توضيح مفهوم التنوع الحيوي","ذكر مفهوم الانقراض","توضيح مفهوم الجماعة الحيوية","توضيح مفهوم المجتمع الحيوي","توضيح مفهوم النظام البيئي","تحديد العوامل الحيوية واللاحيوية في النظام البيئي","توضيح مفهوم السلسلة الغذائية","ترتيب مكونات السلسلة الغذائية","توضيح مفهوم الشبكة الغذائية","ذكر مفهوم الهرم الغذائي","توضيح مفهوم الموارد الطبيعية","توضيح مفهوم الموارد المتجددة والغير متجددة","تفسير مفهوم الوقود الأحفوري","توضيح كيفية تكون الوقود الأحفوري","ذكر مفهوم الطاقة","تحديد أشكال الطاقة","توضيح مفهوم تحول الطاقة","ذكر أمثلة على تحول الطاقة","توضيح مفهوم الكهرباء","توضيح مفهوم الدائرة الكهربائية","ذكر مكونات الدائرة الكهربائية","تمييز الدوائر الكهربائية (مفتوحة/مغلقة)","توضيح مفهوم الموصل والعازل الكهربائي","توضيح مفهوم المغناطيس","توضيح مفهوم الكواكب","ترتيب كواكب المجموعة الشمسية","توضيح مفهوم الكسوف والخسوف","ذكر مفهوم المد والجزر","تفسير مفهوم الزلازل","تفسير مفهوم البراكين","ذكر طرق السلامة أثناء الزلازل والبراكين"]
};
const SKILLS_MAP_FALLBACK = {
  1: { "لغتي":["تمييز الحروف","قراءة كلمات","كتابة كلمات","فهم جملة"], "رياضيات":["العد","المقارنة","جمع ضمن 20","طرح ضمن 20"], "علوم":["الحواس","احتياجات الكائن","حي/غير حي","الطقس"], "إنجليزي":["حروف","مفردات","جملة","مطابقة"], "إسلامية":["آداب","سور قصيرة","وضوء","صلاة"], "اجتماعيات":["الأسرة","المدرسة","المجتمع","رموز وطنية"] },
  2: { "لغتي":["قراءة نص","فكرة رئيسة","تجزئة كلمات","إملاء"], "رياضيات":["جمع/طرح 100","قيمة منزلية","قياس","أنماط"], "علوم":["دورات حياة","خصائص المادة","مغناطيس","البيئة"], "إنجليزي":["مفردات","مضارع","أسئلة","قراءة جمل"], "إسلامية":["توحيد","آداب","أذكار","صلاة"], "اجتماعيات":["اتجاهات","خريطة","مهن","معالم"] },
  3: { "لغتي":["فكرة رئيسة","ترتيب زمني","ترقيم","فقرة"], "رياضيات":["ضرب","قسمة","كسور","محيط/مساحة"], "علوم":["أنظمة بيئية","تغيرات المادة","قوة/حركة","تكيف"], "إنجليزي":["قراءة فقرة","جمل","محادثة","قواعد"], "إسلامية":["إيمان","طهارة","سور","قيم"], "اجتماعيات":["موارد","مناخ","سكان","خدمات"] },
  4: { "لغتي":["معنى من سياق","تلخيص","أساليب","تقرير"], "رياضيات":["كسور/عشرية","عوامل","زوايا","مساحة"], "علوم":["سلاسل غذائية","أجهزة الجسم","طاقة","كهرباء"], "إنجليزي":["قراءة","فقرة","أزمنة","استماع"], "إسلامية":["عبادات","سيرة","آداب","تجويد"], "اجتماعيات":["مناطق","تاريخ","اقتصاد","تقنية"] },
  5: { "لغتي":["تحليل","تلخيص","مقال","قواعد"], "رياضيات":["نسبة","كسور","بياني","حجوم"], "علوم":["مصادر الطاقة","دورات","احتكاك","مناخ"], "إنجليزي":["استنتاج","كتابة","قواعد","عرض"], "إسلامية":["فقه","تفسير","سيرة","قيم"], "اجتماعيات":["أنظمة","خرائط","جغرافيا","مشروعات"] },
  6: { "لغتي":["فهم عميق","أدلة","تحليل","تقرير/مقال"], "رياضيات":["معادلات","إحصاء","هندسة","نسب مئوية"], "علوم":["خلايا","وراثة","أنظمة بيئية","مادة/طاقة"], "إنجليزي":["قراءة طويلة","كتابة","تحدث","قواعد"], "إسلامية":["تجويد","فقه","عقيدة","سيرة"], "اجتماعيات":["تاريخ","جغرافيا","مواطنة","تنمية"] }
};
function getSkills(grade, subject){
  if(subject === "علوم" && SCI_SKILLS_FROM_FILES[grade]) return SCI_SKILLS_FROM_FILES[grade];
  const g = SKILLS_MAP_FALLBACK[grade] || {};
  return g[subject] || ["مهارة (أضيفيها حسب حاجتك)"];
}

function defaultRecord(overrides={}){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const date = `${yyyy}-${mm}-${dd}`;

  const id = uid();
  const rec = {
    id,
    title: overrides.title || "سجل جديد",
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),

    formType: overrides.formType || "grades",
    subject: overrides.subject || "",
    school: overrides.school || "",
    classroom: overrides.classroom || "",
    date: overrides.date || date,
    termAr: overrides.termAr || "الأول",
    academicYearAr: overrides.academicYearAr || "١٤٤٦هـ",

    students: overrides.students || [],

    monthly: {
      year: yyyy,
      month: (d.getMonth()+1),
      term: overrides.termAr || "الأول",
      academicYear: overrides.academicYearAr || "١٤٤٦هـ",
      criteria: [
        {key:"participation", label:"المشاركة", cls:"part"},
        {key:"homework", label:"الواجبات", cls:"home"},
        {key:"performance", label:"المهام الأدائية", cls:"perf"},
        {key:"classwork", label:"أنشطة صفية", cls:"class"}
      ],
      weeks: 5
    },

    plans: { entries: [] },
    referral: { studentName:"", reason:"", details:"", teacher:"", receiver:"", actions:"", notes:"" },
    parent: { studentName:"", parentName:"", parentPhone:"", message:"", teacher:"", notes:"" }
  };

  return rec;
}

/* =========================
   Global app state
   ========================= */
const state = {
  version: 1,
  userKey: USER_KEY,
  records: [],
  activeId: null
};

function getActiveRecord(){
  if(!state.activeId && state.records.length) state.activeId = state.records[0].id;
  return state.records.find(r=>r.id===state.activeId) || null;
}
function touchRecord(rec){
  rec.updatedAt = new Date().toISOString();
}

/* =========================
   Local Save/Load
   ========================= */
function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return false;
  try{
    const parsed = JSON.parse(raw);
    if(parsed && parsed.records) Object.assign(state, parsed);
    return true;
  }catch(e){ return false; }
}

/* =========================
   Cloud Save/Load (يحفظ state كامل)
   ========================= */
let saveTimer = null;
function setCloudPill(status, ok=null){
  const pill = el("cloudPill");
  let cls = "dot neu";
  if(ok === true) cls = "dot ok";
  if(ok === false) cls = "dot bad";
  pill.innerHTML = `<span class="${cls}"></span> سحابي: ${escapeHtml(status)}`;
}
async function fetchWithTimeout(url, opts={}, timeoutMs=15000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{ return await fetch(url, {...opts, signal: ctrl.signal}); }
  finally{ clearTimeout(t); }
}
async function cloudLoad(){
  try{
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("action","load");
    url.searchParams.set("userKey", USER_KEY);
    url.searchParams.set("token", APP_TOKEN);

    const res = await fetchWithTimeout(url.toString(), {method:"GET"});
    const data = await res.json();

    if(data.ok && data.found && data.state){
      Object.assign(state, data.state);
      if(!state.userKey) state.userKey = USER_KEY;
      if(!state.records) state.records = [];
      setCloudPill("متصل ✓ (تم التحميل)", true);
      saveLocal();
      syncUI();
      render();
    }else if(data.ok){
      setCloudPill("متصل ✓ (لا يوجد بيانات بعد)", true);
    }else{
      setCloudPill("مشكلة صلاحية/توكن", false);
    }
  }catch(e){
    setCloudPill("غير متصل (محليًا)", false);
  }
}
function cloudSaveDebounced(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>cloudSave(), 800);
}
async function cloudSave(){
  try{
    const payload = { action:"save", token: APP_TOKEN, userKey: USER_KEY, state };
    const res = await fetchWithTimeout(SCRIPT_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.ok) setCloudPill("متصل ✓ (تم الحفظ)", true);
    else setCloudPill("رفض/توكن غير صحيح", false);
  }catch(e){
    setCloudPill("انقطاع (تم الحفظ محليًا)", false);
  }
}
async function cloudVisit(){
  try{
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("action","visit");
    url.searchParams.set("userKey", USER_KEY);
    url.searchParams.set("token", APP_TOKEN);
    const res = await fetchWithTimeout(url.toString(), {method:"GET"});
    const data = await res.json();
    el("globalPill").textContent = "زيارات عالمية: " + (data.globalVisits ?? "—");
  }catch(e){
    el("globalPill").textContent = "زيارات عالمية: —";
  }
}
function saveAll(){
  saveLocal();
  cloudSaveDebounced();
}

/* =========================
   Visits + user info
   ========================= */
function bumpLocalVisits(){
  const vk = "irs_visits_" + USER_KEY;
  const v = parseInt(localStorage.getItem(vk) || "0", 10) + 1;
  localStorage.setItem(vk, String(v));
  el("visitPill").textContent = "زيارات الجهاز: " + v;
}
function showUser(){ el("userPill").textContent = "مستخدم: " + USER_KEY; }

/* =========================
   Monthly helpers
   ========================= */
function ensureMonthlyForStudents(rec){
  const weeks = rec.monthly.weeks || 5;
  const criteria = rec.monthly.criteria || [];
  (rec.students || []).forEach(st=>{
    if(!st.monthlyMarks) st.monthlyMarks = {};
    criteria.forEach(cr=>{
      if(!Array.isArray(st.monthlyMarks[cr.key])) st.monthlyMarks[cr.key] = new Array(weeks).fill(null);
      if(st.monthlyMarks[cr.key].length !== weeks){
        const old = st.monthlyMarks[cr.key].slice(0, weeks);
        while(old.length < weeks) old.push(null);
        st.monthlyMarks[cr.key] = old;
      }
    });
  });
}
function toggleMarkValue(current){
  if(current === null || current === undefined) return true;
  if(current === true) return false;
  return null;
}
function markClass(v){ if(v===true) return "ok"; if(v===false) return "bad"; return "neu"; }
function markText(v){ if(v===true) return "✓"; if(v===false) return "✗"; return ""; }

/* =========================
   UI sync
   ========================= */
function buildRecordTitle(rec){
  const parts = [];
  if(rec.formType === "grades") parts.push("سجل درجات");
  if(rec.formType === "monthly") parts.push("كشف متابعة شهري");
  if(rec.formType === "plans") parts.push("خطط علاجية/إثرائية");
  if(rec.formType === "counselor") parts.push("تحويل للموجهة");
  if(rec.formType === "principal") parts.push("تحويل للمديرة");
  if(rec.formType === "parent") parts.push("تبليغ ولي الأمر");
  if(rec.subject) parts.push(rec.subject);
  if(rec.classroom) parts.push(rec.classroom);
  return parts.join(" - ") || "سجل";
}
function refreshRecordSelect(){
  const sel = el("recordSelect");
  sel.innerHTML = "";
  state.records.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.id;
    opt.textContent = (r.title && r.title.trim()) ? r.title.trim() : buildRecordTitle(r);
    if(r.id === state.activeId) opt.selected = true;
    sel.appendChild(opt);
  });
}
function syncUI(){
  refreshRecordSelect();

  const rec = getActiveRecord();
  if(!rec){
    el("namesCountHint").textContent = "عدد الطالبات: 0";
    return;
  }

  el("formType").value = rec.formType;
  el("subject").value = rec.subject || "";
  el("school").value = rec.school || "";
  el("classroom").value = rec.classroom || "";
  el("date").value = rec.date || "";
  el("termAr").value = rec.termAr || "الأول";
  el("academicYearAr").value = rec.academicYearAr || "";
  el("recordTitle").value = rec.title || "";

  el("namesCountHint").textContent = "عدد الطالبات: " + (rec.students?.length || 0);
}

/* =========================
   Render
   ========================= */
function getFormTitle(rec){
  switch(rec.formType){
    case "grades": return "سجل درجات مادة";
    case "monthly": return "كشف متابعة شهري";
    case "plans": return "متابعة الخطط العلاجية والإثرائية";
    case "counselor": return "نموذج تحويل للموجهة الطلابية";
    case "principal": return "نموذج تحويل للمديرة";
    case "parent": return "تبليغ لولي الأمر";
    default: return "استمارة";
  }
}
function makeFooter(text){
  const f = document.createElement("div");
  f.className = "footer-note";
  f.innerHTML = `<div>${escapeHtml(text)}</div>`;
  return f;
}

function render(){
  const area = el("printArea");
  area.innerHTML = "";

  const rec = getActiveRecord();
  if(!rec){
    area.innerHTML = `<div style="padding:16px;color:var(--muted);font-weight:900">لا يوجد سجلات بعد. اضغطي “إضافة سجل جديد”.</div>`;
    return;
  }

  // sync monthly headers
  rec.monthly.term = rec.termAr || "الأول";
  rec.monthly.academicYear = rec.academicYearAr || rec.monthly.academicYear;

  const header = document.createElement("div");
  header.className = "form-header";
  header.innerHTML = `
    <div>
      <h2>${escapeHtml(getFormTitle(rec))}</h2>
      <div class="sub" style="margin-top:4px;color:var(--muted)">
        ${rec.subject ? "العنوان/المادة: " + escapeHtml(rec.subject) : ""}
      </div>
      <div class="sub" style="margin-top:4px;color:var(--muted)">
        العام الدراسي: <b>${escapeHtml(rec.academicYearAr || "—")}</b> — الفصل: <b>${escapeHtml(rec.termAr || "—")}</b>
      </div>
    </div>
    <div class="meta">
      <div class="kv">المدرسة: ${escapeHtml(rec.school || "—")}</div>
      <div class="kv">الصف/الشعبة: ${escapeHtml(rec.classroom || "—")}</div>
      <div class="kv">التاريخ: ${escapeHtml(rec.date || "—")}</div>
      <div class="kv">السجل: ${escapeHtml((rec.title||"").trim() || buildRecordTitle(rec))}</div>
    </div>
  `;
  area.appendChild(header);

  if(rec.formType === "grades"){
    area.appendChild(renderGradesForm(rec));
    area.appendChild(makeFooter("سجل الدرجات: إدخال تفاعلي + حفظ سحابي + سجلات متعددة لكل صف."));
  }else if(rec.formType === "monthly"){
    area.appendChild(renderMonthlyFollowup(rec));
    area.appendChild(makeFooter("كشف متابعة شهري: اضغطي كل مربع للتبديل (✅ ثم ❌ ثم فراغ)."));
  }else if(rec.formType === "plans"){
    area.appendChild(renderPlansForm(rec));
    area.appendChild(makeFooter("الخطط: مهارات تفاعلية + قبلي/بعدي وصفي + حفظ سحابي."));
  }else if(rec.formType === "counselor"){
    area.appendChild(renderReferralForm(rec, "الموجهة الطلابية"));
  }else if(rec.formType === "principal"){
    area.appendChild(renderReferralForm(rec, "المديرة"));
  }else if(rec.formType === "parent"){
    area.appendChild(renderParentNoticeForm(rec));
  }

  wireDynamicInputs(rec);
}

/* =========================
   Grades Form
   ========================= */
function renderGradesForm(rec){
  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  const bulk = document.createElement("div");
  bulk.className = "no-print";
  bulk.style.border = "1px solid var(--line)";
  bulk.style.borderRadius = "12px";
  bulk.style.padding = "10px";
  bulk.style.marginBottom = "10px";
  bulk.innerHTML = `
    <div style="font-weight:900; margin-bottom:8px;">تعميم درجة على عمود كامل</div>
    <div class="row3">
      <div>
        <label>اختاري العمود</label>
        <select id="bulkCol">
          <option value="p1_a">الفترة الأولى: المهام الأدائية (40)</option>
          <option value="p1_b">الفترة الأولى: تقويمات تحريرية (20)</option>
          <option value="p2_a">الفترة الثانية: المهام الأدائية (40)</option>
          <option value="p2_b">الفترة الثانية: تقويمات تحريرية (20)</option>
          <option value="final">اختبار نهاية الفصل (40)</option>
        </select>
      </div>
      <div>
        <label>اكتبي الدرجة</label>
        <input id="bulkVal" inputmode="numeric" placeholder="مثال: 10" />
      </div>
      <div style="display:flex;align-items:end;gap:8px;">
        <button class="primary" id="btnApplyBulk" style="width:100%;">تطبيق على جميع الطالبات</button>
      </div>
    </div>
  `;
  wrap.appendChild(bulk);

  const tableWrap = document.createElement("div");
  tableWrap.className = "grades-table-desktop";

  const table = document.createElement("table");
  table.id = "gradesTable";

  const thead = document.createElement("thead");
  thead.innerHTML = `
    <tr>
      <th rowspan="2" class="total">م</th>
      <th rowspan="2" class="total namecell">اسم الطالبة</th>

      <th colspan="3" class="p1">الفترة الأولى</th>
      <th colspan="3" class="p2">الفترة الثانية</th>

      <th rowspan="2" class="sum">مجموع الفترتين</th>
      <th rowspan="2" class="avg">متوسط مجموع الفترتين</th>
      <th rowspan="2" class="final">اختبار نهاية الفصل</th>
      <th rowspan="2" class="total">المجموع الكلي</th>
    </tr>
    <tr>
      <th class="p1">المهام الأدائية<br><b>(40)</b></th>
      <th class="p1">تقويمات تحريرية<br><b>(20)</b></th>
      <th class="p1">المجموع<br><b>(60)</b></th>

      <th class="p2">المهام الأدائية<br><b>(40)</b></th>
      <th class="p2">تقويمات تحريرية<br><b>(20)</b></th>
      <th class="p2">المجموع<br><b>(60)</b></th>
    </tr>
  `;
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  const students = rec.students || [];

  for(let i=0;i<students.length;i++){
    const st = students[i];
    const p1a = clampNum(st.p1_a ?? 0, GRADES_SCHEMA.p1A);
    const p1b = clampNum(st.p1_b ?? 0, GRADES_SCHEMA.p1B);
    const p2a = clampNum(st.p2_a ?? 0, GRADES_SCHEMA.p2A);
    const p2b = clampNum(st.p2_b ?? 0, GRADES_SCHEMA.p2B);
    const fin = clampNum(st.final ?? 0, GRADES_SCHEMA.final);

    const p1t = p1a + p1b;
    const p2t = p2a + p2b;
    const sum = p1t + p2t;
    const avg = Math.round((sum/2)*10)/10;
    const total = Math.round((avg + fin)*10)/10;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="total">${i+1}</td>
      <td class="total namecell">
        <input class="inline-input name" data-kind="name" data-i="${i}" value="${escapeHtml(st.name || "")}" placeholder="اسم الطالبة">
      </td>

      <td class="p1"><input class="inline-input" data-kind="p1_a" data-i="${i}" inputmode="numeric" value="${p1a}"></td>
      <td class="p1"><input class="inline-input" data-kind="p1_b" data-i="${i}" inputmode="numeric" value="${p1b}"></td>
      <td class="p1"><b>${p1t}</b></td>

      <td class="p2"><input class="inline-input" data-kind="p2_a" data-i="${i}" inputmode="numeric" value="${p2a}"></td>
      <td class="p2"><input class="inline-input" data-kind="p2_b" data-i="${i}" inputmode="numeric" value="${p2b}"></td>
      <td class="p2"><b>${p2t}</b></td>

      <td class="sum"><b>${sum}</b></td>
      <td class="avg"><b>${avg}</b></td>
      <td class="final"><input class="inline-input" data-kind="final" data-i="${i}" inputmode="numeric" value="${fin}"></td>
      <td class="total"><b>${total}</b></td>
    `;
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  tableWrap.appendChild(table);
  wrap.appendChild(tableWrap);

  // جوال
  const cardsWrap = document.createElement("div");
  cardsWrap.className = "grades-cards-mobile";
  students.forEach((st, i)=>{
    const p1a = clampNum(st.p1_a ?? 0, GRADES_SCHEMA.p1A);
    const p1b = clampNum(st.p1_b ?? 0, GRADES_SCHEMA.p1B);
    const p2a = clampNum(st.p2_a ?? 0, GRADES_SCHEMA.p2A);
    const p2b = clampNum(st.p2_b ?? 0, GRADES_SCHEMA.p2B);
    const fin = clampNum(st.final ?? 0, GRADES_SCHEMA.final);
    const p1t = p1a + p1b;
    const p2t = p2a + p2b;
    const sum = p1t + p2t;
    const avg = Math.round((sum/2)*10)/10;
    const total = Math.round((avg + fin)*10)/10;

    const card = document.createElement("div");
    card.className = "student-card";
    card.innerHTML = `
      <div class="head">
        <div class="idx">#${i+1}</div>
        <input class="inline-input name" data-kind="name" data-i="${i}" value="${escapeHtml(st.name || "")}" placeholder="اسم الطالبة">
      </div>
      <div class="grid">
        <div class="field"><b>ف1 مهام</b><input class="inline-input" data-kind="p1_a" data-i="${i}" inputmode="numeric" value="${p1a}"></div>
        <div class="field"><b>ف1 تحريرية</b><input class="inline-input" data-kind="p1_b" data-i="${i}" inputmode="numeric" value="${p1b}"></div>
        <div class="field"><b>ف2 مهام</b><input class="inline-input" data-kind="p2_a" data-i="${i}" inputmode="numeric" value="${p2a}"></div>
        <div class="field"><b>ف2 تحريرية</b><input class="inline-input" data-kind="p2_b" data-i="${i}" inputmode="numeric" value="${p2b}"></div>
        <div class="field"><b>اختبار نهائي</b><input class="inline-input" data-kind="final" data-i="${i}" inputmode="numeric" value="${fin}"></div>
        <div class="field"><b>المجموع</b><div style="font-weight:900;text-align:center">${total}</div></div>
        <div class="field"><b>مجموع الفترتين</b><div style="font-weight:900;text-align:center">${sum}</div></div>
        <div class="field"><b>متوسط الفترتين</b><div style="font-weight:900;text-align:center">${avg}</div></div>
      </div>
    `;
    cardsWrap.appendChild(card);
  });
  wrap.appendChild(cardsWrap);

  setTimeout(()=>{
    const btn = document.getElementById("btnApplyBulk");
    if(btn){
      btn.onclick = ()=>{
        const col = document.getElementById("bulkCol").value;
        const valRaw = document.getElementById("bulkVal").value;
        const maxMap = { p1_a: 40, p1_b: 20, p2_a: 40, p2_b: 20, final: 40 };
        const v = clampNum(valRaw, maxMap[col]);
        (rec.students||[]).forEach(s=>{ s[col] = v; });
        touchRecord(rec);
        saveAll();
        syncUI();
        render();
      };
    }
  },0);

  return wrap;
}

/* =========================
   Monthly Followup
   ========================= */
function renderMonthlyFollowup(rec){
  ensureMonthlyForStudents(rec);

  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  const monthControls = document.createElement("div");
  monthControls.className = "no-print";
  monthControls.style.border = "1px solid var(--line)";
  monthControls.style.borderRadius = "12px";
  monthControls.style.padding = "10px";
  monthControls.style.marginBottom = "10px";

  const monthOptions = Array.from({length:12}, (_,i)=> {
    const m=i+1;
    return `<option value="${m}" ${m===rec.monthly.month?"selected":""}>${arabicMonthName(m)}</option>`;
  }).join("");
  const weekOptions = [4,5].map(w=>`<option value="${w}" ${w===(rec.monthly.weeks||5)?"selected":""}>${w}</option>`).join("");

  monthControls.innerHTML = `
    <div style="font-weight:900; margin-bottom:8px;">إعدادات الكشف الشهري</div>
    <div class="row3">
      <div>
        <label>الشهر</label>
        <select id="mMonth">${monthOptions}</select>
      </div>
      <div>
        <label>السنة</label>
        <input id="mYear" inputmode="numeric" value="${rec.monthly.year || new Date().getFullYear()}">
      </div>
      <div>
        <label>عدد أسابيع الشهر</label>
        <select id="mWeeks">${weekOptions}</select>
      </div>
    </div>
    <div class="row3" style="margin-top:10px">
      <div>
        <label>الفصل الدراسي</label>
        <input id="mTerm" value="${escapeHtml(rec.termAr || "الأول")}" placeholder="الأول / الثاني">
      </div>
      <div>
        <label>العام الدراسي</label>
        <input id="mAcad" value="${escapeHtml(rec.academicYearAr || "١٤٤٦هـ")}">
      </div>
      <div style="display:flex;align-items:end;gap:8px;">
        <button class="danger" id="mClear" style="width:100%;">تصفير علامات الشهر</button>
      </div>
    </div>
    <div class="hint">الضغط على المربع يبدّل: ✅ ثم ❌ ثم فراغ.</div>
  `;
  wrap.appendChild(monthControls);

  const topTitle = document.createElement("div");
  topTitle.style.padding = "6px 12px 0";
  topTitle.style.textAlign = "center";
  topTitle.style.fontWeight = "900";
  topTitle.style.fontSize = "18px";
  topTitle.innerHTML = `
    كشف متابعة مادة <span style="text-decoration:underline;">${escapeHtml(rec.subject || "........")}</span>
    الصف <span style="text-decoration:underline;">${escapeHtml(rec.classroom || "........")}</span>
    الفصل الدراسي <span style="text-decoration:underline;">${escapeHtml(rec.termAr || "........")}</span>
    للعام <span style="text-decoration:underline;">${escapeHtml(rec.academicYearAr || "........")}</span>
    <div style="font-size:13px;color:var(--muted);margin-top:4px;">
      شهر: ${arabicMonthName(rec.monthly.month)} ${escapeHtml(rec.monthly.year)}
    </div>
  `;
  wrap.appendChild(topTitle);

  const weeks = rec.monthly.weeks || 5;
  const criteria = rec.monthly.criteria || [];
  const students = rec.students || [];

  const tableWrap = document.createElement("div");
  tableWrap.className = "monthly-table-desktop";
  tableWrap.style.marginTop = "10px";

  const table = document.createElement("table");
  table.id = "monthlyTable";

  const h1 = document.createElement("tr");
  h1.innerHTML = `
    <th rowspan="2" class="total" style="width:42px">م</th>
    <th rowspan="2" class="total namecell" style="width:210px">الاسم</th>
  `;
  criteria.forEach(cr=>{
    h1.innerHTML += `<th colspan="${weeks}" class="crit-h ${cr.cls}">${escapeHtml(cr.label)}</th>`;
  });
  const thead = document.createElement("thead");
  thead.appendChild(h1);

  const h2 = document.createElement("tr");
  criteria.forEach(cr=>{
    for(let w=1; w<=weeks; w++){
      h2.innerHTML += `<th class="total">أ${w}</th>`;
    }
  });
  thead.appendChild(h2);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  students.forEach((st, i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="total">${i+1}</td>
      <td class="total namecell">
        <input class="inline-input name" data-kind="name" data-i="${i}" value="${escapeHtml(st.name || "")}" placeholder="اسم الطالبة">
      </td>
    `;
    criteria.forEach(cr=>{
      for(let w=0; w<weeks; w++){
        const v = st.monthlyMarks?.[cr.key]?.[w] ?? null;
        tr.innerHTML += `
          <td>
            <button class="mark-btn ${markClass(v)}" data-m-i="${i}" data-m-k="${cr.key}" data-m-w="${w}">
              ${markText(v)}
            </button>
          </td>
        `;
      }
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  tableWrap.appendChild(table);
  wrap.appendChild(tableWrap);

  // mobile cards
  const cards = document.createElement("div");
  cards.className = "monthly-cards-mobile";
  cards.style.marginTop = "10px";

  const mini = document.createElement("div");
  mini.className = "mini-title";
  mini.textContent = "في الجوال: اضغطي المربعات للتبديل صح/خطأ";
  cards.appendChild(mini);

  students.forEach((st, i)=>{
    const card = document.createElement("div");
    card.className = "student-card";
    let html = `
      <div class="head">
        <div class="idx">#${i+1}</div>
        <input class="inline-input name" data-kind="name" data-i="${i}" value="${escapeHtml(st.name || "")}" placeholder="اسم الطالبة">
      </div>
    `;
    criteria.forEach(cr=>{
      html += `<div style="margin:8px 0 6px;font-weight:900">${escapeHtml(cr.label)}</div>`;
      html += `<div style="display:flex;gap:6px;flex-wrap:wrap">`;
      for(let w=0; w<weeks; w++){
        const v = st.monthlyMarks?.[cr.key]?.[w] ?? null;
        html += `
          <button class="mark-btn ${markClass(v)}" data-m-i="${i}" data-m-k="${cr.key}" data-m-w="${w}">
            ${markText(v) || ("أ"+(w+1))}
          </button>
        `;
      }
      html += `</div>`;
    });
    card.innerHTML = html;
    cards.appendChild(card);
  });

  wrap.appendChild(cards);

  setTimeout(()=>{
    const mMonth = document.getElementById("mMonth");
    const mYear = document.getElementById("mYear");
    const mWeeks = document.getElementById("mWeeks");
    const mTerm = document.getElementById("mTerm");
    const mAcad = document.getElementById("mAcad");
    const mClear = document.getElementById("mClear");

    if(mMonth) mMonth.onchange = ()=>{ rec.monthly.month = Number(mMonth.value); touchRecord(rec); saveAll(); render(); };
    if(mYear) mYear.oninput = ()=>{ rec.monthly.year = Number(mYear.value || new Date().getFullYear()); touchRecord(rec); saveAll(); render(); };
    if(mWeeks) mWeeks.onchange = ()=>{
      rec.monthly.weeks = Number(mWeeks.value);
      ensureMonthlyForStudents(rec);
      touchRecord(rec); saveAll(); render();
    };
    if(mTerm) mTerm.oninput = ()=>{
      rec.termAr = mTerm.value || "الأول";
      rec.monthly.term = rec.termAr;
      touchRecord(rec); saveAll(); render();
    };
    if(mAcad) mAcad.oninput = ()=>{
      rec.academicYearAr = normalizeAcademicYear(mAcad.value);
      rec.monthly.academicYear = rec.academicYearAr;
      touchRecord(rec); saveAll(); render();
    };
    if(mClear) mClear.onclick = ()=>{
      if(!confirm("تأكيد تصفير علامات هذا الشهر لجميع الطالبات؟")) return;
      (rec.students||[]).forEach(st=>{
        if(!st.monthlyMarks) return;
        Object.keys(st.monthlyMarks).forEach(k=>{
          st.monthlyMarks[k] = new Array(rec.monthly.weeks||5).fill(null);
        });
      });
      touchRecord(rec); saveAll(); render();
    };
  }, 0);

  return wrap;
}

/* =========================
   Plans
   ========================= */
function renderPlansForm(rec){
  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  if(!rec.plans) rec.plans = {entries:[]};
  if(!Array.isArray(rec.plans.entries)) rec.plans.entries = [];

  if(rec.plans.entries.length === 0){
    rec.plans.entries.push({
      grade: 1,
      planType: "علاجية",
      subject: "لغتي",
      skill: getSkills(1,"لغتي")[0],
      date: rec.date || "",
      pre: "يحتاج متابعة",
      post: "يحتاج متابعة",
      procedure: PROCEDURES[0],
      notes: ""
    });
  }

  const controls = document.createElement("div");
  controls.className = "no-print";
  controls.style.display = "flex";
  controls.style.gap = "8px";
  controls.style.flexWrap = "wrap";
  controls.style.marginBottom = "10px";
  controls.innerHTML = `
    <button id="btnAddPlanRow" class="primary">إضافة سجل</button>
    <button id="btnClearPlans" class="danger">تصفير سجل الخطط</button>
  `;
  wrap.appendChild(controls);

  const table = document.createElement("table");
  table.id = "plansTable";

  const thead = document.createElement("thead");
  thead.innerHTML = `
    <tr>
      <th class="total">م</th>
      <th class="avg">الصف</th>
      <th class="p1">نوع الخطة</th>
      <th class="p2">المادة</th>
      <th class="sum">المهارة</th>
      <th class="avg">التاريخ</th>
      <th class="p1">القبلي</th>
      <th class="p2">البعدي</th>
      <th class="sum">نتيجة التغير</th>
      <th class="final">الإجراء</th>
      <th class="total">ملاحظات</th>
      <th class="total no-print">حذف</th>
    </tr>
  `;
  table.appendChild(thead);

  const tbody = document.createElement("tbody");

  rec.plans.entries.forEach((r, i)=>{
    const grade = Number(r.grade || 1);
    const subject = r.subject || "لغتي";
    const skills = getSkills(grade, subject);

    r.grade = grade;
    r.subject = subject;
    r.skill = (r.skill && skills.includes(r.skill)) ? r.skill : skills[0];

    r.pre = normalizeEval(r.pre);
    r.post = normalizeEval(r.post);
    const change = getChangeLabel(r.pre, r.post);

    const gradeOptions = [1,2,3,4,5,6].map(g=>`<option value="${g}" ${g===grade?"selected":""}>${g}</option>`).join("");
    const planOptions = ["علاجية","إثرائية"].map(t=>`<option value="${t}" ${t===r.planType?"selected":""}>${t}</option>`).join("");
    const subjOptions = SUBJECTS.map(s=>`<option value="${s}" ${s===subject?"selected":""}>${s}</option>`).join("");
    const skillOptions = skills.map(s=>`<option value="${escapeHtml(s)}" ${s===r.skill?"selected":""}>${escapeHtml(s)}</option>`).join("");
    const procOptions = PROCEDURES.map(p=>`<option value="${escapeHtml(p)}" ${p===r.procedure?"selected":""}>${escapeHtml(p)}</option>`).join("");
    const evalOptionsPre = EVAL_LEVELS.map(x=>`<option value="${escapeHtml(x)}" ${x===r.pre?"selected":""}>${escapeHtml(x)}</option>`).join("");
    const evalOptionsPost = EVAL_LEVELS.map(x=>`<option value="${escapeHtml(x)}" ${x===r.post?"selected":""}>${escapeHtml(x)}</option>`).join("");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="total">${i+1}</td>
      <td class="avg"><select class="inline-input" data-plans-i="${i}" data-plans-k="grade">${gradeOptions}</select></td>
      <td class="p1"><select class="inline-input" data-plans-i="${i}" data-plans-k="planType">${planOptions}</select></td>
      <td class="p2"><select class="inline-input" data-plans-i="${i}" data-plans-k="subject">${subjOptions}</select></td>
      <td class="sum" style="min-width:220px"><select class="inline-input" data-plans-i="${i}" data-plans-k="skill">${skillOptions}</select></td>
      <td class="avg"><input class="inline-input" data-plans-i="${i}" data-plans-k="date" type="date" value="${escapeHtml(r.date || "")}"></td>
      <td class="p1"><select class="inline-input" data-plans-i="${i}" data-plans-k="pre">${evalOptionsPre}</select></td>
      <td class="p2"><select class="inline-input" data-plans-i="${i}" data-plans-k="post">${evalOptionsPost}</select></td>
      <td class="sum"><b>${escapeHtml(change.text)}</b></td>
      <td class="final" style="min-width:180px"><select class="inline-input" data-plans-i="${i}" data-plans-k="procedure">${procOptions}</select></td>
      <td class="total" style="min-width:160px"><input class="inline-input" data-plans-i="${i}" data-plans-k="notes" value="${escapeHtml(r.notes || "")}" placeholder="ملاحظات"></td>
      <td class="total no-print"><button class="danger" data-plans-del="${i}" style="padding:6px 10px;border-radius:8px">×</button></td>
    `;
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  wrap.appendChild(table);

  setTimeout(()=>{
    const addBtn = document.getElementById("btnAddPlanRow");
    const clearBtn = document.getElementById("btnClearPlans");
    if(addBtn){
      addBtn.onclick = ()=>{
        rec.plans.entries.push({
          grade: 1,
          planType: "علاجية",
          subject: "لغتي",
          skill: getSkills(1,"لغتي")[0],
          date: rec.date || "",
          pre: "يحتاج متابعة",
          post: "يحتاج متابعة",
          procedure: PROCEDURES[0],
          notes: ""
        });
        touchRecord(rec); saveAll(); render();
      };
    }
    if(clearBtn){
      clearBtn.onclick = ()=>{
        if(!confirm("تأكيد تصفير سجل الخطط؟")) return;
        rec.plans.entries = [];
        touchRecord(rec); saveAll(); render();
      };
    }
  },0);

  return wrap;
}

/* =========================
   Referral / Parent
   ========================= */
function renderReferralForm(rec, receiverLabel){
  const wrap = document.createElement("div");
  wrap.style.padding = "14px";
  rec.referral.receiver = receiverLabel;

  wrap.innerHTML = `
    <div class="row">
      <div>
        <label>اسم الطالبة</label>
        <input data-form="referral" data-key="studentName" value="${escapeHtml(rec.referral.studentName || "")}" placeholder="اسم الطالبة">
      </div>
      <div>
        <label>المُحوِّلة (اسم المعلمة)</label>
        <input data-form="referral" data-key="teacher" value="${escapeHtml(rec.referral.teacher || "")}" placeholder="اسم المعلمة">
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label>جهة التحويل</label>
        <input value="${escapeHtml(receiverLabel)}" disabled>
      </div>
      <div>
        <label>سبب التحويل (مختصر)</label>
        <input data-form="referral" data-key="reason" value="${escapeHtml(rec.referral.reason || "")}" placeholder="مثال: سلوكي/تعليمي/غياب…">
      </div>
    </div>

    <div style="margin-top:10px">
      <label>تفاصيل الحالة</label>
      <textarea data-form="referral" data-key="details">${escapeHtml(rec.referral.details || "")}</textarea>
    </div>

    <div style="margin-top:10px">
      <label>الإجراءات المقترحة</label>
      <textarea data-form="referral" data-key="actions">${escapeHtml(rec.referral.actions || "")}</textarea>
    </div>

    <div style="margin-top:10px">
      <label>ملاحظات</label>
      <textarea data-form="referral" data-key="notes">${escapeHtml(rec.referral.notes || "")}</textarea>
    </div>
  `;
  return wrap;
}
function renderParentNoticeForm(rec){
  const wrap = document.createElement("div");
  wrap.style.padding = "14px";
  const defaultMsg = `نود إشعاركم بما يلي بخصوص الطالبة، ونؤكد أهمية التعاون لتحقيق أفضل النتائج.`;

  wrap.innerHTML = `
    <div class="row">
      <div>
        <label>اسم الطالبة</label>
        <input data-form="parent" data-key="studentName" value="${escapeHtml(rec.parent.studentName || "")}" placeholder="اسم الطالبة">
      </div>
      <div>
        <label>اسم المعلمة</label>
        <input data-form="parent" data-key="teacher" value="${escapeHtml(rec.parent.teacher || "")}" placeholder="اسم المعلمة">
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label>اسم ولي الأمر</label>
        <input data-form="parent" data-key="parentName" value="${escapeHtml(rec.parent.parentName || "")}" placeholder="اسم ولي الأمر">
      </div>
      <div>
        <label>رقم الجوال (اختياري)</label>
        <input data-form="parent" data-key="parentPhone" value="${escapeHtml(rec.parent.parentPhone || "")}" placeholder="05xxxxxxxx">
      </div>
    </div>

    <div style="margin-top:10px">
      <label>نص التبليغ</label>
      <textarea data-form="parent" data-key="message">${escapeHtml(rec.parent.message || defaultMsg)}</textarea>
    </div>

    <div style="margin-top:10px">
      <label>ملاحظات</label>
      <textarea data-form="parent" data-key="notes">${escapeHtml(rec.parent.notes || "")}</textarea>
    </div>
  `;
  return wrap;
}

/* =========================
   Wire dynamic inputs
   ========================= */
function wireDynamicInputs(rec){
  // grades + names
  document.querySelectorAll("#printArea input.inline-input[data-kind]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const i = Number(inp.dataset.i);
      const kind = inp.dataset.kind;
      if(!rec.students[i]) return;

      if(kind === "name"){
        rec.students[i].name = inp.value;
      }else{
        const maxMap = { p1_a: 40, p1_b: 20, p2_a: 40, p2_b: 20, final: 40 };
        rec.students[i][kind] = clampNum(inp.value, maxMap[kind]);
      }
      touchRecord(rec);
      saveAll();
      syncUI();
      render();
    });
  });

  // monthly toggle
  document.querySelectorAll("#printArea [data-m-i]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = Number(btn.dataset.mI);
      const k = btn.dataset.mK;
      const w = Number(btn.dataset.mW);
      if(!rec.students[i]) return;
      ensureMonthlyForStudents(rec);
      const cur = rec.students[i].monthlyMarks?.[k]?.[w] ?? null;
      rec.students[i].monthlyMarks[k][w] = toggleMarkValue(cur);
      touchRecord(rec);
      saveAll();
      render();
    });
  });

  // plans
  document.querySelectorAll("#printArea [data-plans-i]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const i = Number(inp.dataset.plansI);
      const k = inp.dataset.plansK;
      if(!rec.plans || !rec.plans.entries || !rec.plans.entries[i]) return;
      const row = rec.plans.entries[i];
      row[k] = inp.value;

      if(k === "pre" || k === "post") row[k] = normalizeEval(row[k]);
      if(k === "grade" || k === "subject"){
        const g = Number(row.grade || 1);
        row.grade = g;
        const subj = row.subject || "لغتي";
        const skills = getSkills(g, subj);
        if(!skills.includes(row.skill)) row.skill = skills[0];
        touchRecord(rec);
        saveAll();
        render();
        return;
      }
      touchRecord(rec);
      saveAll();
      render();
    });
  });
  document.querySelectorAll("#printArea [data-plans-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = Number(btn.dataset.plansDel);
      rec.plans.entries.splice(i,1);
      touchRecord(rec);
      saveAll();
      render();
    });
  });

  // referral/parent
  document.querySelectorAll("#printArea [data-form]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const form = inp.dataset.form;
      const key = inp.dataset.key;
      rec[form][key] = inp.value;
      touchRecord(rec);
      saveAll();
    });
  });
}

/* =========================
   Names import
   ========================= */
function setStudentsFromNames(rec, names){
  const clean = names.map(s=>(s||"").toString().trim()).filter(s=>s.length>=2);
  const oldByName = new Map((rec.students||[]).map(s=>[s.name, s]));
  rec.students = clean.map(name=>{
    const old = oldByName.get(name);
    const st = old ? {...old, name} : {name, p1_a:0, p1_b:0, p2_a:0, p2_b:0, final:0};
    if(!st.monthlyMarks) st.monthlyMarks = {};
    return st;
  });
  ensureMonthlyForStudents(rec);
  touchRecord(rec);
  saveAll();
  syncUI();
  render();
}
function parseCSV(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const names = [];
  for(const line of lines){
    const parts = line.split(/[;,]/).map(x=>x.trim()).filter(Boolean);
    if(parts.length===0) continue;
    if(names.length===0 && /اسم|name/i.test(parts[0])) continue;
    names.push(parts[0]);
  }
  return names;
}
async function ocrNamesFromImage(file){
  el("cloudStatus").innerHTML = "<b>OCR:</b> جاري استخراج النص من الصورة…";
  try{
    const { data } = await Tesseract.recognize(file, "ara");
    const text = (data.text || "").trim();
    const names = text.split(/\r?\n/).map(s=>s.trim()).filter(s=>s && s.length>=2);
    el("namesPaste").value = names.join("\n");
    el("cloudStatus").innerHTML = "<b>OCR:</b> تم. اضغطي (تطبيق الأسماء).";
  }catch(e){
    el("cloudStatus").innerHTML = "<b>OCR:</b> تعذر الاستخراج. استخدمي CSV أو اللصق.";
  }
}

/* =========================
   PDF & Print
   ========================= */
function doPrint(){ window.print(); }
async function exportPDF(){
  const btn = el("btnPDF");
  btn.disabled = true;
  btn.textContent = "جاري إنشاء PDF…";

  const rec = getActiveRecord();
  const isWide = (rec.formType === "grades" || rec.formType === "plans" || rec.formType === "monthly");
  const orientation = isWide ? "landscape" : "portrait";

  const area = el("printArea");
  const canvas = await html2canvas(area, { scale: 2, useCORS: true, backgroundColor:"#ffffff" });
  const imgData = canvas.toDataURL("image/png");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation, unit:"mm", format:"a4" });

  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const imgW = pageW;
  const imgH = (canvas.height * imgW) / canvas.width;

  if(imgH <= pageH){
    pdf.addImage(imgData, "PNG", 0, 0, imgW, imgH);
  }else{
    let position = 0;
    let remaining = imgH;
    while(remaining > 0){
      pdf.addImage(imgData, "PNG", 0, position, imgW, imgH);
      remaining -= pageH;
      if(remaining > 0){
        pdf.addPage();
        position -= pageH;
      }
    }
  }

  const safeTitle = ((rec.title||"") || "سجل").replace(/[\\/:*?"<>|]/g,"-");
  pdf.save(safeTitle + ".pdf");

  btn.disabled = false;
  btn.textContent = "تصدير PDF";
}

/* =========================
   Records actions
   ========================= */
function addRecord(rec){
  state.records.push(rec);
  state.activeId = rec.id;
}
function ensureAtLeastOneRecord(){
  if(state.records.length === 0){
    const r = defaultRecord({title:"سجل أول"});
    addRecord(r);
  }
}
function renameRecord(rec){
  const newName = prompt("اسم السجل الجديد:", (rec.title||"").trim() || buildRecordTitle(rec));
  if(newName === null) return;
  rec.title = newName.trim() || buildRecordTitle(rec);
  touchRecord(rec);
  saveAll();
  syncUI();
  render();
}
function duplicateRecord(rec){
  const clone = JSON.parse(JSON.stringify(rec));
  clone.id = uid();
  clone.title = ( (rec.title||buildRecordTitle(rec)) + " (نسخة)" );
  clone.createdAt = new Date().toISOString();
  clone.updatedAt = new Date().toISOString();
  addRecord(clone);
  saveAll();
  syncUI();
  render();
}
function deleteRecord(rec){
  if(!confirm("تأكيد حذف السجل الحالي؟")) return;
  state.records = state.records.filter(r=>r.id !== rec.id);
  if(state.records.length) state.activeId = state.records[0].id;
  else state.activeId = null;
  saveAll();
  syncUI();
  render();
}

/* =========================
   Top events
   ========================= */
function attachTopEvents(){
  // record select
  el("recordSelect").addEventListener("change", (e)=>{
    state.activeId = e.target.value;
    saveLocal();
    syncUI();
    render();
  });

  el("btnNewRecord").addEventListener("click", ()=>{
    const rec0 = getActiveRecord();
    const r = defaultRecord({
      school: rec0?.school || "",
      termAr: rec0?.termAr || "الأول",
      academicYearAr: rec0?.academicYearAr || "١٤٤٦هـ"
    });
    r.title = "سجل جديد";
    addRecord(r);
    saveAll();
    syncUI();
    render();
    setTimeout(()=>renameRecord(r), 50);
  });

  el("btnRenameRecord").addEventListener("click", ()=>{
    const rec = getActiveRecord();
    if(rec) renameRecord(rec);
  });

  el("btnDuplicateRecord").addEventListener("click", ()=>{
    const rec = getActiveRecord();
    if(rec) duplicateRecord(rec);
  });

  el("btnDeleteRecord").addEventListener("click", ()=>{
    const rec = getActiveRecord();
    if(rec) deleteRecord(rec);
  });

  el("btnCreateMany").addEventListener("click", ()=>{
    const txt = el("bulkRecords").value.trim();
    if(!txt) return;
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(lines.length === 0) return;

    const base = getActiveRecord();
    const baseSchool = base?.school || "";
    const baseTerm = base?.termAr || "الأول";
    const baseYear = base?.academicYearAr || "١٤٤٦هـ";

    lines.forEach(line=>{
      const r = defaultRecord({
        school: baseSchool,
        termAr: baseTerm,
        academicYearAr: baseYear,
        classroom: line
      });
      r.title = `سجل ${line}`;
      addRecord(r);
    });

    saveAll();
    syncUI();
    render();
    alert("تم إنشاء السجلات: " + lines.length);
  });

  el("btnClearMany").addEventListener("click", ()=>{ el("bulkRecords").value = ""; });

  // record current settings
  el("formType").addEventListener("change", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.formType = e.target.value;
    if(!rec.title || rec.title === "سجل جديد") rec.title = buildRecordTitle(rec);
    touchRecord(rec); saveAll(); syncUI(); render();
  });

  el("subject").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.subject = e.target.value;
    touchRecord(rec); saveAll(); render();
  });

  el("school").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.school = e.target.value;
    touchRecord(rec); saveAll(); render();
  });

  el("classroom").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.classroom = e.target.value;
    touchRecord(rec); saveAll(); render();
  });

  el("date").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.date = e.target.value;
    touchRecord(rec); saveAll(); render();
  });

  el("termAr").addEventListener("change", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.termAr = e.target.value;
    rec.monthly.term = rec.termAr;
    touchRecord(rec); saveAll(); render();
  });

  el("academicYearAr").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.academicYearAr = normalizeAcademicYear(e.target.value);
    el("academicYearAr").value = rec.academicYearAr;
    rec.monthly.academicYear = rec.academicYearAr;
    touchRecord(rec); saveAll(); render();
  });

  el("recordTitle").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.title = e.target.value;
    touchRecord(rec); saveAll();
    refreshRecordSelect();
  });

  // names actions
  el("btnApplyNames").addEventListener("click", ()=>{
    const rec = getActiveRecord(); if(!rec) return;
    const names = el("namesPaste").value.split(/\r?\n/);
    setStudentsFromNames(rec, names);
  });

  el("btnAddRow").addEventListener("click", ()=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.students = rec.students || [];
    rec.students.push({name:"", p1_a:0, p1_b:0, p2_a:0, p2_b:0, final:0, monthlyMarks:{}});
    ensureMonthlyForStudents(rec);
    touchRecord(rec); saveAll(); syncUI(); render();
  });

  el("csvFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const text = await f.text();
    const names = parseCSV(text);
    el("namesPaste").value = names.join("\n");
  });

  el("imgFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    await ocrNamesFromImage(f);
  });

  // print/pdf
  el("btnPrint").addEventListener("click", doPrint);
  el("btnPDF").addEventListener("click", exportPDF);

  // cloud reload
  el("btnCloudReload").addEventListener("click", async ()=>{
    await cloudLoad();
    await cloudVisit();
  });

  // json export/import
  el("btnExportJSON").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `سجلات_${USER_KEY}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });
  el("btnImportJSON").addEventListener("click", ()=> el("jsonFile").click());
  el("jsonFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    try{
      const parsed = JSON.parse(await f.text());
      if(parsed && parsed.records){
        Object.assign(state, parsed);
        state.userKey = USER_KEY;
        ensureAtLeastOneRecord();
        saveAll(); syncUI(); render();
      }else{
        alert("الملف لا يحتوي سجلات.");
      }
    }catch(err){
      alert("الملف غير صالح.");
    }finally{
      e.target.value = "";
    }
  });

  el("btnResetLocal").addEventListener("click", ()=>{
    if(!confirm("سيتم تصفير البيانات محليًا فقط (السحابة تبقى محفوظة).")) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  });

  // switch user
  el("btnSwitchUser").addEventListener("click", ()=> showLoginOverlay(true));
}

/* =========================
   Login overlay
   ========================= */
function showLoginOverlay(force=false){
  const overlay = el("loginOverlay");
  if(force) overlay.classList.add("show");
  else overlay.classList.toggle("show");
}
function redirectToUser(name){
  const u = (name||"").trim();
  const params = new URLSearchParams(location.search);
  if(u) params.set("user", u);
  else params.delete("user");
  location.search = params.toString();
}

/* =========================
   Init
   ========================= */
(function init(){
  // if no ?user show overlay
  if(getUserKey() === "default"){
    // إذا ما تم تحديد user، نعرض overlay اختيار اسم معلمة
    el("loginOverlay").classList.add("show");
  }

  el("btnLoginGo").onclick = ()=>{
    const nm = el("loginName").value.trim();
    if(!nm){
      alert("اكتبي اسم المعلمة.");
      return;
    }
    redirectToUser(nm);
  };
  el("btnLoginClose").onclick = ()=>{
    el("loginOverlay").classList.remove("show");
  };

  showUser();
  bumpLocalVisits();

  // load local first
  loadLocal();

  // ensure structure
  if(!state.records) state.records = [];
  if(!state.activeId) state.activeId = state.records[0]?.id || null;

  ensureAtLeastOneRecord();

  // default academic year display (لو فاضي)
  const rec = getActiveRecord();
  if(rec && !rec.academicYearAr) rec.academicYearAr = "١٤٤٦هـ";

  // save local and render
  saveLocal();
  attachTopEvents();
  syncUI();
  render();

  // cloud
  setCloudPill("جاري الاتصال…", null);
  cloudLoad();
  cloudVisit();

  window.addEventListener("beforeunload", saveLocal);
})();
</script>
</body>
</html>
