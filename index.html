<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>استمارات الرصد التفاعلية</title>

  <!-- PDF libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --b:#e5e7eb; --muted:#6b7280; --bg:#ffffff; --card:#fafafa;
      --ok:#16a34a; --bad:#dc2626; --neu:#9ca3af;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#111;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--b)}
    .wrap{max-width:1200px;margin:0 auto;padding:12px}
    h1{margin:0;font-size:18px;font-weight:900}
    .sub{color:var(--muted);font-size:12px;margin-top:4px;font-weight:800}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--b);background:var(--card);border-radius:999px;padding:6px 10px;font-size:12px;font-weight:900}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.bad{background:var(--bad)} .dot.neu{background:var(--neu)}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:12px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .panel{border:1px solid var(--b);border-radius:16px;overflow:hidden;background:#fff}
    .panel h2{margin:0;padding:10px 12px;font-size:14px;font-weight:900;background:var(--card);border-bottom:1px solid var(--b)}
    .panel .p{padding:12px}
    label{display:block;font-size:12px;font-weight:900;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--b);border-radius:12px;font-weight:800;font-family:inherit;background:#fff}
    textarea{min-height:110px;resize:vertical}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{border:1px solid var(--b);background:#111;color:#fff;font-weight:900;padding:10px 12px;border-radius:12px;cursor:pointer}
    button.secondary{background:#fff;color:#111}
    button.danger{background:#dc2626}
    button:disabled{opacity:.6;cursor:not-allowed}

    /* Print area */
    #printArea{padding:0}
    .printHead{padding:10px 12px;border-bottom:1px solid var(--b);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .printHead .t{font-weight:900;font-size:16px}
    .printHead .m{color:var(--muted);font-size:12px;font-weight:800}
    .printPills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .wrapX{overflow:auto;-webkit-overflow-scrolling:touch}

    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--b);padding:6px;text-align:center;font-weight:900;font-size:12px}
    th{background:#f3f4f6}
    td.namecell{text-align:right}
    .inline{width:100%;border:0;outline:0;padding:6px;font-weight:900;background:transparent;text-align:center;font-size:12px}
    .inline.name{text-align:right}
    .tot{background:#f9fafb}
    .mark{width:100%;padding:8px 0;border-radius:10px;border:1px solid var(--b);background:#fff;color:#111;font-weight:900}

    .noPrint{display:block}
    .screenOnly{display:block}
    .printOnly{display:none;white-space:pre-wrap;line-height:1.9;font-weight:900;text-align:right;font-size:14px}
    .pv{display:none;font-weight:900;font-size:12px}

    body.forcePrint .screenOnly{display:none!important;}
    body.forcePrint .printOnly{display:block!important;}

    /* ===== PIN Modal ===== */
    .pinOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:99999;padding:18px}
    .pinBox{width:min(420px,100%);background:#fff;border-radius:18px;border:1px solid var(--b);padding:14px}
    .pinBox h3{margin:0 0 6px;font-weight:900;font-size:16px}
    .pinBox p{margin:0 0 10px;color:var(--muted);font-weight:800;font-size:12px}
    .pinRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pinRow input{flex:1;padding:12px;border-radius:12px;border:1px solid var(--b);font-weight:900;font-size:14px;text-align:center;letter-spacing:2px}
    .pinErr{margin-top:8px;color:#dc2626;font-weight:900;font-size:12px;display:none}

    /* ===== Signatures compact (font 13) ===== */
    .sigline{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:6px 10px 10px; flex-wrap:wrap;
    }
    .sigbox{
      display:flex; align-items:center; gap:8px; flex:1 1 0;
      border:1px solid var(--b); border-radius:12px; padding:6px 8px; background:#fff;
    }
    .sigbox .lbl{font-size:13px;font-weight:900;white-space:nowrap}
    .sigbox input{font-size:13px;font-weight:900;border:0;border-bottom:1px dotted #111;border-radius:0;padding:4px 6px}
    .sigbox .pv{display:none;font-size:13px;font-weight:900;white-space:nowrap}

    /* ===== Vertical header like Word for "اسم الطالبة" ===== */
    @media print{
      th.vhead{padding:0!important;width:24px!important;min-width:24px!important}
      th.vhead>span{display:inline-block;writing-mode:vertical-rl;transform:rotate(180deg);white-space:nowrap;line-height:1;padding:8px 0;font-weight:900}
    }

    /* ===== Print rules (A4 landscape) ===== */
    @page { size: A4 landscape; margin: 8mm; }
    @media print{
      header, .panel.left {display:none!important}
      body{background:#fff}
      .grid{display:block}
      .panel.right{border:0}
      .wrap{max-width:none;padding:0}
      .wrapX{overflow:visible}

      .noPrint{display:none!important}
      .screenOnly{display:none!important}
      .printOnly{display:block!important}

      input.inline, select.inline, textarea{display:none!important}
      .pv{display:inline!important}

      table{width:100%; table-layout:fixed;}
      thead{display:table-header-group}
      tr{page-break-inside:avoid}

      th,td{font-size:9.5px;padding:3px;white-space:normal!important;word-break:break-word}
      /* اسم الطالبة يظهر كامل */
      td.namecell{font-size:10px}
      /* تصغير أعمدة الدرجات */
      .gcol{width:44px!important;min-width:44px!important}
      .ncol{width:290px!important;min-width:290px!important}
      .mcol{width:32px!important;min-width:32px!important}
      /* توقيع خط واحد */
      .sigline{gap:6px}
      .sigbox{padding:4px 6px}
      .sigbox .pv{display:inline!important}
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>استمارات الرصد التفاعلية</h1>
        <div class="sub noPrint">الحفظ: محلي + سحابي (حتى بعد الخروج والعودة). والطباعة لا تُظهر أزرار/أوامر.</div>
      </div>
      <div class="row">
        <div class="pill" id="cloudPill"><span class="dot neu"></span> سحابي: …</div>
        <div class="pill" id="globalPill">زيارات عالمية: …</div>
        <div class="pill" id="userPill">معلمة: …</div>
        <button class="secondary noPrint" id="btnCloudReload">استرجاع</button>
        <button class="secondary" id="btnPrint">طباعة</button>
        <button id="btnPDF">حفظ PDF</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT -->
    <div class="panel left">
      <h2>المعلمات + السجلات المحفوظة</h2>
      <div class="p">

        <label>اختيار المعلمة (كل معلمة بياناتها مستقلة)</label>
        <select id="teacherSelect"></select>

        <div class="btns" style="margin-top:10px">
          <button class="secondary" id="btnLock">قفل/فتح (PIN)</button>
          <button class="secondary" id="btnSwitch">تبديل معلمة</button>
        </div>

        <hr style="border:0;border-top:1px solid var(--b); margin:14px 0">

        <label>اختيار السجل</label>
        <select id="recordSelect"></select>

        <div class="btns" style="margin-top:10px">
          <button id="btnNew">سجل جديد</button>
          <button class="secondary" id="btnDup">نسخ سجل</button>
          <button class="danger" id="btnDel">حذف</button>
        </div>

        <div class="btns" style="margin-top:10px">
          <button class="secondary" id="btnRename">تسمية السجل</button>
          <button class="secondary" id="btnSaveNow">حفظ الآن</button>
        </div>

        <hr style="border:0;border-top:1px solid var(--b); margin:14px 0">

        <label>نوع الاستمارة</label>
        <select id="formType">
          <option value="yearwork">سجل أعمال السنة لعام …</option>
          <option value="plans">متابعة الخطط العلاجية والإثرائية</option>
        </select>

        <label>المدرسة</label>
        <input id="school" placeholder="اسم المدرسة" />

        <label>الصف / الشعبة</label>
        <input id="classroom" placeholder="مثال: السادس/أ" />

        <label>التاريخ</label>
        <input id="date" type="date" />

        <label>الفصل الدراسي (بالعربي)</label>
        <select id="termAr">
          <option>الأول</option><option>الثاني</option><option>الثالث</option>
        </select>

        <label>العام الدراسي (مثل ١٤٤٧هـ)</label>
        <input id="yearAr" placeholder="١٤٤٧هـ" />

        <label>عنوان السجل</label>
        <input id="title" placeholder="مثال: أعمال سنة علوم سادس/أ" />

        <hr style="border:0;border-top:1px solid var(--b); margin:14px 0">

        <label>أسماء الطالبات (كل اسم في سطر)</label>
        <textarea id="namesPaste" placeholder="الصقي الأسماء هنا…"></textarea>
        <div class="btns" style="margin-top:10px">
          <button class="secondary" id="btnApplyNames">تطبيق الأسماء</button>
          <button class="secondary" id="btnAddStudent">إضافة طالبة</button>
        </div>

        <div class="sub" style="margin-top:10px;font-weight:900" id="countHint">عدد الطالبات: 0</div>

      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel right">
      <h2>الاستمارة</h2>
      <div class="sub noPrint" style="padding:0 12px 10px">
        ملاحظة: أزرار التعميم لا تظهر بالطباعة.
      </div>
      <div id="printArea"></div>
    </div>

  </div>
</div>

<!-- PIN -->
<div class="pinOverlay" id="pinOverlay">
  <div class="pinBox">
    <h3 id="pinTitle">قفل الصفحة</h3>
    <p id="pinHint">أدخلي الرقم السري لفتح صفحة المعلمة.</p>
    <div class="pinRow">
      <input id="pinInput" inputmode="numeric" maxlength="8" placeholder="••••" />
      <button id="pinBtn">دخول</button>
      <button class="secondary" id="pinSetBtn" style="display:none">تعيين PIN</button>
      <button class="secondary" id="pinChangeBtn" style="display:none">تغيير PIN</button>
    </div>
    <div class="pinErr" id="pinErr">الرقم غير صحيح</div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby_2OMmrcfqSB6TfxCoRJzxPkKipcbJ97dEK5C1T8-rfueSRO2ExTeHEyK2UAXN4Trr/exec";

/* قائمة المعلمات داخل الصفحة */
const TEACHERS = [
  { name:"بدرية الزهراني", key:"t_badriyah_alzahrani" },
  { name:"عزة الشهري", key:"t_azza_alshahri" },
  { name:"نورة القحطاني", key:"t_noura_alqahtani" },
  { name:"مستورة الشهراني", key:"t_mastoorah_alshahrani" },
  { name:"فوزية الشهري", key:"t_fawziah_alshahri" },
  { name:"فوزية العمري", key:"t_fawziah_alomari" },
  { name:"هيا المعاوي", key:"t_haya_almaawi" },
  { name:"هيا الاحمري", key:"t_haya_alahmari" },
  { name:"فاطمة الاسمري", key:"t_fatima_alasmari" },
];

const $ = (id)=>document.getElementById(id);
const esc = (s)=> (s ?? "").toString()
  .replaceAll("&","&amp;").replaceAll("<","&lt;")
  .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

const uid = ()=> "r_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);

function parseNumLoose(v){
  const s2 = (v??"").toString().trim()
    .replace(/[٠١٢٣٤٥٦٧٨٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d))
    .replace(/[^\d.]/g,"");
  if(!s2 || s2===".") return null;
  const n=Number(s2);
  return Number.isFinite(n)?n:null;
}
function clamp(v,max){
  const n=parseNumLoose(v);
  if(n===null) return "";
  return String(Math.max(0, Math.min(max, n)));
}

/* ===================== JSONP fallback ===================== */
function jsonp(url){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Math.random().toString(16).slice(2);
    const cleanup = (s)=>{
      try{ delete window[cb]; }catch{}
      if(s && s.parentNode) s.parentNode.removeChild(s);
    };
    window[cb] = (data)=>{ resolve(data); cleanup(script); };
    const script = document.createElement("script");
    script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
    script.onerror = ()=>{ reject(new Error("JSONP failed")); cleanup(script); };
    document.head.appendChild(script);
  });
}
async function getJSON(url){
  try{
    const r = await fetch(url, { cache: "no-store" });
    return await r.json();
  }catch{
    return await jsonp(url);
  }
}

function setCloud(text, ok=null){
  const pill=$("cloudPill");
  const dot = ok===true ? "ok" : ok===false ? "bad" : "neu";
  pill.innerHTML = `<span class="dot ${dot}"></span> سحابي: ${esc(text)}`;
}

/* ===================== USER/TEACHER ===================== */
function getUserFromUrl(){
  const p=new URLSearchParams(location.search);
  let u=(p.get("user")||"").trim();

  if(!u){
    const h=(location.hash||"").replace(/^#/,"");
    const hp=new URLSearchParams(h.startsWith("?")?h.slice(1):h);
    u=(hp.get("user")||hp.get("u")||"").trim();
  }
  return u;
}

let USER = getUserFromUrl() || localStorage.getItem("irs_last_teacher") || TEACHERS[0].key;
localStorage.setItem("irs_last_teacher", USER);

let LKEY = `irs_state_${USER}`;

/* ===================== STATE ===================== */
const state = {
  version: 1,
  userKey: USER,
  meta: { pinHash:"" },
  records: [],
  activeId: null
};

function defaultStudent(name=""){
  return { id:uid(), name, yearwork:{ p1Task:"", p1Quiz:"", p2Task:"", p2Quiz:"", final:"" } };
}
function defaultRecord(){
  const d=new Date();
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
  return {
    id: uid(),
    title: "سجل جديد",
    formType: "yearwork",
    school: "",
    classroom: "",
    date: `${yyyy}-${mm}-${dd}`,
    termAr: "الأول",
    academicYearAr: "١٤٤٧هـ",
    signatures: { teacherName:"", reviewerName:"", principalName:"" },
    students: [],
    plans: { entries: [] }
  };
}
function active(){
  if(!state.activeId && state.records.length) state.activeId=state.records[0].id;
  return state.records.find(r=>r.id===state.activeId) || null;
}

/* ===================== LOCAL STORAGE (safe) ===================== */
function saveLocal(){
  try{
    localStorage.setItem(LKEY, JSON.stringify(state));
    return true;
  }catch(e){
    return false;
  }
}
function loadLocal(){
  try{
    const raw = localStorage.getItem(LKEY);
    if(!raw) return;
    const o = JSON.parse(raw);
    if(o && o.records) Object.assign(state, o);
  }catch(e){}
}

/* ===================== CLOUD SAVE/LOAD ===================== */
async function cloudVisit(){
  try{
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("action","visit");
    url.searchParams.set("userKey", USER);
    const j = await getJSON(url.toString());
    $("globalPill").textContent = `زيارات عالمية: ${j.globalVisits ?? "—"}`;
  }catch{
    $("globalPill").textContent = "زيارات عالمية: —";
  }
}

async function cloudLoad(){
  setCloud("جاري التحميل…");
  try{
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("action","load");
    url.searchParams.set("userKey", USER);
    const j = await getJSON(url.toString());
    if(j.ok && j.found && j.state){
      Object.assign(state, j.state);
      state.userKey = USER;
      setCloud("تم التحميل ✓", true);
      saveLocal();
      return true;
    } else {
      setCloud("لا توجد بيانات سحابية بعد", true);
      return false;
    }
  }catch{
    setCloud("غير متصل (محليًا)", false);
    return false;
  }
}

async function cloudSave(){
  setCloud("جاري الحفظ…");
  try{
    const r = await fetch(SCRIPT_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ action:"save", userKey: USER, state })
    });
    let j=null;
    try{ j=await r.json(); }catch(e){}
    if(j && j.ok) setCloud("تم الحفظ ✓", true);
    else if(r.ok) setCloud("تم الإرسال ✓", true);
    else setCloud("تعذر الحفظ", false);
  }catch(e){
    setCloud("غير متصل (محليًا)", false);
  }
}

let saveTimer=null;
function saveAll(){
  saveLocal();
  clearTimeout(saveTimer);
  saveTimer=setTimeout(()=>cloudSave(), 450);
}
window.addEventListener("beforeunload", ()=>{ try{ saveLocal(); }catch{} });

/* ===================== PIN (per teacher) ===================== */
async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}
function showPin_(mode){
  const ov=$("pinOverlay"), err=$("pinErr"), inp=$("pinInput");
  const title=$("pinTitle"), hint=$("pinHint"), btn=$("pinBtn");
  const setBtn=$("pinSetBtn"), chBtn=$("pinChangeBtn");

  err.style.display="none";
  inp.value="";
  ov.style.display="flex";

  if(mode==="set"){
    title.textContent="تعيين PIN للمعلمة";
    hint.textContent="اكتبي رقمًا من 4 إلى 8 أرقام.";
    btn.textContent="حفظ";
    btn.dataset.mode="set";
    setBtn.style.display="none";
    chBtn.style.display="none";
  }else if(mode==="change"){
    title.textContent="تغيير PIN";
    hint.textContent="اكتبي PIN الجديد (4 إلى 8 أرقام).";
    btn.textContent="حفظ";
    btn.dataset.mode="set";
    setBtn.style.display="none";
    chBtn.style.display="none";
  }else{
    title.textContent="قفل صفحة المعلمة";
    hint.textContent="أدخلي PIN لفتح الصفحة.";
    btn.textContent="دخول";
    btn.dataset.mode="unlock";
    setBtn.style.display="inline-flex";
    chBtn.style.display="inline-flex";
  }
}
function hidePin_(){ $("pinOverlay").style.display="none"; }

function hasPin_(){ return !!(state.meta && state.meta.pinHash); }

async function ensurePinGate_(){
  if(!hasPin_()) showPin_("set");
  else showPin_("unlock");
}

async function handlePinSubmit_(){
  const mode=$("pinBtn").dataset.mode;
  const pin=($("pinInput").value||"").trim();
  const err=$("pinErr");

  if(!/^\d{4,8}$/.test(pin)){
    err.textContent="PIN يجب أن يكون من 4 إلى 8 أرقام.";
    err.style.display="block";
    return;
  }

  if(mode==="set"){
    state.meta ||= {};
    state.meta.pinHash = await sha256Hex(`PIN:${USER}:${pin}`);
    saveAll();
    hidePin_();
    return;
  }

  const h = await sha256Hex(`PIN:${USER}:${pin}`);
  if(h === (state.meta?.pinHash||"")){
    hidePin_();
  }else{
    err.textContent="PIN غير صحيح";
    err.style.display="block";
  }
}

/* ===================== UI sync ===================== */
function syncTeacherSelect(){
  const sel=$("teacherSelect");
  sel.innerHTML="";
  TEACHERS.forEach(t=>{
    const o=document.createElement("option");
    o.value=t.key; o.textContent=t.name;
    if(t.key===USER) o.selected=true;
    sel.appendChild(o);
  });
  const t = TEACHERS.find(x=>x.key===USER);
  $("userPill").textContent = `معلمة: ${t ? t.name : USER}`;
}
function syncRecordSelect(){
  const sel=$("recordSelect");
  sel.innerHTML="";
  state.records.forEach(r=>{
    const o=document.createElement("option");
    o.value=r.id; o.textContent=r.title||"سجل";
    if(r.id===state.activeId) o.selected=true;
    sel.appendChild(o);
  });
}
function syncForm(rec){
  $("formType").value = rec.formType;
  $("school").value = rec.school||"";
  $("classroom").value = rec.classroom||"";
  $("date").value = rec.date||"";
  $("termAr").value = rec.termAr||"الأول";
  $("yearAr").value = rec.academicYearAr||"";
  $("title").value = rec.title||"";
  $("namesPaste").value = (rec.students||[]).map(s=>s.name||"").join("\n");
  $("countHint").textContent = `عدد الطالبات: ${(rec.students||[]).length}`;
}

/* ===================== Calculations ===================== */
function ywCalc(st){
  const a=parseNumLoose(st.yearwork.p1Task)||0;
  const b=parseNumLoose(st.yearwork.p1Quiz)||0;
  const c=parseNumLoose(st.yearwork.p2Task)||0;
  const d=parseNumLoose(st.yearwork.p2Quiz)||0;
  const p1=a+b, p2=c+d, sum=p1+p2, avg=sum/2;
  const fin=parseNumLoose(st.yearwork.final)||0;
  const total=avg+fin;
  return {p1,p2,sum,avg,total};
}

/* ===================== RENDER ===================== */
function render(){
  const rec=active();
  const area=$("printArea");
  if(!rec){
    area.innerHTML = `<div class="p" style="color:var(--muted);font-weight:900">لا يوجد سجلات.</div>`;
    return;
  }

  area.innerHTML = `
    <div class="printHead">
      <div>
        <div class="t">${esc(rec.formType==="yearwork" ? `سجل أعمال السنة لعام ${rec.academicYearAr||"…"}` : "متابعة الخطط العلاجية والإثرائية")}</div>
        <div class="m">العام الدراسي: <b>${esc(rec.academicYearAr||"—")}</b> — الفصل: <b>${esc(rec.termAr||"—")}</b></div>
      </div>
      <div class="printPills">
        <div class="pill">المدرسة: ${esc(rec.school||"—")}</div>
        <div class="pill">الصف/الشعبة: ${esc(rec.classroom||"—")}</div>
        <div class="pill">التاريخ: ${esc(rec.date||"—")}</div>
      </div>
    </div>
  `;

  if(rec.formType==="yearwork") area.appendChild(renderYearwork(rec));
  else area.appendChild(renderPlans(rec));

  area.appendChild(renderSignatures(rec));
  wire(rec);
}

function renderSignatures(rec){
  const wrap=document.createElement("div");

  const isYW = rec.formType==="yearwork";
  const t = rec.signatures?.teacherName || "";
  const rv = rec.signatures?.reviewerName || "";
  const pr = rec.signatures?.principalName || "";

  wrap.innerHTML = `
    <div class="sigline">
      <div class="sigbox">
        <div class="lbl">المعلمة:</div>
        <input id="sigTeacher" value="${esc(t)}" placeholder="اسم المعلمة">
        <span class="pv" id="pvTeacher">${esc(t)}</span>
      </div>

      ${isYW ? `
      <div class="sigbox">
        <div class="lbl">المراجعة:</div>
        <input id="sigReviewer" value="${esc(rv)}" placeholder="اسم المراجعة">
        <span class="pv" id="pvReviewer">${esc(rv)}</span>
      </div>
      ` : ``}

      <div class="sigbox">
        <div class="lbl">قائدة المدرسة:</div>
        <input id="sigPrincipal" value="${esc(pr)}" placeholder="اسم المديرة">
        <span class="pv" id="pvPrincipal">${esc(pr)}</span>
      </div>
    </div>
  `;
  return wrap;
}

/* ===== أعمال السنة ===== */
function renderYearwork(rec){
  const wrap=document.createElement("div");
  wrap.className="p";
  const students = rec.students || [];

  wrap.innerHTML = `
    <div class="wrapX">
      <table>
        <thead>
          <tr>
            <th class="tot mcol">م</th>
            <th class="tot vhead ncol"><span>اسم الطالبة</span></th>

            <th class="gcol">مهام 1<br>(40)</th>
            <th class="gcol">تقويم 1<br>(20)</th>
            <th class="tot gcol">مجموع 1<br>(60)</th>

            <th class="gcol">مهام 2<br>(40)</th>
            <th class="gcol">تقويم 2<br>(20)</th>
            <th class="tot gcol">مجموع 2<br>(60)</th>

            <th class="tot gcol">مجموع<br>(120)</th>
            <th class="tot gcol">متوسط<br>(60)</th>
            <th class="gcol">نهائي<br>(40)</th>
            <th class="tot gcol">الكلي<br>(100)</th>
          </tr>

          <tr class="noPrint">
            <th colspan="2" class="tot">تعميم</th>
            <th><input class="inline" id="fill_p1Task" placeholder="40"><button class="mark" data-fill="p1Task">تعميم</button></th>
            <th><input class="inline" id="fill_p1Quiz" placeholder="20"><button class="mark" data-fill="p1Quiz">تعميم</button></th>
            <th class="tot"></th>
            <th><input class="inline" id="fill_p2Task" placeholder="40"><button class="mark" data-fill="p2Task">تعميم</button></th>
            <th><input class="inline" id="fill_p2Quiz" placeholder="20"><button class="mark" data-fill="p2Quiz">تعميم</button></th>
            <th class="tot"></th>
            <th class="tot"></th>
            <th class="tot"></th>
            <th><input class="inline" id="fill_final" placeholder="40"><button class="mark" data-fill="final">تعميم</button></th>
            <th class="tot"></th>
          </tr>
        </thead>

        <tbody>
          ${students.map((st,i)=>{
            st.yearwork ||= {p1Task:"",p1Quiz:"",p2Task:"",p2Quiz:"",final:""};
            const t=ywCalc(st);
            return `
              <tr>
                <td class="tot mcol">${i+1}</td>

                <td class="namecell ncol">
                  <input class="inline name" data-st="name" data-i="${i}" value="${esc(st.name||"")}" placeholder="اسم الطالبة">
                  <span class="pv" data-pv="name" data-i="${i}">${esc(st.name||"")}</span>
                </td>

                <td class="gcol">
                  <input class="inline" data-yw="p1Task" data-max="40" data-i="${i}" value="${esc(st.yearwork.p1Task||"")}">
                  <span class="pv" data-pv="p1Task" data-i="${i}">${esc(st.yearwork.p1Task||"")}</span>
                </td>

                <td class="gcol">
                  <input class="inline" data-yw="p1Quiz" data-max="20" data-i="${i}" value="${esc(st.yearwork.p1Quiz||"")}">
                  <span class="pv" data-pv="p1Quiz" data-i="${i}">${esc(st.yearwork.p1Quiz||"")}</span>
                </td>

                <td class="tot gcol"><b data-out="p1" data-i="${i}">${t.p1.toFixed(0)}</b></td>

                <td class="gcol">
                  <input class="inline" data-yw="p2Task" data-max="40" data-i="${i}" value="${esc(st.yearwork.p2Task||"")}">
                  <span class="pv" data-pv="p2Task" data-i="${i}">${esc(st.yearwork.p2Task||"")}</span>
                </td>

                <td class="gcol">
                  <input class="inline" data-yw="p2Quiz" data-max="20" data-i="${i}" value="${esc(st.yearwork.p2Quiz||"")}">
                  <span class="pv" data-pv="p2Quiz" data-i="${i}">${esc(st.yearwork.p2Quiz||"")}</span>
                </td>

                <td class="tot gcol"><b data-out="p2" data-i="${i}">${t.p2.toFixed(0)}</b></td>

                <td class="tot gcol"><b data-out="sum" data-i="${i}">${t.sum.toFixed(0)}</b></td>
                <td class="tot gcol"><b data-out="avg" data-i="${i}">${t.avg.toFixed(1)}</b></td>

                <td class="gcol">
                  <input class="inline" data-yw="final" data-max="40" data-i="${i}" value="${esc(st.yearwork.final||"")}">
                  <span class="pv" data-pv="final" data-i="${i}">${esc(st.yearwork.final||"")}</span>
                </td>

                <td class="tot gcol"><b data-out="total" data-i="${i}">${t.total.toFixed(0)}</b></td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    </div>
  `;
  return wrap;
}

/* ===== الخطط (مهارات متعددة) ===== */
function renderPlans(rec){
  const wrap=document.createElement("div");
  wrap.className="p";
  rec.plans ||= { entries: [] };
  const rows = rec.plans.entries;

  wrap.innerHTML = `
    <div class="noPrint">
      <div class="btns" style="margin-bottom:10px">
        <button class="secondary" id="btnAddPlan">إضافة صف</button>
      </div>

      <div class="wrapX">
        <table>
          <thead>
            <tr>
              <th class="tot" style="width:40px">م</th>
              <th class="tot" style="width:120px">التاريخ</th>
              <th class="tot" style="width:280px">اسم الطالبة (ثلاثي)</th>
              <th class="tot" style="width:360px">المهارات (متعددة)</th>
              <th class="tot" style="width:110px">نوع الخطة</th>
              <th class="tot" style="width:160px">الإجراء</th>
              <th class="tot" style="width:120px">قبلي</th>
              <th class="tot" style="width:120px">بعدي</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map((r,i)=>{
              r.skills ||= [];
              return `
                <tr>
                  <td class="tot">${i+1}</td>
                  <td><input class="inline" type="date" data-plan="date" data-i="${i}" value="${esc(r.date||rec.date||"")}"></td>
                  <td><input class="inline name" data-plan="studentFullName" data-i="${i}" value="${esc(r.studentFullName||"")}" placeholder="اسم الطالبة الثلاثي"></td>

                  <td style="text-align:right">
                    <div style="display:grid; gap:6px">
                      <div style="display:flex; gap:6px; align-items:center">
                        <input class="inline" id="skillInput_${i}" placeholder="اكتبي مهارة ثم اضغطي إضافة">
                        <button class="secondary" type="button" data-addskill="${i}" style="padding:8px 10px;border-radius:10px">إضافة</button>
                      </div>
                      <textarea class="inline" style="border:1px solid var(--b);border-radius:12px;min-height:60px;padding:8px" data-plan="skillsText" data-i="${i}" placeholder="المهارات (كل مهارة بسطر)">${esc((r.skills||[]).join("\n"))}</textarea>
                    </div>
                  </td>

                  <td>
                    <select class="inline" data-plan="type" data-i="${i}">
                      <option ${r.type==="علاجية"?"selected":""} value="علاجية">علاجية</option>
                      <option ${r.type==="إثرائية"?"selected":""} value="إثرائية">إثرائية</option>
                    </select>
                  </td>

                  <td><input class="inline" data-plan="action" data-i="${i}" value="${esc(r.action||"")}"></td>

                  <td><input class="inline" data-plan="pre" data-i="${i}" value="${esc(r.pre||"")}"></td>
                  <td><input class="inline" data-plan="post" data-i="${i}" value="${esc(r.post||"")}"></td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>
    </div>

    <div class="printOnly">
      <table>
        <thead>
          <tr>
            <th class="tot" style="width:34px">م</th>
            <th class="tot" style="width:220px">اسم الطالبة</th>
            <th class="tot">المهارات</th>
            <th class="tot" style="width:90px">نوع</th>
            <th class="tot" style="width:140px">إجراء</th>
            <th class="tot" style="width:90px">قبلي</th>
            <th class="tot" style="width:90px">بعدي</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map((r,i)=>`
            <tr>
              <td class="tot">${i+1}</td>
              <td style="text-align:right">${esc(r.studentFullName||"")}</td>
              <td style="text-align:right">${esc((r.skills||[]).join("، "))}</td>
              <td>${esc(r.type||"")}</td>
              <td style="text-align:right">${esc(r.action||"")}</td>
              <td>${esc(r.pre||"")}</td>
              <td>${esc(r.post||"")}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
  return wrap;
}

/* ===================== WIRE EVENTS ===================== */
function refreshYearworkRow(rec,i){
  const st=rec.students[i]; if(!st) return;
  const t=ywCalc(st);
  const set=(k,v)=>{ const el=document.querySelector(`[data-out="${k}"][data-i="${i}"]`); if(el) el.textContent=v; };
  set("p1",t.p1.toFixed(0)); set("p2",t.p2.toFixed(0)); set("sum",t.sum.toFixed(0));
  set("avg",t.avg.toFixed(1)); set("total",t.total.toFixed(0));

  const pvSet=(k,v)=>{ const el=document.querySelector(`[data-pv="${k}"][data-i="${i}"]`); if(el) el.textContent=(v??"").toString(); };
  pvSet("name", st.name||"");
  pvSet("p1Task", st.yearwork.p1Task||"");
  pvSet("p1Quiz", st.yearwork.p1Quiz||"");
  pvSet("p2Task", st.yearwork.p2Task||"");
  pvSet("p2Quiz", st.yearwork.p2Quiz||"");
  pvSet("final", st.yearwork.final||"");
}

function wire(rec){
  // signatures
  const t=$("sigTeacher"), rv=$("sigReviewer"), pr=$("sigPrincipal");
  if(t) t.oninput=()=>{ rec.signatures.teacherName=t.value; $("pvTeacher").textContent=t.value; saveAll(); };
  if(rv) rv.oninput=()=>{ rec.signatures.reviewerName=rv.value; $("pvReviewer").textContent=rv.value; saveAll(); };
  if(pr) pr.oninput=()=>{ rec.signatures.principalName=pr.value; $("pvPrincipal").textContent=pr.value; saveAll(); };

  // names
  document.querySelectorAll("[data-st='name']").forEach(inp=>{
    inp.oninput=()=>{
      const i=+inp.dataset.i;
      rec.students[i].name=inp.value;
      saveAll();
      refreshYearworkRow(rec,i);
      $("countHint").textContent = `عدد الطالبات: ${(rec.students||[]).length}`;
    };
  });

  // yearwork inputs
  document.querySelectorAll("[data-yw]").forEach(inp=>{
    inp.oninput=()=>{
      const i=+inp.dataset.i, key=inp.dataset.yw;
      rec.students[i].yearwork[key]=inp.value;
      saveAll();
      refreshYearworkRow(rec,i);
    };
    inp.onblur=()=>{
      const i=+inp.dataset.i, key=inp.dataset.yw;
      const max=parseInt(inp.dataset.max||"9999",10);
      const cleaned=clamp(inp.value,max);
      inp.value=cleaned;
      rec.students[i].yearwork[key]=cleaned;
      saveAll();
      refreshYearworkRow(rec,i);
    };
  });

  // yearwork fill
  document.querySelectorAll("[data-fill]").forEach(btn=>{
    btn.onclick=()=>{
      const key=btn.dataset.fill;
      const max = key==="p1Task"||key==="p2Task" ? 40 : key==="p1Quiz"||key==="p2Quiz" ? 20 : 40;
      const box = document.getElementById("fill_"+key);
      const cleaned=clamp(box.value,max);
      if(cleaned==="") return;
      rec.students.forEach((s,idx)=>{
        s.yearwork[key]=cleaned;
        refreshYearworkRow(rec,idx);
      });
      saveAll();
    };
  });

  // plans
  document.querySelectorAll("[data-plan]").forEach(el=>{
    const k=el.dataset.plan, i=+el.dataset.i;
    el.oninput=()=>{
      if(k==="skillsText"){
        const arr = (el.value||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
        rec.plans.entries[i].skills = [...new Set(arr)];
      }else{
        rec.plans.entries[i][k]=el.value;
      }
      saveAll();
    };
  });
  document.querySelectorAll("[data-addskill]").forEach(btn=>{
    btn.onclick=()=>{
      const i=+btn.dataset.addskill;
      const inp=document.getElementById("skillInput_"+i);
      const v=(inp.value||"").trim();
      if(!v) return;
      rec.plans.entries[i].skills ||= [];
      rec.plans.entries[i].skills.push(v);
      rec.plans.entries[i].skills = [...new Set(rec.plans.entries[i].skills)];
      const ta = document.querySelector(`[data-plan="skillsText"][data-i="${i}"]`);
      if(ta) ta.value = rec.plans.entries[i].skills.join("\n");
      inp.value="";
      saveAll();
    };
  });

  // Refresh yearwork rows if needed
  if(rec.formType==="yearwork"){
    rec.students.forEach((_,i)=>refreshYearworkRow(rec,i));
  }
}

/* ===================== MAIN EVENTS ===================== */
function attach(){
  syncTeacherSelect();

  $("teacherSelect").onchange=async ()=>{
    const newKey = $("teacherSelect").value;
    // نغيّر المستخدم عبر hash لتفادي 404
    location.href = location.origin + location.pathname + `#user=${encodeURIComponent(newKey)}`;
  };

  $("btnSwitch").onclick=()=>{ $("teacherSelect").focus(); };
  $("btnLock").onclick=()=>ensurePinGate_();

  $("recordSelect").onchange=()=>{
    state.activeId = $("recordSelect").value;
    saveAll();
    const rec=active();
    syncForm(rec);
    render();
  };

  $("btnNew").onclick=()=>{
    const r=defaultRecord();
    // ضع اسم المعلمة تلقائياً
    const t = TEACHERS.find(x=>x.key===USER);
    r.signatures.teacherName = t ? t.name : "";
    state.records.push(r);
    state.activeId=r.id;
    saveAll();
    syncRecordSelect();
    syncForm(r);
    render();
  };

  $("btnDup").onclick=()=>{
    const rec=active(); if(!rec) return;
    const c=JSON.parse(JSON.stringify(rec));
    c.id=uid(); c.title=(rec.title||"سجل")+" (نسخة)";
    state.records.push(c);
    state.activeId=c.id;
    saveAll();
    syncRecordSelect();
    syncForm(c);
    render();
  };

  $("btnDel").onclick=()=>{
    const rec=active(); if(!rec) return;
    if(!confirm("تأكيد حذف السجل؟")) return;
    state.records = state.records.filter(x=>x.id!==rec.id);
    state.activeId = state.records[0]?.id || null;
    if(!state.records.length){
      const r=defaultRecord(); state.records=[r]; state.activeId=r.id;
    }
    saveAll();
    syncRecordSelect();
    syncForm(active());
    render();
  };

  $("btnRename").onclick=()=>{ $("title").focus(); $("title").select(); };

  $("btnSaveNow").onclick=()=>cloudSave();

  $("formType").onchange=()=>{ const r=active(); r.formType=$("formType").value; saveAll(); render(); };

  $("school").oninput=()=>{ const r=active(); r.school=$("school").value; saveAll(); render(); };
  $("classroom").oninput=()=>{ const r=active(); r.classroom=$("classroom").value; saveAll(); render(); };
  $("date").onchange=()=>{ const r=active(); r.date=$("date").value; saveAll(); render(); };
  $("termAr").onchange=()=>{ const r=active(); r.termAr=$("termAr").value; saveAll(); render(); };
  $("yearAr").oninput=()=>{ const r=active(); r.academicYearAr=$("yearAr").value; saveAll(); render(); };

  $("title").oninput=()=>{ const r=active(); r.title=$("title").value; saveAll(); syncRecordSelect(); };

  $("btnApplyNames").onclick=()=>{
    const r=active();
    const names = $("namesPaste").value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    r.students = names.map(n=>defaultStudent(n));
    saveAll();
    syncForm(r);
    render();
  };

  $("btnAddStudent").onclick=()=>{
    const r=active();
    r.students.push(defaultStudent(""));
    saveAll();
    syncForm(r);
    render();
  };

  $("btnCloudReload").onclick=async ()=>{
    await cloudLoad();
    if(!state.records?.length){
      const r=defaultRecord(); state.records=[r]; state.activeId=r.id;
    }
    syncRecordSelect();
    syncForm(active());
    render();
    await ensurePinGate_();
  };

  $("btnPrint").onclick=()=>window.print();

  $("btnPDF").onclick=async ()=>{
    const btn=$("btnPDF");
    btn.disabled=true; btn.textContent="جاري PDF…";
    try{
      document.body.classList.add("forcePrint");
      const area=$("printArea");
      const canvas = await html2canvas(area, {scale:2, useCORS:true, backgroundColor:"#ffffff"});
      const img = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({orientation:"landscape", unit:"mm", format:"a4"});
      const w = pdf.internal.pageSize.getWidth();
      const h = pdf.internal.pageSize.getHeight();
      const imgW = w;
      const imgH = canvas.height * imgW / canvas.width;

      let y=0, remaining=imgH;
      while(remaining>0){
        pdf.addImage(img,"PNG",0,y,imgW,imgH);
        remaining -= h;
        if(remaining>0){ pdf.addPage(); y -= h; }
      }
      const rec=active();
      const name=(rec?.title||"سجل").replace(/[\\/:*?"<>|]/g,"-") + ".pdf";
      pdf.save(name);
    }finally{
      document.body.classList.remove("forcePrint");
      btn.disabled=false; btn.textContent="حفظ PDF";
    }
  };

  // PIN events
  $("pinBtn").onclick=()=>handlePinSubmit_();
  $("pinInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") handlePinSubmit_(); });
  $("pinSetBtn").onclick=()=>showPin_("set");
  $("pinChangeBtn").onclick=()=>showPin_("change");
}

/* ===================== INIT ===================== */
(async function init(){
  // إعداد قائمة المعلمات
  syncTeacherSelect();

  // حمل محلي أولاً
  loadLocal();

  // إذا لا توجد سجلات محلياً، أنشئ سجل افتراضي
  if(!state.records || !state.records.length){
    const r=defaultRecord();
    const t = TEACHERS.find(x=>x.key===USER);
    r.signatures.teacherName = t ? t.name : "";
    state.records=[r];
    state.activeId=r.id;
    saveLocal();
  }

  // واجهة
  attach();
  syncRecordSelect();
  syncForm(active());
  render();

  // زيارات + تحميل سحابة
  await cloudVisit();
  await cloudLoad();

  // بعد تحميل السحابة: تأكد من وجود سجلات
  if(!state.records || !state.records.length){
    const r=defaultRecord();
    const t = TEACHERS.find(x=>x.key===USER);
    r.signatures.teacherName = t ? t.name : "";
    state.records=[r];
    state.activeId=r.id;
  }

  syncRecordSelect();
  syncForm(active());
  render();

  // قفل المعلمة
  await ensurePinGate_();

})();
</script>
</body>
</html>
