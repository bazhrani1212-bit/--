<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>استمارات الرصد التفاعلية</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- PDF -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- OCR عربي (اختياري) لاستيراد أسماء من صورة -->
  <script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#0ea5e9;

      --p1:#e9f5e9;
      --p2:#eaf1ff;
      --sum:#fdebdc;
      --avg:#fff6cf;
      --final:#ffd7dc;
      --total:#efefef;

      --ok:#16a34a;
      --bad:#ef4444;
      --neu:#9ca3af;

      --c-part:#c59a00;
      --c-home:#2aa7df;
      --c-perf:#7b8ea6;
      --c-class:#a8d18d;
    }

    *{box-sizing:border-box}
    html, body{width:100%; max-width:100%; overflow-x:hidden;}
    body{
      margin:0;
      font-family:"Cairo", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg);
    }

    header{
      padding:18px 16px 10px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title{
      display:flex; gap:10px; align-items:center;
    }
    .badge{
      width:44px; height:44px; border-radius:12px;
      background:linear-gradient(135deg,#22c55e,#0ea5e9);
      display:grid; place-items:center;
      color:white; font-weight:900;
      flex:0 0 auto;
    }
    h1{margin:0; font-size:18px}
    .sub{color:var(--muted); font-size:12px; margin-top:2px}

    .top-actions{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      max-width:100%;
    }

    button, .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-family:inherit;
      font-weight:800;
      font-size:13px;
    }
    button.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:white;
    }
    button.danger{
      background:#ef4444;
      border-color:#ef4444;
      color:white;
    }
    button:disabled{opacity:.6; cursor:not-allowed}

    main{
      padding:0 16px 18px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:12px;
      max-width:100%;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 1px 0 rgba(17,24,39,.04);
      max-width:100%;
    }
    .card-hd{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .card-hd .hd-title{
      font-weight:900;
      font-size:14px;
    }
    .card-bd{padding:12px}

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:800;
    }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      font-family:inherit;
      font-size:13px;
      background:#fff;
      outline:none;
      max-width:100%;
    }
    textarea{min-height:88px; resize:vertical}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    @media (max-width: 980px){
      .row,.row3{grid-template-columns:1fr}
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.6;
    }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      max-width:100%;
    }
    .dot{width:10px;height:10px;border-radius:50%;}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .dot.neu{background:#f59e0b}

    #printArea{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      max-width:100%;
    }

    .form-header{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .form-header h2{
      margin:0;
      font-size:16px;
      font-weight:900;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      max-width:100%;
    }
    .meta .kv{
      border:1px solid var(--line);
      border-radius:10px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      background:#fff;
      font-weight:900;
      white-space:nowrap;
      max-width:100%;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      table-layout:fixed;
    }
    th, td{
      border:1px solid #111;
      padding:6px 6px;
      text-align:center;
      vertical-align:middle;
      white-space:normal;
      word-break:break-word;
    }
    th{font-weight:900}
    .p1{background:var(--p1)}
    .p2{background:var(--p2)}
    .sum{background:var(--sum)}
    .avg{background:var(--avg)}
    .final{background:var(--final)}
    .total{background:var(--total)}
    .namecell{text-align:right; font-weight:900}

    .inline-input{
      width:100%;
      padding:6px 6px;
      border:1px solid #000;
      border-radius:6px;
      font-family:inherit;
      font-size:12px;
      text-align:center;
      background:#fff;
      max-width:100%;
    }
    .inline-input.name{text-align:right;font-weight:900}

    /* بدون أسهم */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    .footer-note{
      padding:10px 14px 14px;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }

    .status{
      font-size:12px;
      color:var(--muted);
      line-height:1.6;
      margin-top:8px;
      padding:8px 10px;
      border:1px dashed var(--line);
      border-radius:10px;
      background:#fafafa;
    }

    /* كروت للهواتف */
    @media (max-width: 820px){
      .grades-table-desktop{display:none !important;}
      .grades-cards-mobile{display:block !important;}
      .monthly-table-desktop{display:none !important;}
      .monthly-cards-mobile{display:block !important;}
    }
    @media (min-width: 821px){
      .grades-table-desktop{display:block !important;}
      .grades-cards-mobile{display:none !important;}
      .monthly-table-desktop{display:block !important;}
      .monthly-cards-mobile{display:none !important;}
    }

    .student-card{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      margin:10px 12px;
      background:#fff;
    }
    .student-card .head{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .student-card .idx{
      font-weight:900;
      color:var(--muted);
      font-size:12px;
    }
    .student-card .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    .student-card .field{
      border:1px solid var(--line);
      border-radius:10px;
      padding:8px;
      background:#fafafa;
      text-align:right;
    }
    .student-card .field b{
      display:block;
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
    }

    /* مربعات صح/خطأ */
    .mark-btn{
      width:26px;height:26px;
      border-radius:6px;
      border:1px solid #111;
      display:inline-grid;
      place-items:center;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      background:#fff;
      font-size:14px;
      padding:0;
    }
    .mark-btn.ok{background:#dcfce7; border-color:#16a34a; color:#14532d}
    .mark-btn.bad{background:#fee2e2; border-color:#ef4444; color:#7f1d1d}
    .mark-btn.neu{background:#fff; border-color:#111; color:#111}

    .crit-h.part{background:color-mix(in oklab, var(--c-part) 30%, white)}
    .crit-h.home{background:color-mix(in oklab, var(--c-home) 30%, white)}
    .crit-h.perf{background:color-mix(in oklab, var(--c-perf) 30%, white)}
    .crit-h.class{background:color-mix(in oklab, var(--c-class) 30%, white)}

    .mini-title{
      font-weight:900;
      margin:0 12px 6px;
      color:#111;
      font-size:13px;
    }

    /* طباعة */
    @media print{
      body{background:#fff}
      header, .card.left, .top-actions, .no-print{display:none !important}
      main{display:block; padding:0}
      #printArea{border:none !important;border-radius:0 !important;}
      @page{ size: A4 landscape; margin: 10mm; }
      table{font-size:10.5px}
      .mark-btn{width:22px;height:22px;font-size:12px}
    }
  </style>
</head>

<body>
<header>
  <div class="title">
    <div class="badge">✓</div>
    <div>
      <h1>استمارات الرصد التفاعلية</h1>
      <div class="sub">حفظ سحابي (Google Sheet) + طباعة + PDF + متابعة شهرية (صح/خطأ) + مهارات تفاعلية</div>
    </div>
  </div>

  <div class="top-actions no-print">
    <span class="pill" id="cloudPill"><span class="dot neu"></span> سحابي: …</span>
    <span class="pill" id="globalPill">زيارات عالمية: …</span>
    <span class="pill" id="visitPill">زيارات الجهاز: …</span>
    <span class="pill" id="userPill">مستخدم: …</span>
    <button class="btn" id="btnCloudReload">استرجاع من السحابة الآن</button>
    <button class="btn" id="btnExportJSON">تصدير بيانات (JSON)</button>
    <button class="btn" id="btnImportJSON">استيراد بيانات (JSON)</button>
    <input id="jsonFile" type="file" accept="application/json" hidden />
    <button class="danger" id="btnReset">تصفير البيانات (محليًا فقط)</button>
  </div>
</header>

<main>
  <!-- يسار -->
  <section class="card left">
    <div class="card-hd">
      <div class="hd-title">الإعدادات</div>
      <span class="pill" id="autosavePill">حفظ تلقائي: يعمل</span>
    </div>
    <div class="card-bd">
      <div class="row">
        <div>
          <label>نوع الاستمارة</label>
          <select id="formType">
            <option value="grades">سجل درجات مادة …</option>
            <option value="monthly">كشف متابعة شهري (صح/خطأ)</option>
            <option value="plans">متابعة الخطط العلاجية والإثرائية</option>
            <option value="counselor">تحويل للموجهة الطلابية</option>
            <option value="principal">تحويل للمديرة</option>
            <option value="parent">تبليغ لولي الأمر</option>
          </select>
        </div>
        <div>
          <label>المادة / العنوان</label>
          <input id="subject" placeholder="مثال: علوم - سادس" />
        </div>
      </div>

      <div class="row3" style="margin-top:10px">
        <div>
          <label>المدرسة</label>
          <input id="school" placeholder="اسم المدرسة" />
        </div>
        <div>
          <label>الصف / الشعبة</label>
          <input id="classroom" placeholder="مثال: سادس/أ" />
        </div>
        <div>
          <label>التاريخ</label>
          <input id="date" type="date" />
        </div>
      </div>

      <div class="status" id="cloudStatus">
        <b>الحفظ السحابي:</b> يتم حفظ البيانات على Google Sheet تلقائيًا — وتبقى محفوظة حتى بعد سنة وأكثر.
        <br><b>تعدد المستخدمين:</b> افتحي الرابط مع ?user=اسم_المستخدمة (مثل: ?user=معلمة_نورة).
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0">

      <div class="card-hd" style="padding:0 0 10px;border:0">
        <div class="hd-title">أسماء الطالبات</div>
      </div>

      <div class="row">
        <div>
          <label>استيراد CSV (عمود أسماء)</label>
          <input id="csvFile" type="file" accept=".csv,text/csv" />
          <div class="hint">الاسم في أول عمود أو عمود واحد فقط.</div>
        </div>
        <div>
          <label>استيراد من صورة (ألبوم الكاميرا)</label>
          <input id="imgFile" type="file" accept="image/*" />
          <div class="hint">OCR عربي (الدقة تعتمد على وضوح الصورة).</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>أو الصقي الأسماء (كل اسم في سطر)</label>
        <textarea id="namesPaste" placeholder="سارة محمد&#10;ريم عبدالله"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="primary" id="btnApplyNames">تطبيق الأسماء</button>
          <button id="btnAddRow">إضافة طالبة</button>
        </div>
      </div>

      <div class="hint" id="namesCountHint">عدد الطالبات: 0</div>
    </div>
  </section>

  <!-- يمين -->
  <section class="card">
    <div class="card-hd no-print">
      <div class="hd-title">معاينة الاستمارة</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnPrint">طباعة</button>
        <button class="primary" id="btnPDF">تصدير PDF</button>
      </div>
    </div>

    <div id="printArea"></div>
  </section>
</main>

<script>
/* =========================
   Google Sheet Web App
   ========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxMZOvfhuzGY3Unz2jqyFVfSLkvN5xQKxuXyOqpUV9hkdcokD4vxjjDxjZtqkoWzvir/exec";
const APP_TOKEN = ""; // إذا سكربتك يطلب توكن اكتبيه هنا

/* =========================
   تعدد المستخدمين: ?user=
   ========================= */
function getUserKey(){
  const params = new URLSearchParams(location.search);
  const u = (params.get("user") || "default").trim();
  return u ? u : "default";
}
const USER_KEY = getUserKey();
const STORAGE_KEY = "irs_v5_" + USER_KEY;

/* =========================
   State
   ========================= */
const state = {
  formType: "grades",
  subject: "",
  school: "",
  classroom: "",
  date: "",
  students: [],

  // كشف متابعة شهري (صح/خطأ)
  monthly: {
    year: new Date().getFullYear(),
    month: (new Date().getMonth()+1),
    term: "",
    academicYear: "1446هـ",
    // نفس أعمدة الصورة (قابلة لتعديلك)
    criteria: [
      {key:"participation", label:"المشاركة", cls:"part"},
      {key:"homework", label:"الواجبات", cls:"home"},
      {key:"performance", label:"المهام الأدائية", cls:"perf"},
      {key:"classwork", label:"أنشطة صفية", cls:"class"}
    ],
    weeks: 5, // شهري (5 أسابيع افتراضي)
    // البيانات ستخزن لكل طالبة داخل students.monthlyMarks
  },

  // خطط علاجية/إثرائية
  plans: { entries: [] },

  referral: { studentName:"", reason:"", details:"", teacher:"", receiver:"", actions:"", notes:"" },
  parent: { studentName:"", parentName:"", parentPhone:"", message:"", teacher:"", notes:"" }
};

/* =========================
   درجات (حسب نموذجك)
   ========================= */
const GRADES_SCHEMA = { p1A: 40, p1B: 20, p2A: 40, p2B: 20, final: 40 };

/* =========================
   تقييم وصفي (للخطط)
   ========================= */
const EVAL_LEVELS = [
  "متفوق",
  "تحسن بتفوق",
  "جيد",
  "جيد ويحتاج متابعة",
  "يحتاج متابعة",
  "ضعيف",
  "ضعيف جدًا"
];

const EVAL_RANK = {
  "متفوق": 6,
  "تحسن بتفوق": 5,
  "جيد": 4,
  "جيد ويحتاج متابعة": 3,
  "يحتاج متابعة": 2,
  "ضعيف": 1,
  "ضعيف جدًا": 0
};

function normalizeEval(v){
  const s = (v || "").toString().trim();
  return EVAL_LEVELS.includes(s) ? s : "يحتاج متابعة";
}
function getChangeLabel(pre, post){
  const a = EVAL_RANK[normalizeEval(pre)];
  const b = EVAL_RANK[normalizeEval(post)];
  if(b > a) return {text:"تحسن ✅", cls:"ok"};
  if(b < a) return {text:"تراجع ⚠️", cls:"bad"};
  return {text:"ثابت ➖", cls:"warn"};
}

/* =========================
   مهارات من ملفاتك (علوم للصف 3/5/6) — مضافة تفاعليًا
   ========================= */
const SCI_SKILLS_FROM_FILES = {
  3: ["تطبيق الطريقة العلمية التي يستخدمها العلماء بصورة مبسطة في تعلم العلوم ..","تعداد خصائص المخلوقات الحية","استنتاج حاجات المخلوقات الحية .","تفسير مفهوم دورة الحياة.","تعداد مراحل دورة الحياة في الحيوان والنبات","استنتاج العلاقة بين التكاثر وبقاء النوع","ذكر أنواع التكاثر في المخلوقات الحية","ذكر خصائص كل من التكاثر الجنسي واللاجنسي","تفسير كيف يكون التكاثر اللاجنسي في الهيدرا والنجم.","ذكر مفهوم الإخصاب في التكاثر الجنسي","تحديد أجزاء الزهرة ووظيفة كل جزء منها","تفسير كيفية حدوث الإخصاب في الأزهار","توضيح معنى التلقيح مع ذكر أهم طرقه","توضيح مفهوم الثمرة وكيف تتكون","ذكر مفهوم البذرة وكيف تتكون","تفسير ما معنى الإنبات","ذكر العوامل اللازمة للإنبات","تفسير ما المقصود بعملية البناء الضوئي","تحديد مكان حدوث البناء الضوئي في النبات","توضيح مفهوم التنفس الخلوي","المقارنة بين البناء الضوئي والتنفس الخلوي","توضيح مفهوم الغذاء في المخلوقات الحية","توضيح مفهوم السلسلة الغذائية","ترتيب مكونات السلسلة الغذائية","توضيح مفهوم الشبكة الغذائية","شرح مفهوم المستهلك والمنتج والمحلل في النظام البيئي","توضيح مفهوم الجماعة الحيوية والمجتمع الحيوي","تفسير مفهوم التكيف في المخلوقات الحية","ذكر أنواع التكيف في المخلوقات الحية","توضيح كيف تتكيف الحيوانات والنباتات للبقاء","توضيح مفهوم السلوك في المخلوقات الحية","توضيح مفهوم الغريزة في السلوك","تفسير مفهوم تعلم السلوك","ذكر أنواع السلوك المكتسب","توضيح مفهوم الهجرة في السلوك","توضيح مفهوم السبات في السلوك","توضيح مفهوم التضاد في السلوك","تفسير مفهوم التنافس في السلوك","توضيح مفهوم الافتراس في السلوك","تفسير مفهوم التمويه في السلوك","استنتاج الفرق بين دورة حياة الضفدع والجمل من خلال قراءة مجموعة من الرسوم التوضيحية ."],
  5: ["ممارسة الطريقة العلمية التي يتبعها العلماء في دراسة العلوم بصورة مبسطة ..","تعداد الممالك الست في المخلوقات الحية مع رسم مخطط مبسط لإحدى الممالك","تعداد أقسام النبات في المملكة النباتية","تعداد خصائص النباتات الوعائية واللاوعائية","تعداد خصائص النباتات الوعائية البذرية واللا بذرية","توضيح مفهوم البذرة وأهميتها","تحديد أجزاء البذرة ووظيفة كل جزء","تفسير مفهوم الإنبات","تحديد العوامل اللازمة للإنبات","توضيح مفهوم التبرعم","توضيح مفهوم التطعيم","توضيح مفهوم التركيب الضوئي","تفسير مفهوم التمثيل الضوئي","تحديد العوامل اللازمة لحدوث التمثيل الضوئي","تفسير مفهوم التنفس الخلوي","توضيح مفهوم الهرم الغذائي","تحديد مستويات الهرم الغذائي","توضيح مفهوم السلسلة الغذائية","ترتيب مكونات السلسلة الغذائية","توضيح مفهوم الشبكة الغذائية","توضيح مفهوم التحلل","تفسير مفهوم التحلل الحيوي","توضيح مفهوم البيئة","تحديد العوامل الحيوية واللاحيوية في البيئة","توضيح مفهوم الموارد الطبيعية","توضيح مفهوم الموارد المتجددة والغير متجددة","تفسير مفهوم الوقود الأحفوري","توضيح كيفية تكون الوقود الأحفوري","توضيح مفهوم الطاقة","تحديد أشكال الطاقة","توضيح مفهوم تحول الطاقة","ذكر أمثلة على تحول الطاقة","توضيح مفهوم الحرارة","تفسير مفهوم درجة الحرارة","تفسير مفهوم الموصل والعازل الحراري","توضيح مفهوم الإشعاع الحراري","توضيح مفهوم الحمل الحراري","توضيح مفهوم التوصيل الحراري","توضيح مفهوم الانعكاس","توضيح مفهوم الانكسار","تحديد العلاقة بين سرعة الضوء والكثافة","توضيح مفهوم الصوت","توضيح مفهوم طبقة الأوزون وأهميتها","تفسير مفهوم التلوث","توضيح مفهوم التلوث البيئي","ذكر أنواع التلوث","تحديد أثر التلوث على البيئة","توضيح مفهوم إعادة التدوير","ذكر طرق المحافظة على البيئة","توضيح مفهوم الاحتباس الحراري","ذكر أسباب الاحتباس الحراري"],
  6: ["ممارسة الطريقة العلمية التي يستخدمها العلماء في دراسة العلوم بصورة مبسطة ..","ذكر مفهوم النظرية الخلوية","توضيح أن الخلية هي وحدة البناء والوظيفة في المخلوقات الحية","رسم مخطط يوضح تسلسل مستويات التنظيم في المخلوقات الحية","ذكر بعض المركبات الموجودة في خلايا المخلوقات الحية ووظائفها","المقارنة بين الخلية النباتية والخلية الحيوانية","تحديد وظيفة كل عضو من أعضاء الخلية","توضيح مفهوم الانتشار والتناضح","تحديد الفرق بين النقل السلبي والنقل النشط ..","توضيح مفهوم البناء الضوئي","توضيح مفهوم التنفس الخلوي","التمييز بين عمليتي البناء الضوئي والتنفس الخلوي","تلخيص دورة حياة الخلية","تعداد أنواع الانقسام في الخلية","المقارنة بين الانقسام المنصف والانقسام المتساوي","معرفة مفهوم الوراثة","توضيح مفهوم الصفة الوراثية","توضيح مفهوم الجين","توضيح مفهوم الكروموسوم","توضيح مفهوم الطفرة","توضيح مفهوم التكيف","تفسير مفهوم الانتخاب الطبيعي","توضيح مفهوم التنوع الحيوي","ذكر مفهوم الانقراض","توضيح مفهوم الجماعة الحيوية","توضيح مفهوم المجتمع الحيوي","توضيح مفهوم النظام البيئي","تحديد العوامل الحيوية واللاحيوية في النظام البيئي","توضيح مفهوم السلسلة الغذائية","ترتيب مكونات السلسلة الغذائية","توضيح مفهوم الشبكة الغذائية","ذكر مفهوم الهرم الغذائي","توضيح مفهوم الموارد الطبيعية","توضيح مفهوم الموارد المتجددة والغير متجددة","تفسير مفهوم الوقود الأحفوري","توضيح كيفية تكون الوقود الأحفوري","ذكر مفهوم الطاقة","تحديد أشكال الطاقة","توضيح مفهوم تحول الطاقة","ذكر أمثلة على تحول الطاقة","توضيح مفهوم الكهرباء","توضيح مفهوم الدائرة الكهربائية","ذكر مكونات الدائرة الكهربائية","تمييز الدوائر الكهربائية (مفتوحة/مغلقة)","توضيح مفهوم الموصل والعازل الكهربائي","توضيح مفهوم المغناطيس","توضيح مفهوم الكواكب","ترتيب كواكب المجموعة الشمسية","توضيح مفهوم الكسوف والخسوف","ذكر مفهوم المد والجزر","تفسير مفهوم الزلازل","تفسير مفهوم البراكين","ذكر طرق السلامة أثناء الزلازل والبراكين"]
};

/* =========================
   مواد + مهارات + إجراءات
   ========================= */
const SUBJECTS = ["لغتي","رياضيات","علوم","إنجليزي","إسلامية","اجتماعيات"];
const PROCEDURES = ["ورقة عمل مركزة","تعليم فردي (1:1)","مجموعة علاجية صغيرة","مجموعة إثرائية","تعلم بالأقران","لعبة تعليمية رقمية","واجب علاجي منزلي","نشاط عملي/تجربة","بطاقات/شفهي","اختبار قصير"];

const SKILLS_MAP_FALLBACK = {
  1: { "لغتي":["تمييز الحروف","قراءة كلمات","كتابة كلمات","فهم جملة"], "رياضيات":["العد","المقارنة","جمع ضمن 20","طرح ضمن 20"], "علوم":["الحواس","احتياجات الكائن","حي/غير حي","الطقس"], "إنجليزي":["حروف","مفردات","جملة","مطابقة"], "إسلامية":["آداب","سور قصيرة","وضوء","صلاة"], "اجتماعيات":["الأسرة","المدرسة","المجتمع","رموز وطنية"] },
  2: { "لغتي":["قراءة نص","فكرة رئيسة","تجزئة كلمات","إملاء"], "رياضيات":["جمع/طرح 100","قيمة منزلية","قياس","أنماط"], "علوم":["دورات حياة","خصائص المادة","مغناطيس","البيئة"], "إنجليزي":["مفردات","مضارع","أسئلة","قراءة جمل"], "إسلامية":["توحيد","آداب","أذكار","صلاة"], "اجتماعيات":["اتجاهات","خريطة","مهن","معالم"] },
  3: { "لغتي":["فكرة رئيسة","ترتيب زمني","ترقيم","فقرة"], "رياضيات":["ضرب","قسمة","كسور","محيط/مساحة"], "علوم":["أنظمة بيئية","تغيرات المادة","قوة/حركة","تكيف"], "إنجليزي":["قراءة فقرة","جمل","محادثة","قواعد"], "إسلامية":["إيمان","طهارة","سور","قيم"], "اجتماعيات":["موارد","مناخ","سكان","خدمات"] },
  4: { "لغتي":["معنى من سياق","تلخيص","أساليب","تقرير"], "رياضيات":["كسور/عشرية","عوامل","زوايا","مساحة"], "علوم":["سلاسل غذائية","أجهزة الجسم","طاقة","كهرباء"], "إنجليزي":["قراءة","فقرة","أزمنة","استماع"], "إسلامية":["عبادات","سيرة","آداب","تجويد"], "اجتماعيات":["مناطق","تاريخ","اقتصاد","تقنية"] },
  5: { "لغتي":["تحليل","تلخيص","مقال","قواعد"], "رياضيات":["نسبة","كسور","بياني","حجوم"], "علوم":["مصادر الطاقة","دورات","احتكاك","مناخ"], "إنجليزي":["استنتاج","كتابة","قواعد","عرض"], "إسلامية":["فقه","تفسير","سيرة","قيم"], "اجتماعيات":["أنظمة","خرائط","جغرافيا","مشروعات"] },
  6: { "لغتي":["فهم عميق","أدلة","تحليل","تقرير/مقال"], "رياضيات":["معادلات","إحصاء","هندسة","نسب مئوية"], "علوم":["خلايا","وراثة","أنظمة بيئية","مادة/طاقة"], "إنجليزي":["قراءة طويلة","كتابة","تحدث","قواعد"], "إسلامية":["تجويد","فقه","عقيدة","سيرة"], "اجتماعيات":["تاريخ","جغرافيا","مواطنة","تنمية"] }
};

function getSkills(grade, subject){
  // أولوية لمهارات علوم من ملفاتك (3/5/6)
  if(subject === "علوم" && SCI_SKILLS_FROM_FILES[grade]){
    return SCI_SKILLS_FROM_FILES[grade];
  }
  const g = SKILLS_MAP_FALLBACK[grade] || {};
  return g[subject] || ["مهارة (أضيفيها حسب حاجتك)"];
}

/* =========================
   Helpers
   ========================= */
const el = (id)=>document.getElementById(id);

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"quot;")
    .replaceAll("'","&#039;");
}

function clampNum(x, max){
  const cleaned = (x ?? "").toString().replace(/[^\d.]/g,"");
  const n = Number(cleaned);
  if(Number.isNaN(n)) return 0;
  return Math.max(0, Math.min(max, n));
}

function arabicMonthName(m){
  const months = ["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];
  return months[(m-1)] || "";
}

/* =========================
   Local Save/Load
   ========================= */
let saveTimer = null;
function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{ Object.assign(state, JSON.parse(raw)); }catch(e){}
}

/* =========================
   Cloud Save/Load
   ========================= */
function setCloudPill(status, ok=null){
  const pill = el("cloudPill");
  let cls = "dot neu";
  if(ok === true) cls = "dot ok";
  if(ok === false) cls = "dot bad";
  pill.innerHTML = `<span class="${cls}"></span> سحابي: ${escapeHtml(status)}`;
}

async function fetchWithTimeout(url, opts={}, timeoutMs=15000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{ return await fetch(url, {...opts, signal: ctrl.signal}); }
  finally{ clearTimeout(t); }
}

async function cloudLoad(){
  try{
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("action","load");
    url.searchParams.set("userKey", USER_KEY);
    url.searchParams.set("token", APP_TOKEN);
    const res = await fetchWithTimeout(url.toString(), {method:"GET"});
    const data = await res.json();

    if(data.ok && data.found && data.state){
      Object.assign(state, data.state);
      setCloudPill("متصل ✓ (تم التحميل)", true);
      saveLocal();
      syncInputs();
      render();
    }else if(data.ok){
      setCloudPill("متصل ✓ (لا يوجد بيانات بعد)", true);
    }else{
      setCloudPill("مشكلة توكن/صلاحية", false);
    }
  }catch(e){
    setCloudPill("غير متصل (سيعمل محليًا)", false);
  }
}

function cloudSaveDebounced(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>cloudSave(), 900);
}

async function cloudSave(){
  try{
    const payload = { action:"save", token: APP_TOKEN, userKey: USER_KEY, state };
    const res = await fetchWithTimeout(SCRIPT_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.ok) setCloudPill("متصل ✓ (تم الحفظ)", true);
    else setCloudPill("رفض/توكن غير صحيح", false);
  }catch(e){
    setCloudPill("انقطاع (تم الحفظ محليًا)", false);
  }
}

async function cloudVisit(){
  try{
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("action","visit");
    url.searchParams.set("userKey", USER_KEY);
    url.searchParams.set("token", APP_TOKEN);
    const res = await fetchWithTimeout(url.toString(), {method:"GET"});
    const data = await res.json();
    el("globalPill").textContent = "زيارات عالمية: " + (data.globalVisits ?? "—");
  }catch(e){
    el("globalPill").textContent = "زيارات عالمية: —";
  }
}

function save(){
  saveLocal();
  cloudSaveDebounced();
}

function bumpLocalVisits(){
  const vk = "irs_visits_" + USER_KEY;
  const v = parseInt(localStorage.getItem(vk) || "0", 10) + 1;
  localStorage.setItem(vk, String(v));
  el("visitPill").textContent = "زيارات الجهاز: " + v;
}
function showUser(){ el("userPill").textContent = "مستخدم: " + USER_KEY; }

/* =========================
   UI Sync
   ========================= */
function syncInputs(){
  el("formType").value = state.formType;
  el("subject").value = state.subject || "";
  el("school").value = state.school || "";
  el("classroom").value = state.classroom || "";
  el("date").value = state.date || "";
  el("namesCountHint").textContent = "عدد الطالبات: " + (state.students?.length || 0);
}

function getFormTitle(){
  switch(state.formType){
    case "grades": return "سجل درجات مادة";
    case "monthly": return "كشف متابعة شهري";
    case "plans": return "متابعة الخطط العلاجية والإثرائية";
    case "counselor": return "نموذج تحويل للموجهة الطلابية";
    case "principal": return "نموذج تحويل للمديرة";
    case "parent": return "تبليغ لولي الأمر";
    default: return "استمارة";
  }
}

function makeFooter(text){
  const f = document.createElement("div");
  f.className = "footer-note";
  f.innerHTML = `<div>${escapeHtml(text)}</div>`;
  return f;
}

/* =========================
   Render
   ========================= */
function render(){
  const area = el("printArea");
  area.innerHTML = "";

  const header = document.createElement("div");
  header.className = "form-header";
  header.innerHTML = `
    <div>
      <h2>${escapeHtml(getFormTitle())}</h2>
      <div class="sub" style="margin-top:4px;color:var(--muted)">
        ${state.subject ? "العنوان/المادة: " + escapeHtml(state.subject) : ""}
      </div>
    </div>
    <div class="meta">
      <div class="kv">المدرسة: ${escapeHtml(state.school || "—")}</div>
      <div class="kv">الصف/الشعبة: ${escapeHtml(state.classroom || "—")}</div>
      <div class="kv">التاريخ: ${escapeHtml(state.date || "—")}</div>
    </div>
  `;
  area.appendChild(header);

  if(state.formType === "grades"){
    area.appendChild(renderGradesForm());
    area.appendChild(makeFooter("سجل الدرجات: إدخال تفاعلي + بدون أسهم + حفظ سحابي."));
  }else if(state.formType === "monthly"){
    area.appendChild(renderMonthlyFollowup());
    area.appendChild(makeFooter("كشف متابعة شهري: اضغطي على كل مربع للتبديل بين (صح ✅) و(خطأ ❌)."));
  }else if(state.formType === "plans"){
    area.appendChild(renderPlansForm());
    area.appendChild(makeFooter("الخطط العلاجية/الإثرائية: مهارات تفاعلية (علوم للصف 3/5/6 من ملفاتك) + قبلي/بعدي وصفي."));
  }else if(state.formType === "counselor"){
    area.appendChild(renderReferralForm("الموجهة الطلابية"));
    area.appendChild(makeFooter("تحويل للموجهة الطلابية: نموذج رسمي مبسط قابل للطباعة والتصدير."));
  }else if(state.formType === "principal"){
    area.appendChild(renderReferralForm("المديرة"));
    area.appendChild(makeFooter("تحويل للمديرة: نموذج رسمي مبسط قابل للطباعة والتصدير."));
  }else if(state.formType === "parent"){
    area.appendChild(renderParentNoticeForm());
    area.appendChild(makeFooter("تبليغ لولي الأمر: اكتبي نص الرسالة وسيظهر جاهز للطباعة والتصدير."));
  }

  wireDynamicInputs();
}

/* =========================
   Grades Form (كما سبق)
   ========================= */
function renderGradesForm(){
  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  const bulk = document.createElement("div");
  bulk.className = "no-print";
  bulk.style.border = "1px solid var(--line)";
  bulk.style.borderRadius = "12px";
  bulk.style.padding = "10px";
  bulk.style.marginBottom = "10px";
  bulk.innerHTML = `
    <div style="font-weight:900; margin-bottom:8px;">تعميم درجة على عمود كامل</div>
    <div class="row3">
      <div>
        <label>اختاري العمود</label>
        <select id="bulkCol">
          <option value="p1_a">الفترة الأولى: المهام الأدائية (40)</option>
          <option value="p1_b">الفترة الأولى: تقويمات تحريرية (20)</option>
          <option value="p2_a">الفترة الثانية: المهام الأدائية (40)</option>
          <option value="p2_b">الفترة الثانية: تقويمات تحريرية (20)</option>
          <option value="final">اختبار نهاية الفصل (40)</option>
        </select>
      </div>
      <div>
        <label>اكتبي الدرجة</label>
        <input id="bulkVal" inputmode="numeric" placeholder="مثال: 10" />
      </div>
      <div style="display:flex;align-items:end;gap:8px;">
        <button class="primary" id="btnApplyBulk" style="width:100%;">تطبيق على جميع الطالبات</button>
      </div>
    </div>
    <div class="hint">يستخدم عند رغبتك بتسجيل درجة موحدة لعمود كامل بسرعة.</div>
  `;
  wrap.appendChild(bulk);

  const tableWrap = document.createElement("div");
  tableWrap.className = "grades-table-desktop";

  const table = document.createElement("table");
  table.id = "gradesTable";

  const thead = document.createElement("thead");
  thead.innerHTML = `
    <tr>
      <th rowspan="2" class="total">م</th>
      <th rowspan="2" class="total namecell">اسم الطالبة</th>

      <th colspan="3" class="p1">الفترة الأولى</th>
      <th colspan="3" class="p2">الفترة الثانية</th>

      <th rowspan="2" class="sum">مجموع الفترتين</th>
      <th rowspan="2" class="avg">متوسط مجموع الفترتين</th>
      <th rowspan="2" class="final">اختبار نهاية الفصل</th>
      <th rowspan="2" class="total">المجموع الكلي</th>
    </tr>
    <tr>
      <th class="p1">المهام الأدائية<br><b>(${GRADES_SCHEMA.p1A})</b></th>
      <th class="p1">تقويمات تحريرية<br><b>(${GRADES_SCHEMA.p1B})</b></th>
      <th class="p1">المجموع<br><b>(60)</b></th>

      <th class="p2">المهام الأدائية<br><b>(${GRADES_SCHEMA.p2A})</b></th>
      <th class="p2">تقويمات تحريرية<br><b>(${GRADES_SCHEMA.p2B})</b></th>
      <th class="p2">المجموع<br><b>(60)</b></th>
    </tr>
  `;
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  const students = state.students || [];

  for(let i=0;i<students.length;i++){
    const st = students[i];
    const p1a = clampNum(st.p1_a ?? 0, GRADES_SCHEMA.p1A);
    const p1b = clampNum(st.p1_b ?? 0, GRADES_SCHEMA.p1B);
    const p2a = clampNum(st.p2_a ?? 0, GRADES_SCHEMA.p2A);
    const p2b = clampNum(st.p2_b ?? 0, GRADES_SCHEMA.p2B);
    const fin = clampNum(st.final ?? 0, GRADES_SCHEMA.final);

    const p1t = p1a + p1b;
    const p2t = p2a + p2b;
    const sum = p1t + p2t;
    const avg = Math.round((sum/2)*10)/10;
    const total = Math.round((avg + fin)*10)/10;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="total">${i+1}</td>
      <td class="total namecell">
        <input class="inline-input name" data-kind="name" data-i="${i}" value="${escapeHtml(st.name || "")}" placeholder="اسم الطالبة">
      </td>

      <td class="p1">
        <input class="inline-input" data-kind="p1_a" data-i="${i}" inputmode="numeric" value="${p1a}" placeholder="0">
      </td>
      <td class="p1">
        <input class="inline-input" data-kind="p1_b" data-i="${i}" inputmode="numeric" value="${p1b}" placeholder="0">
      </td>
      <td class="p1"><b>${p1t}</b></td>

      <td class="p2">
        <input class="inline-input" data-kind="p2_a" data-i="${i}" inputmode="numeric" value="${p2a}" placeholder="0">
      </td>
      <td class="p2">
        <input class="inline-input" data-kind="p2_b" data-i="${i}" inputmode="numeric" value="${p2b}" placeholder="0">
      </td>
      <td class="p2"><b>${p2t}</b></td>

      <td class="sum"><b>${sum}</b></td>
      <td class="avg"><b>${avg}</b></td>
      <td class="final">
        <input class="inline-input" data-kind="final" data-i="${i}" inputmode="numeric" value="${fin}" placeholder="0">
      </td>
      <td class="total"><b>${total}</b></td>
    `;
    tbody.appendChild(tr);
  }

  table.appendChild(tbody);
  tableWrap.appendChild(table);
  wrap.appendChild(tableWrap);

  // بطاقات الجوال (بدون جدول عريض)
  const cardsWrap = document.createElement("div");
  cardsWrap.className = "grades-cards-mobile";

  students.forEach((st, i)=>{
    const p1a = clampNum(st.p1_a ?? 0, GRADES_SCHEMA.p1A);
    const p1b = clampNum(st.p1_b ?? 0, GRADES_SCHEMA.p1B);
    const p2a = clampNum(st.p2_a ?? 0, GRADES_SCHEMA.p2A);
    const p2b = clampNum(st.p2_b ?? 0, GRADES_SCHEMA.p2B);
    const fin = clampNum(st.final ?? 0, GRADES_SCHEMA.final);

    const p1t = p1a + p1b;
    const p2t = p2a + p2b;
    const sum = p1t + p2t;
    const avg = Math.round((sum/2)*10)/10;
    const total = Math.round((avg + fin)*10)/10;

    const card = document.createElement("div");
    card.className = "student-card";
    card.innerHTML = `
      <div class="head">
        <div class="idx">#${i+1}</div>
        <input class="inline-input name" data-kind="name" data-i="${i}" value="${escapeHtml(st.name || "")}" placeholder="اسم الطالبة">
      </div>

      <div class="grid">
        <div class="field"><b>ف1 مهام (40)</b><input class="inline-input" data-kind="p1_a" data-i="${i}" inputmode="numeric" value="${p1a}"></div>
        <div class="field"><b>ف1 تحريرية (20)</b><input class="inline-input" data-kind="p1_b" data-i="${i}" inputmode="numeric" value="${p1b}"></div>

        <div class="field"><b>ف2 مهام (40)</b><input class="inline-input" data-kind="p2_a" data-i="${i}" inputmode="numeric" value="${p2a}"></div>
        <div class="field"><b>ف2 تحريرية (20)</b><input class="inline-input" data-kind="p2_b" data-i="${i}" inputmode="numeric" value="${p2b}"></div>

        <div class="field"><b>اختبار نهائي (40)</b><input class="inline-input" data-kind="final" data-i="${i}" inputmode="numeric" value="${fin}"></div>
        <div class="field"><b>المجموع الكلي</b><div style="font-weight:900;text-align:center">${total}</div></div>

        <div class="field"><b>مجموع الفترتين</b><div style="font-weight:900;text-align:center">${sum}</div></div>
        <div class="field"><b>متوسط الفترتين</b><div style="font-weight:900;text-align:center">${avg}</div></div>
      </div>
    `;
    cardsWrap.appendChild(card);
  });

  wrap.appendChild(cardsWrap);

  const note = document.createElement("div");
  note.className = "status";
  note.innerHTML = `<b>تنبيه:</b> أوزان الدرجات: (40+20) لكل فترة، المتوسط + الاختبار النهائي = 100.`;
  wrap.appendChild(note);

  setTimeout(()=>{
    const btn = document.getElementById("btnApplyBulk");
    if(btn){
      btn.onclick = ()=>{
        const col = document.getElementById("bulkCol").value;
        const valRaw = document.getElementById("bulkVal").value;
        const maxMap = { p1_a: GRADES_SCHEMA.p1A, p1_b: GRADES_SCHEMA.p1B, p2_a: GRADES_SCHEMA.p2A, p2_b: GRADES_SCHEMA.p2B, final: GRADES_SCHEMA.final };
        const v = clampNum(valRaw, maxMap[col]);
        state.students.forEach(s=>{ s[col] = v; });
        save();
        render();
        syncInputs();
      };
    }
  },0);

  return wrap;
}

/* =========================
   كشف متابعة شهري (مثل الصورة + صح/خطأ لكل مربع)
   ========================= */
function ensureMonthlyForStudents(){
  const weeks = state.monthly.weeks || 5;
  const criteria = state.monthly.criteria || [];
  (state.students || []).forEach(st=>{
    if(!st.monthlyMarks) st.monthlyMarks = {};
    criteria.forEach(cr=>{
      if(!Array.isArray(st.monthlyMarks[cr.key])) st.monthlyMarks[cr.key] = new Array(weeks).fill(null);
      // طول صحيح
      if(st.monthlyMarks[cr.key].length !== weeks){
        const old = st.monthlyMarks[cr.key].slice(0, weeks);
        while(old.length < weeks) old.push(null);
        st.monthlyMarks[cr.key] = old;
      }
    });
  });
}

function toggleMarkValue(current){
  // null -> true(✅) -> false(❌) -> null
  if(current === null || current === undefined) return true;
  if(current === true) return false;
  return null;
}

function markClass(v){
  if(v === true) return "ok";
  if(v === false) return "bad";
  return "neu";
}
function markText(v){
  if(v === true) return "✓";
  if(v === false) return "✗";
  return "";
}

function renderMonthlyFollowup(){
  ensureMonthlyForStudents();

  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  const monthControls = document.createElement("div");
  monthControls.className = "no-print";
  monthControls.style.border = "1px solid var(--line)";
  monthControls.style.borderRadius = "12px";
  monthControls.style.padding = "10px";
  monthControls.style.marginBottom = "10px";

  const monthOptions = Array.from({length:12}, (_,i)=> {
    const m=i+1;
    return `<option value="${m}" ${m===state.monthly.month?"selected":""}>${arabicMonthName(m)}</option>`;
  }).join("");

  const weekOptions = [4,5].map(w=>`<option value="${w}" ${w===(state.monthly.weeks||5)?"selected":""}>${w}</option>`).join("");

  monthControls.innerHTML = `
    <div style="font-weight:900; margin-bottom:8px;">إعدادات الكشف الشهري</div>
    <div class="row3">
      <div>
        <label>الشهر</label>
        <select id="mMonth">${monthOptions}</select>
      </div>
      <div>
        <label>السنة</label>
        <input id="mYear" inputmode="numeric" value="${state.monthly.year || new Date().getFullYear()}">
      </div>
      <div>
        <label>عدد أسابيع الشهر</label>
        <select id="mWeeks">${weekOptions}</select>
      </div>
    </div>
    <div class="row3" style="margin-top:10px">
      <div>
        <label>الفصل الدراسي</label>
        <input id="mTerm" value="${escapeHtml(state.monthly.term || "")}" placeholder="مثال: الأول / الثاني">
      </div>
      <div>
        <label>العام الدراسي</label>
        <input id="mAcad" value="${escapeHtml(state.monthly.academicYear || "1446هـ")}">
      </div>
      <div style="display:flex;align-items:end;gap:8px;">
        <button class="danger" id="mClear" style="width:100%;">تصفير علامات الشهر</button>
      </div>
    </div>
    <div class="hint">الضغط على المربع يبدّل: ✅ ثم ❌ ثم فراغ.</div>
  `;
  wrap.appendChild(monthControls);

  // عنوان مثل الصورة
  const topTitle = document.createElement("div");
  topTitle.style.padding = "6px 12px 0";
  topTitle.style.textAlign = "center";
  topTitle.style.fontWeight = "900";
  topTitle.style.fontSize = "18px";
  topTitle.innerHTML = `
    كشف متابعة مادة <span style="text-decoration:underline;">${escapeHtml(state.subject || "........")}</span>
    الصف <span style="text-decoration:underline;">${escapeHtml(state.classroom || "........")}</span>
    الفصل الدراسي <span style="text-decoration:underline;">${escapeHtml(state.monthly.term || "........")}</span>
    للعام <span style="text-decoration:underline;">${escapeHtml(state.monthly.academicYear || "........")}</span>
    <div style="font-size:13px;color:var(--muted);margin-top:4px;">
      شهر: ${arabicMonthName(state.monthly.month)} ${escapeHtml(state.monthly.year)}
    </div>
  `;
  wrap.appendChild(topTitle);

  const weeks = state.monthly.weeks || 5;
  const criteria = state.monthly.criteria || [];
  const students = state.students || [];

  /* ===== Desktop Table ===== */
  const tableWrap = document.createElement("div");
  tableWrap.className = "monthly-table-desktop";
  tableWrap.style.marginTop = "10px";

  const table = document.createElement("table");
  table.id = "monthlyTable";

  // header row 1
  const h1 = document.createElement("tr");
  h1.innerHTML = `
    <th rowspan="2" class="total" style="width:42px">م</th>
    <th rowspan="2" class="total namecell" style="width:210px">الاسم</th>
  `;
  criteria.forEach(cr=>{
    h1.innerHTML += `<th colspan="${weeks}" class="crit-h ${cr.cls}">${escapeHtml(cr.label)}</th>`;
  });
  const thead = document.createElement("thead");
  thead.appendChild(h1);

  // header row 2 (weeks)
  const h2 = document.createElement("tr");
  criteria.forEach(cr=>{
    for(let w=1; w<=weeks; w++){
      h2.innerHTML += `<th class="total">أ${w}</th>`;
    }
  });
  thead.appendChild(h2);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  students.forEach((st, i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="total">${i+1}</td>
      <td class="total namecell">
        <input class="inline-input name" data-kind="name" data-i="${i}" value="${escapeHtml(st.name || "")}" placeholder="اسم الطالبة">
      </td>
    `;

    criteria.forEach(cr=>{
      for(let w=0; w<weeks; w++){
        const v = st.monthlyMarks?.[cr.key]?.[w] ?? null;
        tr.innerHTML += `
          <td>
            <button class="mark-btn ${markClass(v)}" data-m-i="${i}" data-m-k="${cr.key}" data-m-w="${w}">
              ${markText(v)}
            </button>
          </td>
        `;
      }
    });

    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  tableWrap.appendChild(table);
  wrap.appendChild(tableWrap);

  /* ===== Mobile Cards ===== */
  const cards = document.createElement("div");
  cards.className = "monthly-cards-mobile";
  cards.style.marginTop = "10px";

  const mini = document.createElement("div");
  mini.className = "mini-title";
  mini.textContent = "في الجوال: اضغطي المربعات للتبديل صح/خطأ";
  cards.appendChild(mini);

  students.forEach((st, i)=>{
    const card = document.createElement("div");
    card.className = "student-card";
    let html = `
      <div class="head">
        <div class="idx">#${i+1}</div>
        <input class="inline-input name" data-kind="name" data-i="${i}" value="${escapeHtml(st.name || "")}" placeholder="اسم الطالبة">
      </div>
    `;

    criteria.forEach(cr=>{
      html += `<div style="margin:8px 0 6px;font-weight:900">${escapeHtml(cr.label)}</div>`;
      html += `<div style="display:flex;gap:6px;flex-wrap:wrap">`;
      for(let w=0; w<weeks; w++){
        const v = st.monthlyMarks?.[cr.key]?.[w] ?? null;
        html += `
          <button class="mark-btn ${markClass(v)}" data-m-i="${i}" data-m-k="${cr.key}" data-m-w="${w}">
            ${markText(v) || ("أ"+(w+1))}
          </button>
        `;
      }
      html += `</div>`;
    });

    card.innerHTML = html;
    cards.appendChild(card);
  });

  wrap.appendChild(cards);

  setTimeout(()=>{
    const mMonth = document.getElementById("mMonth");
    const mYear = document.getElementById("mYear");
    const mWeeks = document.getElementById("mWeeks");
    const mTerm = document.getElementById("mTerm");
    const mAcad = document.getElementById("mAcad");
    const mClear = document.getElementById("mClear");

    if(mMonth) mMonth.onchange = ()=>{ state.monthly.month = Number(mMonth.value); save(); render(); };
    if(mYear) mYear.oninput = ()=>{ state.monthly.year = Number(mYear.value || new Date().getFullYear()); save(); render(); };
    if(mWeeks) mWeeks.onchange = ()=>{
      state.monthly.weeks = Number(mWeeks.value);
      // إعادة تهيئة مصفوفات العلامات
      ensureMonthlyForStudents();
      save(); render();
    };
    if(mTerm) mTerm.oninput = ()=>{ state.monthly.term = mTerm.value; save(); };
    if(mAcad) mAcad.oninput = ()=>{ state.monthly.academicYear = mAcad.value; save(); };
    if(mClear) mClear.onclick = ()=>{
      if(!confirm("تأكيد تصفير علامات هذا الشهر لجميع الطالبات؟")) return;
      (state.students||[]).forEach(st=>{
        if(!st.monthlyMarks) return;
        Object.keys(st.monthlyMarks).forEach(k=>{
          st.monthlyMarks[k] = new Array(state.monthly.weeks||5).fill(null);
        });
      });
      save(); render();
    };
  }, 0);

  return wrap;
}

/* =========================
   Plans Form (مهارات تفاعلية + من ملفاتك)
   ========================= */
function renderPlansForm(){
  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  if(!state.plans) state.plans = {entries:[]};
  if(!Array.isArray(state.plans.entries)) state.plans.entries = [];

  if(state.plans.entries.length === 0){
    state.plans.entries.push({
      grade: 1,
      planType: "علاجية",
      subject: "لغتي",
      skill: getSkills(1,"لغتي")[0],
      date: state.date || "",
      pre: "يحتاج متابعة",
      post: "يحتاج متابعة",
      procedure: PROCEDURES[0],
      notes: ""
    });
    save();
  }

  const controls = document.createElement("div");
  controls.className = "no-print";
  controls.style.display = "flex";
  controls.style.gap = "8px";
  controls.style.flexWrap = "wrap";
  controls.style.marginBottom = "10px";
  controls.innerHTML = `
    <button id="btnAddPlanRow" class="primary">إضافة سجل</button>
    <button id="btnClearPlans" class="danger">تصفير سجل الخطط</button>
  `;
  wrap.appendChild(controls);

  const table = document.createElement("table");
  table.id = "plansTable";

  const thead = document.createElement("thead");
  thead.innerHTML = `
    <tr>
      <th class="total">م</th>
      <th class="avg">الصف</th>
      <th class="p1">نوع الخطة</th>
      <th class="p2">المادة</th>
      <th class="sum">المهارة</th>
      <th class="avg">التاريخ</th>
      <th class="p1">القبلي</th>
      <th class="p2">البعدي</th>
      <th class="sum">نتيجة التغير</th>
      <th class="final">الإجراء</th>
      <th class="total">ملاحظات</th>
      <th class="total no-print">حذف</th>
    </tr>
  `;
  table.appendChild(thead);

  const tbody = document.createElement("tbody");

  state.plans.entries.forEach((r, i)=>{
    const grade = Number(r.grade || 1);
    const subject = r.subject || "لغتي";
    const skills = getSkills(grade, subject);

    r.grade = grade;
    r.subject = subject;
    r.skill = (r.skill && skills.includes(r.skill)) ? r.skill : skills[0];

    r.pre = normalizeEval(r.pre);
    r.post = normalizeEval(r.post);
    const change = getChangeLabel(r.pre, r.post);

    const gradeOptions = [1,2,3,4,5,6].map(g=>`<option value="${g}" ${g===grade?"selected":""}>${g}</option>`).join("");
    const planOptions = ["علاجية","إثرائية"].map(t=>`<option value="${t}" ${t===r.planType?"selected":""}>${t}</option>`).join("");
    const subjOptions = SUBJECTS.map(s=>`<option value="${s}" ${s===subject?"selected":""}>${s}</option>`).join("");
    const skillOptions = skills.map(s=>`<option value="${escapeHtml(s)}" ${s===r.skill?"selected":""}>${escapeHtml(s)}</option>`).join("");
    const procOptions = PROCEDURES.map(p=>`<option value="${escapeHtml(p)}" ${p===r.procedure?"selected":""}>${escapeHtml(p)}</option>`).join("");
    const evalOptionsPre = EVAL_LEVELS.map(x=>`<option value="${escapeHtml(x)}" ${x===r.pre?"selected":""}>${escapeHtml(x)}</option>`).join("");
    const evalOptionsPost = EVAL_LEVELS.map(x=>`<option value="${escapeHtml(x)}" ${x===r.post?"selected":""}>${escapeHtml(x)}</option>`).join("");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="total">${i+1}</td>
      <td class="avg"><select class="inline-input" data-plans-i="${i}" data-plans-k="grade">${gradeOptions}</select></td>
      <td class="p1"><select class="inline-input" data-plans-i="${i}" data-plans-k="planType">${planOptions}</select></td>
      <td class="p2"><select class="inline-input" data-plans-i="${i}" data-plans-k="subject">${subjOptions}</select></td>
      <td class="sum" style="min-width:220px"><select class="inline-input" data-plans-i="${i}" data-plans-k="skill">${skillOptions}</select></td>
      <td class="avg"><input class="inline-input" data-plans-i="${i}" data-plans-k="date" type="date" value="${escapeHtml(r.date || "")}"></td>
      <td class="p1"><select class="inline-input" data-plans-i="${i}" data-plans-k="pre">${evalOptionsPre}</select></td>
      <td class="p2"><select class="inline-input" data-plans-i="${i}" data-plans-k="post">${evalOptionsPost}</select></td>
      <td class="sum"><b>${escapeHtml(change.text)}</b></td>
      <td class="final" style="min-width:180px"><select class="inline-input" data-plans-i="${i}" data-plans-k="procedure">${procOptions}</select></td>
      <td class="total" style="min-width:160px"><input class="inline-input" data-plans-i="${i}" data-plans-k="notes" value="${escapeHtml(r.notes || "")}" placeholder="ملاحظات"></td>
      <td class="total no-print"><button class="danger" data-plans-del="${i}" style="padding:6px 10px;border-radius:8px">×</button></td>
    `;
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  wrap.appendChild(table);

  // مستعرض مهارات تفاعلي (من ملفاتك للعلوم 3/5/6)
  const browser = document.createElement("div");
  browser.className = "no-print";
  browser.style.marginTop = "12px";
  browser.style.border = "1px solid var(--line)";
  browser.style.borderRadius = "12px";
  browser.style.padding = "10px";
  browser.innerHTML = `
    <div style="font-weight:900;margin-bottom:8px;">مستعرض المهارات (تفاعلي)</div>
    <div class="row3">
      <div>
        <label>اختر الصف</label>
        <select id="sbGrade">${[1,2,3,4,5,6].map(g=>`<option value="${g}">${g}</option>`).join("")}</select>
      </div>
      <div>
        <label>اختر المادة</label>
        <select id="sbSubject">${SUBJECTS.map(s=>`<option value="${s}">${s}</option>`).join("")}</select>
      </div>
      <div>
        <label>بحث</label>
        <input id="sbSearch" placeholder="ابحث عن كلمة داخل المهارات">
      </div>
    </div>
    <div style="margin-top:10px;border:1px solid var(--line);border-radius:10px;padding:8px;background:#fafafa;max-height:220px;overflow:auto" id="sbList"></div>
    <div class="hint">ملاحظة: مهارات (علوم) للصف 3/5/6 مأخوذة من ملفاتك المرفوعة، وتظهر هنا بالكامل.</div>
  `;
  wrap.appendChild(browser);

  setTimeout(()=>{
    const addBtn = document.getElementById("btnAddPlanRow");
    const clearBtn = document.getElementById("btnClearPlans");
    if(addBtn){
      addBtn.onclick = ()=>{
        state.plans.entries.push({
          grade: 1,
          planType: "علاجية",
          subject: "لغتي",
          skill: getSkills(1,"لغتي")[0],
          date: state.date || "",
          pre: "يحتاج متابعة",
          post: "يحتاج متابعة",
          procedure: PROCEDURES[0],
          notes: ""
        });
        save(); render();
      };
    }
    if(clearBtn){
      clearBtn.onclick = ()=>{
        if(!confirm("تأكيد تصفير سجل الخطط؟")) return;
        state.plans.entries = [];
        save(); render();
      };
    }

    // skill browser
    const sbGrade = document.getElementById("sbGrade");
    const sbSubject = document.getElementById("sbSubject");
    const sbSearch = document.getElementById("sbSearch");
    const sbList = document.getElementById("sbList");

    function renderSkillList(){
      const g = Number(sbGrade.value);
      const s = sbSubject.value;
      const q = (sbSearch.value || "").trim();
      const skills = getSkills(g, s).filter(x => !q || x.includes(q));
      sbList.innerHTML = skills.map(x => `
        <div style="display:flex;gap
