<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>استمارات الرصد التفاعلية</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- PDF -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- OCR عربي (اختياري - لاستيراد أسماء من صورة) -->
  <script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#0ea5e9;

      --p1:#e9f5e9;
      --p2:#eaf1ff;
      --sum:#fdebdc;
      --avg:#fff6cf;
      --final:#ffd7dc;
      --total:#efefef;

      --ok:#16a34a;
      --bad:#ef4444;
      --neu:#9ca3af;

      --c-part:#c59a00;
      --c-home:#2aa7df;
      --c-perf:#7b8ea6;
      --c-class:#a8d18d;
    }

    *{box-sizing:border-box}
    html, body{width:100%; max-width:100%; overflow-x:hidden;}
    body{
      margin:0;
      font-family:"Cairo", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg);
    }

    header{
      padding:18px 16px 10px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title{display:flex; gap:10px; align-items:center;}
    .badge{
      width:44px; height:44px; border-radius:12px;
      background:linear-gradient(135deg,#22c55e,#0ea5e9);
      display:grid; place-items:center;
      color:white; font-weight:900;
      flex:0 0 auto;
    }
    h1{margin:0; font-size:18px}
    .sub{color:var(--muted); font-size:12px; margin-top:2px}

    .top-actions{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      max-width:100%;
    }

    button, .btn{
      border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-family:inherit;
      font-weight:800;
      font-size:13px;
    }
    button.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:white;
    }
    button.danger{
      background:#ef4444;
      border-color:#ef4444;
      color:white;
    }
    button:disabled{opacity:.6; cursor:not-allowed}

    main{
      padding:0 16px 18px;
      display:grid;
      grid-template-columns: 390px 1fr;
      gap:12px;
      max-width:100%;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 1px 0 rgba(17,24,39,.04);
      max-width:100%;
    }
    .card-hd{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .card-hd .hd-title{font-weight:900;font-size:14px;}
    .card-bd{padding:12px}

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:800;
    }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      font-family:inherit;
      font-size:13px;
      background:#fff;
      outline:none;
      max-width:100%;
    }
    textarea{min-height:88px; resize:vertical}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    @media (max-width: 980px){
      .row,.row3{grid-template-columns:1fr}
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.6;
    }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      max-width:100%;
    }
    .dot{width:10px;height:10px;border-radius:50%;}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .dot.neu{background:#f59e0b}

    #printArea{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      max-width:100%;
    }

    .form-header{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .form-header h2{
      margin:0;
      font-size:16px;
      font-weight:900;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      max-width:100%;
    }
    .meta .kv{
      border:1px solid var(--line);
      border-radius:10px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      background:#fff;
      font-weight:900;
      white-space:nowrap;
      max-width:100%;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      table-layout:fixed;
    }
    th, td{
      border:1px solid #111;
      padding:6px 6px;
      text-align:center;
      vertical-align:middle;
      white-space:normal;
      word-break:break-word;
    }
    th{font-weight:900}
    .p1{background:var(--p1)}
    .p2{background:var(--p2)}
    .sum{background:var(--sum)}
    .avg{background:var(--avg)}
    .final{background:var(--final)}
    .total{background:var(--total)}
    .namecell{text-align:right; font-weight:900}

    .inline-input{
      width:100%;
      padding:6px 6px;
      border:1px solid #000;
      border-radius:6px;
      font-family:inherit;
      font-size:12px;
      text-align:center;
      background:#fff;
      max-width:100%;
    }
    .inline-input.name{text-align:right;font-weight:900}

    .footer-note{
      padding:10px 14px 14px;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }

    .signatures{
      margin:10px 14px 14px;
      border-top:1px solid var(--line);
      padding-top:10px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width: 820px){
      .signatures{grid-template-columns:1fr}
    }
    .sig-box{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#fafafa;
    }
    .sig-box b{display:block;margin-bottom:8px}
    .sig-line{
      border:none;
      border-bottom:2px dotted #111;
      border-radius:0;
      padding:6px 8px;
      background:transparent;
      width:100%;
      font-weight:900;
    }

    .status{
      font-size:12px;
      color:var(--muted);
      line-height:1.6;
      margin-top:8px;
      padding:8px 10px;
      border:1px dashed var(--line);
      border-radius:10px;
      background:#fafafa;
    }

    @media (max-width: 820px){
      .desktop-only{display:none !important;}
      .mobile-only{display:block !important;}
    }
    @media (min-width: 821px){
      .desktop-only{display:block !important;}
      .mobile-only{display:none !important;}
    }

    .student-card{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      margin:10px 12px;
      background:#fff;
    }
    .student-card .head{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .student-card .idx{
      font-weight:900;
      color:var(--muted);
      font-size:12px;
    }
    .student-card .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    .student-card .field{
      border:1px solid var(--line);
      border-radius:10px;
      padding:8px;
      background:#fafafa;
      text-align:right;
    }
    .student-card .field b{
      display:block;
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
    }

    /* Monthly toggle button */
    .mark-btn{
      width:26px;height:26px;
      border-radius:6px;
      border:1px solid #111;
      display:inline-grid;
      place-items:center;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      background:#fff;
      font-size:14px;
      padding:0;
    }
    .mark-btn.ok{background:#dcfce7; border-color:#16a34a; color:#14532d}
    .mark-btn.bad{background:#fee2e2; border-color:#ef4444; color:#7f1d1d}
    .mark-btn.neu{background:#fff; border-color:#111; color:#111}

    .crit-h.part{background:color-mix(in oklab, var(--c-part) 30%, white)}
    .crit-h.home{background:color-mix(in oklab, var(--c-home) 30%, white)}
    .crit-h.perf{background:color-mix(in oklab, var(--c-perf) 30%, white)}
    .crit-h.class{background:color-mix(in oklab, var(--c-class) 30%, white)}

    .mini-title{font-weight:900;margin:0 12px 6px;color:#111;font-size:13px;}

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      padding:2px 8px;
      border:1px solid var(--line);
      border-radius:8px;
      background:#fff;
      color:#111;
      font-weight:800;
    }

    /* login overlay */
    .overlay{
      position:fixed; inset:0;
      background:rgba(17,24,39,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .overlay.show{display:flex;}
    .overlay .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      border:1px solid var(--line);
      overflow:hidden;
      box-shadow:0 10px 40px rgba(0,0,0,.15);
    }
    .modal-hd{
      padding:14px 14px;
      border-bottom:1px solid var(--line);
      font-weight:900;
    }
    .modal-bd{padding:14px;}
    .modal-bd p{margin:0 0 10px; color:var(--muted); font-size:13px; line-height:1.7;}
    .modal-actions{display:flex; gap:8px; padding:0 14px 14px; flex-wrap:wrap;}
    .modal-actions button{flex:1}

    /* Print */
    @media print{
      body{background:#fff}
      header, .card.left, .top-actions, .no-print, .overlay{display:none !important}
      main{display:block; padding:0}
      #printArea{border:none !important;border-radius:0 !important;}
      @page{ size: A4 landscape; margin: 10mm; }
      table{font-size:10.5px}
      .mark-btn{width:22px;height:22px;font-size:12px}
      .sig-line{border-bottom:2px solid #111 !important;}
    }
  </style>
</head>

<body>

<div class="overlay" id="loginOverlay">
  <div class="modal">
    <div class="modal-hd">تسجيل دخول المعلمة</div>
    <div class="modal-bd">
      <p>اكتبي اسم المعلمة (يستخدم للحفظ السحابي). سيتم فتح الرابط بهذا الشكل: <span class="kbd">?user=اسم_المعلمة</span></p>
      <label>اسم المعلمة</label>
      <input id="loginName" placeholder="مثال: معلمة نورة" />
      <div class="hint">كل معلمة تدخل باسمها ليصير لها سجلاتها الخاصة.</div>
    </div>
    <div class="modal-actions">
      <button class="primary" id="btnLoginGo">دخول</button>
      <button id="btnLoginClose">إغلاق (استخدام افتراضي)</button>
    </div>
  </div>
</div>

<header>
  <div class="title">
    <div class="badge">✓</div>
    <div>
      <h1>استمارات الرصد التفاعلية</h1>
      <div class="sub">سجلات متعددة + حفظ سحابي + PDF + صح/خطأ شهري + خطط علاجية/إثرائية</div>
    </div>
  </div>

  <div class="top-actions no-print">
    <span class="pill" id="cloudPill"><span class="dot neu"></span> سحابي: …</span>
    <span class="pill" id="globalPill">زيارات عالمية: …</span>
    <span class="pill" id="visitPill">زيارات الجهاز: …</span>
    <span class="pill" id="userPill">مستخدم: …</span>
    <button class="btn" id="btnSwitchUser">تبديل المعلمة</button>
    <button class="btn" id="btnCloudReload">استرجاع من السحابة الآن</button>
    <button class="btn" id="btnExportJSON">تصدير بيانات (JSON)</button>
    <button class="btn" id="btnImportJSON">استيراد بيانات (JSON)</button>
    <input id="jsonFile" type="file" accept="application/json" hidden />
    <button class="danger" id="btnResetLocal">تصفير محلي فقط</button>
  </div>
</header>

<main>
  <!-- يسار -->
  <section class="card left">
    <div class="card-hd">
      <div class="hd-title">السجلات المحفوظة</div>
      <span class="pill" id="autosavePill">حفظ تلقائي: يعمل</span>
    </div>

    <div class="card-bd">
      <div>
        <label>اختيار السجل</label>
        <select id="recordSelect"></select>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="primary" id="btnNewRecord">سجل جديد</button>
        <button id="btnDuplicateRecord">نسخ سجل</button>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="danger" id="btnDeleteRecord">حذف السجل</button>
        <button id="btnFocusTitle">تسمية السجل</button>
      </div>

      <div class="status">
        ✅ بعد الضغط على <b>سجل جديد</b> اكتبي الاسم في خانة “عنوان السجل” داخل الصفحة.<br>
        ✅ السجلات تحفظ محليًا + سحابيًا ويمكن الرجوع لها حتى بعد سنة.
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0">

      <div>
        <label>إنشاء سجلات متعددة (كل صف/شعبة في سطر)</label>
        <textarea id="bulkRecords" placeholder="مثال:
سادس/أ
سادس/ب
خامس/أ"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="primary" id="btnCreateMany">إنشاء السجلات</button>
          <button id="btnClearMany">مسح</button>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0">

      <div class="card-hd" style="padding:0 0 10px;border:0">
        <div class="hd-title">إعدادات السجل الحالي</div>
      </div>

      <div class="row">
        <div>
          <label>نوع الاستمارة</label>
          <select id="formType">
            <option value="yearwork">سجل أعمال السنة لعام …</option>
            <option value="monthly">كشف متابعة شهري (صح/خطأ)</option>
            <option value="plans">متابعة الخطط العلاجية والإثرائية</option>
            <option value="counselor">تحويل للموجهة الطلابية</option>
            <option value="principal">تحويل للمديرة</option>
            <option value="parent">تبليغ لولي الأمر</option>
          </select>
        </div>
        <div>
          <label>المادة / العنوان</label>
          <input id="subject" placeholder="مثال: علوم - سادس" />
        </div>
      </div>

      <div class="row3" style="margin-top:10px">
        <div>
          <label>المدرسة</label>
          <input id="school" placeholder="اسم المدرسة" />
        </div>
        <div>
          <label>الصف / الشعبة</label>
          <input id="classroom" placeholder="مثال: سادس/أ" />
        </div>
        <div>
          <label>التاريخ</label>
          <input id="date" type="date" />
        </div>
      </div>

      <div class="row3" style="margin-top:10px">
        <div>
          <label>الفصل الدراسي (بالعربي)</label>
          <select id="termAr">
            <option value="الأول">الأول</option>
            <option value="الثاني">الثاني</option>
            <option value="الثالث">الثالث</option>
          </select>
        </div>
        <div>
          <label>العام الدراسي (اكتبي 1447 أو ١٤٤٧هـ)</label>
          <input id="academicYearAr" placeholder="مثال: 1447 أو ١٤٤٧هـ" />
          <div class="hint">لن يتم تحويل الأرقام أثناء الكتابة (حتى لا تتقطع). التحويل عند الخروج من الخانة.</div>
        </div>
        <div>
          <label>عنوان السجل (احفظيه هنا)</label>
          <input id="recordTitle" placeholder="مثال: سجل أعمال السنة لعام ١٤٤٧هـ - علوم - سادس/أ" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>اسم المعلمة (يظهر في الطباعة)</label>
          <input id="teacherName" placeholder="مثال: أ/ بدرية الزهراني" />
        </div>
        <div>
          <label>اسم المديرة (يظهر في الطباعة)</label>
          <input id="principalName" placeholder="مثال: قائدة المدرسة/ …" />
        </div>
      </div>

      <div class="status" id="cloudStatus">
        <b>الحفظ السحابي:</b> يحفظ كل السجلات حسب المعلمة (userKey).
      </div>

      <hr style="border:none;border-top:1px solid var(--line); margin:14px 0">

      <div class="card-hd" style="padding:0 0 10px;border:0">
        <div class="hd-title">أسماء الطالبات (للسجل الحالي)</div>
      </div>

      <div class="row">
        <div>
          <label>استيراد CSV (عمود أسماء)</label>
          <input id="csvFile" type="file" accept=".csv,text/csv" />
        </div>
        <div>
          <label>استيراد من صورة (ألبوم الكاميرا)</label>
          <input id="imgFile" type="file" accept="image/*" />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>أو الصقي الأسماء (كل اسم في سطر)</label>
        <textarea id="namesPaste" placeholder="سارة محمد&#10;ريم عبدالله"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="primary" id="btnApplyNames">تطبيق الأسماء</button>
          <button id="btnAddRow">إضافة طالبة</button>
        </div>
      </div>

      <div class="hint" id="namesCountHint">عدد الطالبات: 0</div>
    </div>
  </section>

  <!-- يمين -->
  <section class="card">
    <div class="card-hd no-print">
      <div class="hd-title">معاينة الاستمارة (السجل الحالي)</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnPrint">طباعة</button>
        <button class="primary" id="btnPDF">حفظ/تصدير PDF</button>
      </div>
    </div>

    <div id="printArea"></div>
  </section>
</main>

<script>
/* =========================
   Google Sheet Web App
   ========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxMZOvfhuzGY3Unz2jqyFVfSLkvN5xQKxuXyOqpUV9hkdcokD4vxjjDxjZtqkoWzvir/exec";
const APP_TOKEN = ""; // اتركيه فاضي إن كان السكربت لا يتطلب توكن

/* Skills: تم إدراج مهارات (علوم) من الملفات التي أرفقتِها للصف 3/5/6 + أمثلة لباقي الصفوف */
const SKILLS = {
  "الأول": {
    "علوم": ["تمييز الكائنات الحية وغير الحية", "استكشاف الحواس الخمس", "السلامة في المختبر"],
    "رياضيات": ["العد حتى 100", "الجمع والطرح البسيط", "الأشكال الهندسية الأساسية"],
    "لغتي": ["قراءة كلمات وجمل قصيرة", "كتابة الحروف والكلمات", "فهم النص البسيط"],
  },
  "الثاني": {
    "علوم": ["تصنيف المواد (صلبة/سائلة/غازية)", "تغيرات المادة", "الطقس وفصول السنة"],
    "رياضيات": ["الجمع والطرح حتى 1000", "القياس بالوحدات البسيطة", "الوقت والنقود"],
    "لغتي": ["استخراج الفكرة العامة", "ترتيب أحداث النص", "قواعد لغوية بسيطة"],
  },
  "الثالث": {
    "علوم": [
      "تطبيق الطريقة العلمية التي يستخدمها العلما...لأجزاء الأساسية للنبات رسما مبسطاً مع كتابة البيانات على الرسم",
      "معرفة مفهوم المادة",
      "قياس بعض صفات المادة كالطول والحجم والكتلة عملياً",
      "تصنيف المواد وفق خصائصها",
      "تمييز المخلوط عن المحلول",
      "تفسير بعض التغيرات التي تطرأ على المادة",
      "تمييز المواد الشفافة وشبه الشفافة والمعتمة",
      "تفسير انتقال الحرارة بطرق مختلفة",
      "توضيح مصادر الصوت",
      "بيان أثر الضوء في الرؤية",
      "توضيح مفهوم القوة",
      "توضيح أثر القوة في تغيير الحركة",
      "تطبيق مهارات السلامة في المختبر",
      "تفسير دورة الماء في الطبيعة",
      "وصف الغلاف الجوي ووظائفه",
      "تمييز أنواع الصخور",
      "وصف التربة ومكوناتها",
      "توضيح مفهوم الموارد الطبيعية",
      "تمييز الكائنات الحية وتصنيفها بصورة مبسطة"
    ],
    "رياضيات": ["الجمع والطرح", "الضرب", "القسمة", "الكسور"],
    "لغتي": ["الفكرة الرئيسة", "المرادف والضد", "القواعد الأساسية"],
  },
  "الرابع": {
    "علوم": ["الأنظمة البيئية", "التكيفات", "الطاقة والتحول"],
    "رياضيات": ["الكسور", "العوامل والمضاعفات", "القياس"],
    "لغتي": ["استنتاج", "تلخيص", "علامات الترقيم"],
  },
  "الخامس": {
    "علوم": [
      "ممارسة الطريقة العلمية التي يتبعها العلماء...الفطريات والنباتات",
      "استنتاج أهمية كل من الجذر والساق والورقة",
      "توضيح العلاقة بين المادة والعنصر والذرة",
      "تمييز الذرات والجزيئات والمركبات",
      "تفسير حالات المادة وتغيراتها",
      "تفسير التفاعلات الكيميائية بصورة مبسطة",
      "تمييز أنواع الطاقة",
      "تفسير انتقال الحرارة",
      "تفسير الكهرباء الساكنة",
      "توضيح المغناطيسية وتطبيقاتها",
      "تفسير دورات حياة الكائنات الحية",
      "تفسير تكيفات الكائنات الحية"
    ],
    "رياضيات": ["العمليات على الكسور", "النسبة", "المساحة والحجم"],
    "لغتي": ["تحليل النص", "الاستنتاج", "أساليب لغوية"],
  },
  "السادس": {
    "علوم": [
      "ممارسة الطريقة العلمية التي يستخدمها العلم...خلوقات الحية",
      "المقارنة بين الخلية النباتية والخلية الحيوانية",
      "التمثيل للصفة الموروثة والصفة المكتسبة",
      "المقارنة بين الصفة السائدة والصفة المتنحية",
      "تفسير التنوع الوراثي بصورة مبسطة",
      "تفسير دور الأجهزة الحيوية في جسم الإنسان",
      "تفسير انتقال الطاقة في السلاسل والشبكات الغذائية",
      "تفسير تغيرات سطح الأرض (زلازل/براكين) بصورة مبسطة",
      "تمييز أنواع الصخور والتربة وخصائصها",
      "تفسير حركة الصفائح"
    ],
    "رياضيات": ["النسبة والتناسب", "المعادلات البسيطة", "الإحصاء"],
    "لغتي": ["فهم مقروء", "البلاغة البسيطة", "الكتابة الوظيفية"],
  },
};

/* خيارات القبلي/البعدي حسب طلبك */
const LEVEL_WORDS = [
  "متفوق",
  "جيد",
  "يحتاج متابعة",
  "تحسن بتفوق",
  "ضعيف جدا",
  "ضعيف",
  "جيد وبحتاج متابعة"
];

const ACTION_TYPES = [
  "جلسة علاجية فردية",
  "جلسة علاجية جماعية",
  "واجب علاجي",
  "خطة إثرائية",
  "تعلّم تعاوني",
  "تعليم مقلوب",
  "أنشطة تطبيقية",
  "تدريب إضافي",
  "غير ذلك"
];

/* Helpers */
const el = (id)=>document.getElementById(id);
function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"quot;")
    .replaceAll("'","&#039;");
}
function uid(){ return "r_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }
function toArabicDigits(str){
  const map = {'0':'٠','1':'١','2':'٢','3':'٣','4':'٤','5':'٥','6':'٦','7':'٧','8':'٨','9':'٩'};
  return (str ?? "").toString().replace(/[0-9]/g, d=>map[d]);
}
function normalizeAcademicYear(input){
  const s = (input ?? "").toString().trim();
  if(!s) return "";
  let t = toArabicDigits(s).replace(/\s+/g," ");
  if(!t.includes("هـ")) t += "هـ";
  return t;
}
function clampNum(x, max){
  const cleaned = (x ?? "").toString().replace(/[^\d.]/g,"");
  const n = Number(cleaned);
  if(Number.isNaN(n)) return 0;
  return Math.max(0, Math.min(max, n));
}
function monthNameAr(m){
  const names = ["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];
  return names[(m-1+12)%12];
}

/* userKey from URL */
function getUserKey(){
  const params = new URLSearchParams(location.search);
  const u = (params.get("user") || "").trim();
  return u ? u : "default";
}
let USER_KEY = getUserKey();
let STORAGE_KEY = "irs_records_v3_" + USER_KEY;

/* ======================
   State
   ====================== */
const YEARWORK_SCHEMA = { p1A: 40, p1B: 20, p2A: 40, p2B: 20, final: 40 };

function defaultRecord(overrides={}){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const date = `${yyyy}-${mm}-${dd}`;

  return {
    id: uid(),
    title: overrides.title || "سجل جديد",
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),

    // formType: yearwork / monthly / plans / counselor / principal / parent
    formType: overrides.formType || "yearwork",
    subject: overrides.subject || "",
    school: overrides.school || "",
    classroom: overrides.classroom || "",
    date: overrides.date || date,
    termAr: overrides.termAr || "الأول",
    academicYearAr: overrides.academicYearAr || "١٤٤٦هـ",

    signatures: {
      teacherName: overrides.teacherName || "",
      principalName: overrides.principalName || ""
    },

    students: overrides.students || [],

    // Monthly follow-up (صح/خطأ)
    monthly: {
      year: yyyy,
      month: (d.getMonth()+1),
      sessions: 8, // عدد مربعات الشهر لكل معيار
      criteria: [
        {key:"participation", label:"المشاركة", cls:"part"},
        {key:"homework", label:"الواجبات", cls:"home"},
        {key:"performance", label:"المهام الأدائية", cls:"perf"},
        {key:"classwork", label:"أنشطة صفية", cls:"class"}
      ]
    },

    // Plans
    plans: {
      entries: [] // rows
    },

    // Referral forms
    referral: {
      studentName:"",
      receiver:"",
      reason:"",
      details:"",
      suggestedActions:"",
      notes:""
    },

    // Parent notice
    parent: {
      studentName:"",
      parentName:"",
      parentPhone:"",
      message:"",
      notes:""
    }
  };
}

const state = {
  version: 3,
  userKey: USER_KEY,
  records: [],
  activeId: null
};

function getActiveRecord(){
  if(!state.activeId && state.records.length) state.activeId = state.records[0].id;
  return state.records.find(r=>r.id===state.activeId) || null;
}
function touchRecord(rec){ rec.updatedAt = new Date().toISOString(); }

/* Local */
function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function loadLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return false;
  try{
    const parsed = JSON.parse(raw);
    if(parsed && parsed.records) Object.assign(state, parsed);
    return true;
  }catch(e){ return false; }
}

/* Cloud */
let saveTimer = null;
function setCloudPill(status, ok=null){
  const pill = el("cloudPill");
  let cls = "dot neu";
  if(ok === true) cls = "dot ok";
  if(ok === false) cls = "dot bad";
  pill.innerHTML = `<span class="${cls}"></span> سحابي: ${escapeHtml(status)}`;
}
async function fetchWithTimeout(url, opts={}, timeoutMs=15000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{ return await fetch(url, {...opts, signal: ctrl.signal}); }
  finally{ clearTimeout(t); }
}
async function cloudLoad(){
  try{
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("action","load");
    url.searchParams.set("userKey", USER_KEY);
    url.searchParams.set("token", APP_TOKEN);

    const res = await fetchWithTimeout(url.toString(), {method:"GET"});
    const data = await res.json();

    if(data.ok && data.found && data.state){
      Object.assign(state, data.state);
      state.userKey = USER_KEY;
      if(!state.records) state.records = [];
      if(!state.activeId) state.activeId = state.records[0]?.id || null;

      // ترقية قديم (grades -> yearwork)
      state.records.forEach(r=>{
        if(r.formType === "grades") r.formType = "yearwork";
      });

      setCloudPill("متصل ✓ (تم التحميل)", true);
      saveLocal();
      syncUI();
      render();
    }else if(data.ok){
      setCloudPill("متصل ✓ (لا يوجد بيانات بعد)", true);
    }else{
      setCloudPill("مشكلة صلاحية/توكن", false);
    }
  }catch(e){
    setCloudPill("غير متصل (محليًا)", false);
  }
}
function cloudSaveDebounced(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(()=>cloudSave(), 900);
}
async function cloudSave(){
  try{
    const payload = { action:"save", token: APP_TOKEN, userKey: USER_KEY, state };
    const res = await fetchWithTimeout(SCRIPT_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.ok) setCloudPill("متصل ✓ (تم الحفظ)", true);
    else setCloudPill("رفض/توكن غير صحيح", false);
  }catch(e){
    setCloudPill("انقطاع (تم الحفظ محليًا)", false);
  }
}
async function cloudVisit(){
  try{
    const url = new URL(SCRIPT_URL);
    url.searchParams.set("action","visit");
    url.searchParams.set("userKey", USER_KEY);
    url.searchParams.set("token", APP_TOKEN);
    const res = await fetchWithTimeout(url.toString(), {method:"GET"});
    const data = await res.json();
    el("globalPill").textContent = "زيارات عالمية: " + (data.globalVisits ?? "—");
  }catch(e){
    el("globalPill").textContent = "زيارات عالمية: —";
  }
}
function saveAll(){
  saveLocal();
  cloudSaveDebounced();
}

/* visits */
function bumpLocalVisits(){
  const vk = "irs_visits_" + USER_KEY;
  const v = parseInt(localStorage.getItem(vk) || "0", 10) + 1;
  localStorage.setItem(vk, String(v));
  el("visitPill").textContent = "زيارات الجهاز: " + v;
}
function showUser(){ el("userPill").textContent = "مستخدم: " + USER_KEY; }

/* UI helpers */
function buildRecordTitle(rec){
  const typeLabel =
    rec.formType === "yearwork" ? "سجل أعمال السنة" :
    rec.formType === "monthly" ? "كشف متابعة شهري" :
    rec.formType === "plans" ? "خطط علاجية/إثرائية" :
    rec.formType === "counselor" ? "تحويل للموجهة" :
    rec.formType === "principal" ? "تحويل للمديرة" :
    rec.formType === "parent" ? "تبليغ ولي الأمر" : "سجل";

  const parts = [];
  parts.push(typeLabel);
  if(rec.academicYearAr) parts.push(rec.academicYearAr);
  if(rec.subject) parts.push(rec.subject);
  if(rec.classroom) parts.push(rec.classroom);
  return parts.join(" - ");
}

function refreshRecordSelect(){
  const sel = el("recordSelect");
  sel.innerHTML = "";
  state.records.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.id;
    opt.textContent = (r.title && r.title.trim()) ? r.title.trim() : buildRecordTitle(r);
    if(r.id === state.activeId) opt.selected = true;
    sel.appendChild(opt);
  });
}
function syncUI(){
  refreshRecordSelect();
  const rec = getActiveRecord();
  if(!rec){
    el("namesCountHint").textContent = "عدد الطالبات: 0";
    return;
  }

  el("formType").value = rec.formType === "grades" ? "yearwork" : rec.formType;
  el("subject").value = rec.subject || "";
  el("school").value = rec.school || "";
  el("classroom").value = rec.classroom || "";
  el("date").value = rec.date || "";
  el("termAr").value = rec.termAr || "الأول";
  el("academicYearAr").value = rec.academicYearAr || "";
  el("recordTitle").value = rec.title || "";

  el("teacherName").value = rec.signatures?.teacherName || "";
  el("principalName").value = rec.signatures?.principalName || "";

  el("namesCountHint").textContent = "عدد الطالبات: " + (rec.students?.length || 0);
}

/* Render */
function getFormTitle(rec){
  switch(rec.formType){
    case "yearwork": return `سجل أعمال السنة لعام ${rec.academicYearAr || "…"}`;
    case "monthly": return "كشف متابعة شهري";
    case "plans": return "متابعة الخطط العلاجية والإثرائية";
    case "counselor": return "نموذج تحويل للموجهة الطلابية";
    case "principal": return "نموذج تحويل للمديرة";
    case "parent": return "تبليغ لولي الأمر";
    default: return "استمارة";
  }
}

function makeFooter(text){
  const f = document.createElement("div");
  f.className = "footer-note";
  f.innerHTML = `<div>${escapeHtml(text)}</div>`;
  return f;
}
function makeSignatures(rec){
  const s = document.createElement("div");
  s.className = "signatures";
  s.innerHTML = `
    <div class="sig-box">
      <b>المعلمة:</b>
      <input class="sig-line" data-sig="teacherName" value="${escapeHtml(rec.signatures?.teacherName || "")}" placeholder="اكتبي اسم المعلمة هنا">
    </div>
    <div class="sig-box">
      <b>قائدة المدرسة:</b>
      <input class="sig-line" data-sig="principalName" value="${escapeHtml(rec.signatures?.principalName || "")}" placeholder="اكتبي اسم المديرة هنا">
    </div>
  `;
  return s;
}

function render(){
  const area = el("printArea");
  area.innerHTML = "";
  const rec = getActiveRecord();
  if(!rec){
    area.innerHTML = `<div style="padding:16px;color:var(--muted);font-weight:900">لا يوجد سجلات بعد. اضغطي “سجل جديد”.</div>`;
    return;
  }

  const header = document.createElement("div");
  header.className = "form-header";
  header.innerHTML = `
    <div>
      <h2>${escapeHtml(getFormTitle(rec))}</h2>
      <div class="sub" style="margin-top:4px;color:var(--muted)">
        ${rec.subject ? "العنوان/المادة: " + escapeHtml(rec.subject) : ""}
      </div>
      <div class="sub" style="margin-top:4px;color:var(--muted)">
        العام الدراسي: <b>${escapeHtml(rec.academicYearAr || "—")}</b> — الفصل: <b>${escapeHtml(rec.termAr || "—")}</b>
      </div>
    </div>
    <div class="meta">
      <div class="kv">المدرسة: ${escapeHtml(rec.school || "—")}</div>
      <div class="kv">الصف/الشعبة: ${escapeHtml(rec.classroom || "—")}</div>
      <div class="kv">التاريخ: ${escapeHtml(rec.date || "—")}</div>
      <div class="kv">السجل: ${escapeHtml((rec.title||"").trim() || buildRecordTitle(rec))}</div>
    </div>
  `;
  area.appendChild(header);

  if(rec.formType === "yearwork"){
    area.appendChild(renderYearwork(rec));
    area.appendChild(makeFooter("سجل أعمال السنة: إدخال تفاعلي + حفظ سحابي + سجلات متعددة."));
  } else if(rec.formType === "monthly"){
    area.appendChild(renderMonthly(rec));
    area.appendChild(makeFooter("الكشف الشهري: اضغطي داخل كل مربع للتبديل بين (فارغ / صح ✓ / خطأ ✗)."));
  } else if(rec.formType === "plans"){
    area.appendChild(renderPlans(rec));
    area.appendChild(makeFooter("خطط علاجية/إثرائية: اختاري الصف/المادة/المهارة + القبلي/البعدي (وصفي) + نوع الإجراء."));
  } else if(rec.formType === "counselor" || rec.formType === "principal"){
    area.appendChild(renderReferral(rec));
    area.appendChild(makeFooter("نموذج تحويل: يطبع ويحفظ PDF مع توقيع المعلمة والمديرة."));
  } else if(rec.formType === "parent"){
    area.appendChild(renderParent(rec));
    area.appendChild(makeFooter("تبليغ ولي الأمر: املئي النموذج ثم اطبعي أو احفظي PDF."));
  }

  area.appendChild(makeSignatures(rec));
  wireDynamicInputs(rec);
}

/* =========================
   (1) سجل أعمال السنة لعام
   ========================= */
function renderYearwork(rec){
  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  const bulk = document.createElement("div");
  bulk.className = "no-print";
  bulk.style.border = "1px solid var(--line)";
  bulk.style.borderRadius = "12px";
  bulk.style.padding = "10px";
  bulk.style.marginBottom = "10px";
  bulk.innerHTML = `
    <div style="font-weight:900; margin-bottom:8px;">تعميم درجة على عمود كامل</div>
    <div class="row3">
      <div>
        <label>اختاري العمود</label>
        <select id="bulkCol">
          <option value="p1_a">الفترة الأولى: المهام الأدائية (40)</option>
          <option value="p1_b">الفترة الأولى: تقويمات تحريرية (20)</option>
          <option value="p2_a">الفترة الثانية: المهام الأدائية (40)</option>
          <option value="p2_b">الفترة الثانية: تقويمات تحريرية (20)</option>
          <option value="final">اختبار نهاية الفصل (40)</option>
        </select>
      </div>
      <div>
        <label>اكتبي الدرجة</label>
        <input id="bulkVal" inputmode="numeric" placeholder="مثال: 40" />
      </div>
      <div style="display:flex;align-items:end;gap:8px;">
        <button class="primary" id="btnApplyBulk" style="width:100%;">تطبيق على جميع الطالبات</button>
      </div>
    </div>
  `;
  wrap.appendChild(bulk);

  // Desktop table
  const tableWrap = document.createElement("div");
  tableWrap.className = "desktop-only";
  const table = document.createElement("table");
  table.id = "yearworkTable";

  const thead = document.createElement("thead");
  thead.innerHTML = `
    <tr>
      <th rowspan="2" class="total">م</th>
      <th rowspan="2" class="total namecell">اسم الطالبة</th>

      <th colspan="3" class="p1">الفترة الأولى</th>
      <th colspan="3" class="p2">الفترة الثانية</th>

      <th rowspan="2" class="sum">مجموع الفترتين</th>
      <th rowspan="2" class="avg">متوسط مجموع الفترتين</th>
      <th rowspan="2" class="final">اختبار نهاية الفصل</th>
      <th rowspan="2" class="total">المجموع الكلي</th>
    </tr>
    <tr>
      <th class="p1">المهام الأدائية<br><b>(40)</b></th>
      <th class="p1">تقويمات تحريرية<br><b>(20)</b></th>
      <th class="p1">المجموع<br><b>(60)</b></th>

      <th class="p2">المهام الأدائية<br><b>(40)</b></th>
      <th class="p2">تقويمات تحريرية<br><b>(20)</b></th>
      <th class="p2">المجموع<br><b>(60)</b></th>
    </tr>
  `;
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  const students = rec.students || [];
  for(let i=0;i<students.length;i++){
    const st = students[i];
    const p1a = clampNum(st.p1_a ?? 0, YEARWORK_SCHEMA.p1A);
    const p1b = clampNum(st.p1_b ?? 0, YEARWORK_SCHEMA.p1B);
    const p2a = clampNum(st.p2_a ?? 0, YEARWORK_SCHEMA.p2A);
    const p2b = clampNum(st.p2_b ?? 0, YEARWORK_SCHEMA.p2B);
    const fin = clampNum(st.final ?? 0, YEARWORK_SCHEMA.final);

    const p1t = p1a + p1b;
    const p2t = p2a + p2b;
    const sum = p1t + p2t;
    const avg = Math.round((sum/2)*10)/10;
    const total = Math.round((avg + fin)*10)/10;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="total">${i+1}</td>
      <td class="total namecell">
        <input class="inline-input name" data-kind="name" data-i="${i}" value="${escapeHtml(st.name || "")}" placeholder="اسم الطالبة">
      </td>

      <td class="p1"><input class="inline-input" data-kind="p1_a" data-i="${i}" inputmode="numeric" value="${p1a}"></td>
      <td class="p1"><input class="inline-input" data-kind="p1_b" data-i="${i}" inputmode="numeric" value="${p1b}"></td>
      <td class="p1"><b>${p1t}</b></td>

      <td class="p2"><input class="inline-input" data-kind="p2_a" data-i="${i}" inputmode="numeric" value="${p2a}"></td>
      <td class="p2"><input class="inline-input" data-kind="p2_b" data-i="${i}" inputmode="numeric" value="${p2b}"></td>
      <td class="p2"><b>${p2t}</b></td>

      <td class="sum"><b>${sum}</b></td>
      <td class="avg"><b>${avg}</b></td>
      <td class="final"><input class="inline-input" data-kind="final" data-i="${i}" inputmode="numeric" value="${fin}"></td>
      <td class="total"><b>${total}</b></td>
    `;
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  tableWrap.appendChild(table);
  wrap.appendChild(tableWrap);

  // Mobile cards
  const cardsWrap = document.createElement("div");
  cardsWrap.className = "mobile-only";
  cardsWrap.innerHTML = `<div class="mini-title">إدخال الدرجات (عرض الجوال)</div>`;
  for(let i=0;i<(rec.students||[]).length;i++){
    const st = rec.students[i];
    const p1a = clampNum(st.p1_a ?? 0, 40);
    const p1b = clampNum(st.p1_b ?? 0, 20);
    const p2a = clampNum(st.p2_a ?? 0, 40);
    const p2b = clampNum(st.p2_b ?? 0, 20);
    const fin = clampNum(st.final ?? 0, 40);

    const p1t = p1a + p1b;
    const p2t = p2a + p2b;
    const sum = p1t + p2t;
    const avg = Math.round((sum/2)*10)/10;
    const total = Math.round((avg + fin)*10)/10;

    const card = document.createElement("div");
    card.className = "student-card";
    card.innerHTML = `
      <div class="head">
        <div class="idx">م ${i+1}</div>
        <div style="flex:1">
          <input class="inline-input name" data-kind="name" data-i="${i}" value="${escapeHtml(st.name||"")}" placeholder="اسم الطالبة">
        </div>
      </div>
      <div class="grid">
        <div class="field"><b>ف1 مهام (40)</b><input class="inline-input" data-kind="p1_a" data-i="${i}" inputmode="numeric" value="${p1a}"></div>
        <div class="field"><b>ف1 تحريرية (20)</b><input class="inline-input" data-kind="p1_b" data-i="${i}" inputmode="numeric" value="${p1b}"></div>
        <div class="field"><b>ف2 مهام (40)</b><input class="inline-input" data-kind="p2_a" data-i="${i}" inputmode="numeric" value="${p2a}"></div>
        <div class="field"><b>ف2 تحريرية (20)</b><input class="inline-input" data-kind="p2_b" data-i="${i}" inputmode="numeric" value="${p2b}"></div>
        <div class="field"><b>اختبار (40)</b><input class="inline-input" data-kind="final" data-i="${i}" inputmode="numeric" value="${fin}"></div>
        <div class="field"><b>المجموع الكلي</b><div style="font-weight:900">${total}</div></div>
      </div>
    `;
    cardsWrap.appendChild(card);
  }
  wrap.appendChild(cardsWrap);

  setTimeout(()=>{
    const btn = document.getElementById("btnApplyBulk");
    if(btn){
      btn.onclick = ()=>{
        const col = document.getElementById("bulkCol").value;
        const valRaw = document.getElementById("bulkVal").value;
        const maxMap = { p1_a: 40, p1_b: 20, p2_a: 40, p2_b: 20, final: 40 };
        const v = clampNum(valRaw, maxMap[col]);
        (rec.students||[]).forEach(s=>{ s[col] = v; });
        touchRecord(rec);
        saveAll();
        render(); // إعادة حساب بعد العملية فقط
      };
    }
  },0);

  return wrap;
}

/* =========================
   (2) كشف متابعة شهري (صح/خطأ)
   ========================= */
function renderMonthly(rec){
  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  const m = rec.monthly || (rec.monthly = {year:new Date().getFullYear(), month:new Date().getMonth()+1, sessions:8, criteria:[]});
  if(!m.criteria || m.criteria.length===0){
    m.criteria = [
      {key:"participation", label:"المشاركة", cls:"part"},
      {key:"homework", label:"الواجبات", cls:"home"},
      {key:"performance", label:"المهام الأدائية", cls:"perf"},
      {key:"classwork", label:"أنشطة صفية", cls:"class"}
    ];
  }

  // Controls
  const ctrl = document.createElement("div");
  ctrl.className = "no-print";
  ctrl.style.border = "1px solid var(--line)";
  ctrl.style.borderRadius = "12px";
  ctrl.style.padding = "10px";
  ctrl.style.marginBottom = "10px";
  ctrl.innerHTML = `
    <div class="row3">
      <div>
        <label>الشهر</label>
        <select id="mMonth">
          ${Array.from({length:12},(_,i)=>`<option value="${i+1}">${monthNameAr(i+1)}</option>`).join("")}
        </select>
      </div>
      <div>
        <label>السنة (ميلادي)</label>
        <input id="mYear" inputmode="numeric" value="${m.year}">
      </div>
      <div>
        <label>عدد المربعات لكل معيار (4–12)</label>
        <input id="mSessions" inputmode="numeric" value="${m.sessions}">
      </div>
    </div>
    <div class="hint">طريقة الاستخدام: اضغطي على المربع للتبديل بين (فارغ → ✓ → ✗).</div>
  `;
  wrap.appendChild(ctrl);

  // Ensure student monthly map
  (rec.students||[]).forEach(st=>{
    st.monthly = st.monthly || {};
    m.criteria.forEach(c=>{
      if(!Array.isArray(st.monthly[c.key])) st.monthly[c.key] = Array.from({length:m.sessions},()=>0); // 0 blank, 1 ok, -1 bad
      if(st.monthly[c.key].length !== m.sessions){
        const old = st.monthly[c.key];
        st.monthly[c.key] = Array.from({length:m.sessions},(_,i)=>old[i]??0);
      }
    });
  });

  // Desktop table
  const desktop = document.createElement("div");
  desktop.className = "desktop-only";

  const table = document.createElement("table");
  const head1 = document.createElement("thead");

  const sessions = Math.max(4, Math.min(12, parseInt(m.sessions||8,10) || 8));
  const critCols = m.criteria.map(c=>`<th class="crit-h ${c.cls}" colspan="${sessions}">${escapeHtml(c.label)}</th>`).join("");

  head1.innerHTML = `
    <tr>
      <th class="total" rowspan="2">م</th>
      <th class="total namecell" rowspan="2">الاسم</th>
      ${critCols}
    </tr>
    <tr>
      ${m.criteria.map(()=>Array.from({length:sessions},(_,i)=>`<th class="total">${i+1}</th>`).join("")).join("")}
    </tr>
  `;
  table.appendChild(head1);

  const tbody = document.createElement("tbody");
  for(let i=0;i<(rec.students||[]).length;i++){
    const st = rec.students[i];
    const tr = document.createElement("tr");

    let cells = "";
    m.criteria.forEach(c=>{
      for(let k=0;k<sessions;k++){
        const v = (st.monthly?.[c.key]?.[k]) ?? 0;
        const cls = v===1 ? "ok" : v===-1 ? "bad" : "neu";
        const txt = v===1 ? "✓" : v===-1 ? "✗" : "";
        cells += `<td><button class="mark-btn ${cls}" data-m="1" data-i="${i}" data-crit="${c.key}" data-k="${k}">${txt}</button></td>`;
      }
    });

    tr.innerHTML = `
      <td class="total">${i+1}</td>
      <td class="total namecell">
        <input class="inline-input name" data-kind="name_only" data-i="${i}" value="${escapeHtml(st.name||"")}" placeholder="اسم الطالبة">
      </td>
      ${cells}
    `;
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  desktop.appendChild(table);
  wrap.appendChild(desktop);

  // Mobile cards
  const mobile = document.createElement("div");
  mobile.className = "mobile-only";
  mobile.innerHTML = `<div class="mini-title">كشف المتابعة الشهري (عرض الجوال)</div>`;
  for(let i=0;i<(rec.students||[]).length;i++){
    const st = rec.students[i];
    const card = document.createElement("div");
    card.className = "student-card";
    card.innerHTML = `
      <div class="head">
        <div class="idx">م ${i+1}</div>
        <div style="flex:1">
          <input class="inline-input name" data-kind="name_only" data-i="${i}" value="${escapeHtml(st.name||"")}" placeholder="اسم الطالبة">
        </div>
      </div>
      ${m.criteria.map(c=>{
        const btns = Array.from({length:sessions},(_,k)=>{
          const v = (st.monthly?.[c.key]?.[k]) ?? 0;
          const cls = v===1 ? "ok" : v===-1 ? "bad" : "neu";
          const txt = v===1 ? "✓" : v===-1 ? "✗" : "";
          return `<button class="mark-btn ${cls}" data-m="1" data-i="${i}" data-crit="${c.key}" data-k="${k}" style="margin:2px">${txt}</button>`;
        }).join("");
        return `<div class="field" style="margin-top:8px"><b>${escapeHtml(c.label)}</b><div style="display:flex;flex-wrap:wrap;gap:6px">${btns}</div></div>`;
      }).join("")}
    `;
    mobile.appendChild(card);
  }
  wrap.appendChild(mobile);

  // Hook control changes
  setTimeout(()=>{
    const sm = document.getElementById("mMonth");
    const sy = document.getElementById("mYear");
    const ss = document.getElementById("mSessions");
    if(sm){ sm.value = String(m.month||1); }

    const applyMonthlySettings = ()=>{
      const rec = getActiveRecord(); if(!rec) return;
      const mm = rec.monthly || (rec.monthly={});
      mm.month = parseInt(sm.value,10) || 1;
      mm.year  = parseInt((sy.value||"").replace(/\D/g,""),10) || (new Date().getFullYear());
      const newSessions = Math.max(4, Math.min(12, parseInt((ss.value||"").replace(/\D/g,""),10) || 8));
      mm.sessions = newSessions;

      // Resize arrays
      (rec.students||[]).forEach(st=>{
        st.monthly = st.monthly || {};
        (mm.criteria||[]).forEach(c=>{
          const old = Array.isArray(st.monthly[c.key]) ? st.monthly[c.key] : [];
          st.monthly[c.key] = Array.from({length:newSessions},(_,i)=>old[i] ?? 0);
        });
      });

      touchRecord(rec); saveAll(); render();
    };

    sm?.addEventListener("change", applyMonthlySettings);
    sy?.addEventListener("blur", applyMonthlySettings);
    ss?.addEventListener("blur", applyMonthlySettings);
  },0);

  return wrap;
}

/* =========================
   (3) الخطط العلاجية / الإثرائية
   ========================= */
function renderPlans(rec){
  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  rec.plans = rec.plans || { entries: [] };

  const controls = document.createElement("div");
  controls.className = "no-print";
  controls.style.border = "1px solid var(--line)";
  controls.style.borderRadius = "12px";
  controls.style.padding = "10px";
  controls.style.marginBottom = "10px";
  controls.innerHTML = `
    <div class="row3">
      <button class="primary" id="btnAddPlanRow">إضافة خطة جديدة</button>
      <button id="btnAddPlanRowForAll">إضافة صف جديد فارغ</button>
      <button class="danger" id="btnClearPlans">مسح كل الخطط في هذا السجل</button>
    </div>
    <div class="hint">القبلي/البعدي وصفي (متفوق/جيد/…)، ويمكن اختيار المهارة أو كتابة مهارة جديدة.</div>
  `;
  wrap.appendChild(controls);

  const desktop = document.createElement("div");
  desktop.className = "desktop-only";

  const table = document.createElement("table");
  table.innerHTML = `
    <thead>
      <tr>
        <th class="total">م</th>
        <th class="total">التاريخ</th>
        <th class="total">الصف</th>
        <th class="total">المادة</th>
        <th class="total">نوع الخطة</th>
        <th class="total">المهارة</th>
        <th class="total">القبلي</th>
        <th class="total">البعدي</th>
        <th class="total">نوع الإجراء</th>
        <th class="total">ملاحظات</th>
        <th class="total">حذف</th>
      </tr>
    </thead>
    <tbody id="plansBody"></tbody>
  `;
  desktop.appendChild(table);
  wrap.appendChild(desktop);

  const mobile = document.createElement("div");
  mobile.className = "mobile-only";
  mobile.innerHTML = `<div class="mini-title">الخطط (عرض الجوال)</div>`;
  wrap.appendChild(mobile);

  // render rows
  const body = table.querySelector("#plansBody");
  body.innerHTML = "";

  const entries = rec.plans.entries || [];
  const gradeOpts = ["الأول","الثاني","الثالث","الرابع","الخامس","السادس"];
  const subjectOpts = ["علوم","رياضيات","لغتي","دراسات","انجليزي","مهارات رقمية","أخرى"];

  entries.forEach((row, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="total">${idx+1}</td>
      <td><input class="inline-input" data-plan="date" data-idx="${idx}" type="date" value="${escapeHtml(row.date||"")}"></td>
      <td>
        <select class="inline-input" data-plan="grade" data-idx="${idx}">
          ${gradeOpts.map(g=>`<option value="${g}" ${row.grade===g?"selected":""}>${g}</option>`).join("")}
        </select>
      </td>
      <td>
        <select class="inline-input" data-plan="subject" data-idx="${idx}">
          ${subjectOpts.map(s=>`<option value="${s}" ${row.subject===s?"selected":""}>${s}</option>`).join("")}
        </select>
      </td>
      <td>
        <select class="inline-input" data-plan="type" data-idx="${idx}">
          <option value="علاجية" ${row.type==="علاجية"?"selected":""}>علاجية</option>
          <option value="إثرائية" ${row.type==="إثرائية"?"selected":""}>إثرائية</option>
        </select>
      </td>
      <td>
        <select class="inline-input" data-plan="skill" data-idx="${idx}">
          ${getSkillOptions(row.grade, row.subject, row.skill)}
        </select>
        <div class="no-print" style="margin-top:6px">
          <input class="inline-input" data-plan="skill_custom" data-idx="${idx}" placeholder="أو اكتبي مهارة جديدة ثم اضغطي Enter" value="">
        </div>
      </td>
      <td>
        <select class="inline-input" data-plan="pre" data-idx="${idx}">
          ${LEVEL_WORDS.map(x=>`<option value="${x}" ${row.pre===x?"selected":""}>${x}</option>`).join("")}
        </select>
      </td>
      <td>
        <select class="inline-input" data-plan="post" data-idx="${idx}">
          ${LEVEL_WORDS.map(x=>`<option value="${x}" ${row.post===x?"selected":""}>${x}</option>`).join("")}
        </select>
      </td>
      <td>
        <select class="inline-input" data-plan="action" data-idx="${idx}">
          ${ACTION_TYPES.map(x=>`<option value="${x}" ${row.action===x?"selected":""}>${x}</option>`).join("")}
        </select>
      </td>
      <td><input class="inline-input" data-plan="notes" data-idx="${idx}" value="${escapeHtml(row.notes||"")}" placeholder="ملاحظات"></td>
      <td class="total"><button class="danger no-print" data-plan="del" data-idx="${idx}">حذف</button></td>
    `;
    body.appendChild(tr);

    // mobile card
    const card = document.createElement("div");
    card.className = "student-card";
    card.innerHTML = `
      <div class="head"><div class="idx">خطة ${idx+1}</div></div>
      <div class="grid">
        <div class="field"><b>التاريخ</b><input class="inline-input" data-plan="date" data-idx="${idx}" type="date" value="${escapeHtml(row.date||"")}"></div>
        <div class="field"><b>الصف</b>
          <select class="inline-input" data-plan="grade" data-idx="${idx}">
            ${gradeOpts.map(g=>`<option value="${g}" ${row.grade===g?"selected":""}>${g}</option>`).join("")}
          </select>
        </div>
        <div class="field"><b>المادة</b>
          <select class="inline-input" data-plan="subject" data-idx="${idx}">
            ${subjectOpts.map(s=>`<option value="${s}" ${row.subject===s?"selected":""}>${s}</option>`).join("")}
          </select>
        </div>
        <div class="field"><b>نوع الخطة</b>
          <select class="inline-input" data-plan="type" data-idx="${idx}">
            <option value="علاجية" ${row.type==="علاجية"?"selected":""}>علاجية</option>
            <option value="إثرائية" ${row.type==="إثرائية"?"selected":""}>إثرائية</option>
          </select>
        </div>
        <div class="field" style="grid-column:1/-1"><b>المهارة</b>
          <select class="inline-input" data-plan="skill" data-idx="${idx}">
            ${getSkillOptions(row.grade, row.subject, row.skill)}
          </select>
          <div class="no-print" style="margin-top:6px">
            <input class="inline-input" data-plan="skill_custom" data-idx="${idx}" placeholder="أو اكتبي مهارة جديدة ثم Enter" value="">
          </div>
        </div>
        <div class="field"><b>القبلي</b>
          <select class="inline-input" data-plan="pre" data-idx="${idx}">
            ${LEVEL_WORDS.map(x=>`<option value="${x}" ${row.pre===x?"selected":""}>${x}</option>`).join("")}
          </select>
        </div>
        <div class="field"><b>البعدي</b>
          <select class="inline-input" data-plan="post" data-idx="${idx}">
            ${LEVEL_WORDS.map(x=>`<option value="${x}" ${row.post===x?"selected":""}>${x}</option>`).join("")}
          </select>
        </div>
        <div class="field"><b>الإجراء</b>
          <select class="inline-input" data-plan="action" data-idx="${idx}">
            ${ACTION_TYPES.map(x=>`<option value="${x}" ${row.action===x?"selected":""}>${x}</option>`).join("")}
          </select>
        </div>
        <div class="field"><b>ملاحظات</b><input class="inline-input" data-plan="notes" data-idx="${idx}" value="${escapeHtml(row.notes||"")}" placeholder="ملاحظات"></div>
        <div class="field" style="grid-column:1/-1">
          <button class="danger no-print" data-plan="del" data-idx="${idx}" style="width:100%">حذف هذه الخطة</button>
        </div>
      </div>
    `;
    mobile.appendChild(card);
  });

  // Hook control buttons
  setTimeout(()=>{
    const btnAdd = document.getElementById("btnAddPlanRow");
    const btnAdd2 = document.getElementById("btnAddPlanRowForAll");
    const btnClear = document.getElementById("btnClearPlans");

    const addRow = ()=>{
      const rec = getActiveRecord(); if(!rec) return;
      rec.plans = rec.plans || {entries:[]};
      rec.plans.entries.push({
        date: rec.date || "",
        grade: "السادس",
        subject: "علوم",
        type: "علاجية",
        skill: "",
        pre: LEVEL_WORDS[1],
        post: LEVEL_WORDS[1],
        action: ACTION_TYPES[0],
        notes: ""
      });
      touchRecord(rec); saveAll(); render();
    };

    btnAdd?.addEventListener("click", addRow);
    btnAdd2?.addEventListener("click", addRow);
    btnClear?.addEventListener("click", ()=>{
      const rec = getActiveRecord(); if(!rec) return;
      if(!confirm("تأكيد مسح كل الخطط في هذا السجل؟")) return;
      rec.plans.entries = [];
      touchRecord(rec); saveAll(); render();
    });
  },0);

  return wrap;
}

function getSkillOptions(grade, subject, current){
  const g = grade || "السادس";
  const s = subject || "علوم";
  const list = (SKILLS[g] && SKILLS[g][s]) ? SKILLS[g][s] : ["أضيفي مهاراتك هنا"];
  const opts = [`<option value="" ${!current?"selected":""}>— اختر المهارة —</option>`]
    .concat(list.map(x=>`<option value="${escapeHtml(x)}" ${current===x?"selected":""}>${escapeHtml(x)}</option>`))
    .concat(current && !list.includes(current) ? [`<option value="${escapeHtml(current)}" selected>${escapeHtml(current)}</option>`] : []);
  return opts.join("");
}

/* =========================
   (4) التحويل (موجهة/مديرة)
   ========================= */
function renderReferral(rec){
  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  const r = rec.referral || (rec.referral = {studentName:"",receiver:"",reason:"",details:"",suggestedActions:"",notes:""});
  const receiverDefault = rec.formType === "counselor" ? "الموجهة الطلابية" : "قائدة المدرسة";
  if(!r.receiver) r.receiver = receiverDefault;

  wrap.innerHTML = `
    <div style="padding:12px">
      <div class="row">
        <div>
          <label>اسم الطالبة</label>
          <input data-ref="studentName" value="${escapeHtml(r.studentName||"")}" placeholder="اسم الطالبة">
        </div>
        <div>
          <label>الجهة المحوّل إليها</label>
          <input data-ref="receiver" value="${escapeHtml(r.receiver||receiverDefault)}" placeholder="مثال: الموجهة الطلابية">
        </div>
      </div>

      <div style="margin-top:10px">
        <label>سبب التحويل</label>
        <input data-ref="reason" value="${escapeHtml(r.reason||"")}" placeholder="مثال: تكرار الغياب / سلوك / ضعف تحصيلي">
      </div>

      <div style="margin-top:10px">
        <label>تفاصيل الحالة</label>
        <textarea data-ref="details" placeholder="اكتبي تفاصيل مختصرة وواضحة">${escapeHtml(r.details||"")}</textarea>
      </div>

      <div style="margin-top:10px">
        <label>إجراءات مقترحة / توصيات</label>
        <textarea data-ref="suggestedActions" placeholder="مثال: متابعة أسبوعية / خطة علاجية / تواصل مع ولي الأمر">${escapeHtml(r.suggestedActions||"")}</textarea>
      </div>

      <div style="margin-top:10px">
        <label>ملاحظات إضافية</label>
        <textarea data-ref="notes">${escapeHtml(r.notes||"")}</textarea>
      </div>
    </div>
  `;

  return wrap;
}

/* =========================
   (5) تبليغ ولي الأمر
   ========================= */
function renderParent(rec){
  const wrap = document.createElement("div");
  wrap.style.padding = "12px";

  const p = rec.parent || (rec.parent = {studentName:"",parentName:"",parentPhone:"",message:"",notes:""});
  if(!p.message){
    p.message = "نفيدكم بمستوى ابنتكم واحتياجها للمتابعة، ونأمل التعاون لتحقيق تقدم أفضل. شاكرين لكم تعاونكم.";
  }

  wrap.innerHTML = `
    <div style="padding:12px">
      <div class="row">
        <div>
          <label>اسم الطالبة</label>
          <input data-par="studentName" value="${escapeHtml(p.studentName||"")}" placeholder="اسم الطالبة">
        </div>
        <div>
          <label>اسم ولي الأمر</label>
          <input data-par="parentName" value="${escapeHtml(p.parentName||"")}" placeholder="اسم ولي الأمر">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>رقم الجوال</label>
          <input data-par="parentPhone" inputmode="tel" value="${escapeHtml(p.parentPhone||"")}" placeholder="05xxxxxxxx">
        </div>
        <div>
          <label>ملاحظات</label>
          <input data-par="notes" value="${escapeHtml(p.notes||"")}" placeholder="اختياري">
        </div>
      </div>

      <div style="margin-top:10px">
        <label>نص التبليغ</label>
        <textarea data-par="message">${escapeHtml(p.message||"")}</textarea>
      </div>

      <div class="status no-print" style="margin-top:10px">
        للتصدير PDF: اضغطي زر (حفظ/تصدير PDF) بالأعلى ثم <b>Save to Files</b> على الآيفون.
      </div>
    </div>
  `;

  return wrap;
}

/* =========================
   Wiring: مهم جداً لمنع تقطيع الكتابة
   - الحفظ أثناء الكتابة
   - إعادة حساب الجداول فقط عند blur/change أو عمليات محددة
   ========================= */
function wireDynamicInputs(rec){

  // Signatures
  document.querySelectorAll("#printArea [data-sig]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const key = inp.dataset.sig;
      rec.signatures = rec.signatures || {};
      rec.signatures[key] = inp.value;
      touchRecord(rec); saveAll(); syncUI();
    });
  });

  // Yearwork inputs: لا نعمل render على كل حرف
  document.querySelectorAll("#printArea input.inline-input[data-kind]").forEach(inp=>{
    const i = Number(inp.dataset.i);
    const kind = inp.dataset.kind;

    const applyValue = ()=>{
      if(!rec.students[i]) return;
      if(kind === "name"){
        rec.students[i].name = inp.value;
      }else{
        const maxMap = { p1_a: 40, p1_b: 20, p2_a: 40, p2_b: 20, final: 40 };
        rec.students[i][kind] = clampNum(inp.value, maxMap[kind]);
      }
      touchRecord(rec);
      saveAll();
      syncUI();
    };

    inp.addEventListener("input", applyValue);
    inp.addEventListener("blur", ()=>{ applyValue(); render(); });
    inp.addEventListener("change", ()=>{ applyValue(); render(); });
  });

  // Monthly: toggle buttons (بدون render كامل)
  document.querySelectorAll("#printArea button[data-m='1']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = Number(btn.dataset.i);
      const crit = btn.dataset.crit;
      const k = Number(btn.dataset.k);

      const st = rec.students[i];
      st.monthly = st.monthly || {};
      const arr = st.monthly[crit] || (st.monthly[crit] = []);
      const cur = arr[k] ?? 0;
      const next = cur === 0 ? 1 : cur === 1 ? -1 : 0;
      arr[k] = next;

      // update button ui
      btn.classList.remove("ok","bad","neu");
      if(next===1){ btn.classList.add("ok"); btn.textContent="✓"; }
      else if(next===-1){ btn.classList.add("bad"); btn.textContent="✗"; }
      else { btn.classList.add("neu"); btn.textContent=""; }

      touchRecord(rec); saveAll();
    });
  });

  // Monthly name-only
  document.querySelectorAll("#printArea input[data-kind='name_only']").forEach(inp=>{
    const i = Number(inp.dataset.i);
    inp.addEventListener("input", ()=>{
      if(rec.students[i]) rec.students[i].name = inp.value;
      touchRecord(rec); saveAll(); syncUI();
    });
  });

  // Plans inputs (event delegation)
  document.querySelectorAll("#printArea [data-plan]").forEach(inp=>{
    const idx = Number(inp.dataset.idx);
    const key = inp.dataset.plan;

    const apply = ()=>{
      const row = rec.plans?.entries?.[idx];
      if(!row) return;

      if(key === "del"){
        rec.plans.entries.splice(idx,1);
        touchRecord(rec); saveAll(); render();
        return;
      }

      if(key === "skill_custom"){
        // عند Enter: نثبت المهارة
        return;
      }

      row[key] = (inp.value ?? "").toString();
      touchRecord(rec); saveAll();
    };

    if(key === "del"){
      inp.addEventListener("click", apply);
    } else if(key === "skill_custom"){
      inp.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          const row = rec.plans?.entries?.[idx];
          if(!row) return;
          const val = (inp.value||"").trim();
          if(!val) return;
          row.skill = val;
          inp.value = "";
          touchRecord(rec); saveAll(); render();
        }
      });
    } else {
      inp.addEventListener("input", apply);
      inp.addEventListener("change", ()=>{
        apply();
        // لو تغير الصف/المادة نعيد رسم خيارات المهارات
        if(key==="grade" || key==="subject") render();
      });
    }
  });

  // Referral
  document.querySelectorAll("#printArea [data-ref]").forEach(inp=>{
    const key = inp.dataset.ref;
    inp.addEventListener("input", ()=>{
      rec.referral = rec.referral || {};
      rec.referral[key] = inp.value;
      touchRecord(rec); saveAll();
    });
  });

  // Parent
  document.querySelectorAll("#printArea [data-par]").forEach(inp=>{
    const key = inp.dataset.par;
    inp.addEventListener("input", ()=>{
      rec.parent = rec.parent || {};
      rec.parent[key] = inp.value;
      touchRecord(rec); saveAll();
    });
  });
}

/* Names */
function setStudentsFromNames(rec, names){
  const clean = names.map(s=>(s||"").toString().trim()).filter(s=>s.length>=2);
  // نضيف حقول لازمة لكل الاستمارات
  rec.students = clean.map(name=>({
    name,
    p1_a:0, p1_b:0, p2_a:0, p2_b:0, final:0,
    monthly:{}
  }));
  touchRecord(rec);
  saveAll();
  syncUI();
  render();
}
function parseCSV(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const names = [];
  for(const line of lines){
    const parts = line.split(/[;,]/).map(x=>x.trim()).filter(Boolean);
    if(parts.length===0) continue;
    if(names.length===0 && /اسم|name/i.test(parts[0])) continue;
    names.push(parts[0]);
  }
  return names;
}
async function ocrNamesFromImage(file){
  el("cloudStatus").innerHTML = "<b>OCR:</b> جاري استخراج النص من الصورة…";
  try{
    const { data } = await Tesseract.recognize(file, "ara");
    const text = (data.text || "").trim();
    const names = text.split(/\r?\n/).map(s=>s.trim()).filter(s=>s && s.length>=2);
    el("namesPaste").value = names.join("\n");
    el("cloudStatus").innerHTML = "<b>OCR:</b> تم. اضغطي (تطبيق الأسماء).";
  }catch(e){
    el("cloudStatus").innerHTML = "<b>OCR:</b> تعذر الاستخراج. استخدمي CSV أو اللصق.";
  }
}

/* Print & PDF (يعمل على الجوال: مشاركة -> حفظ في الملفات) */
function doPrint(){ window.print(); }

async function exportPDF(){
  const btn = el("btnPDF");
  btn.disabled = true;
  btn.textContent = "جاري تجهيز PDF…";

  try{
    const rec = getActiveRecord();
    const area = el("printArea");

    const canvas = await html2canvas(area, { scale: 2, useCORS: true, backgroundColor:"#ffffff" });
    const imgData = canvas.toDataURL("image/png");

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation:"landscape", unit:"mm", format:"a4" });

    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const imgW = pageW;
    const imgH = (canvas.height * imgW) / canvas.width;

    if(imgH <= pageH){
      pdf.addImage(imgData, "PNG", 0, 0, imgW, imgH);
    }else{
      let position = 0;
      let remaining = imgH;
      while(remaining > 0){
        pdf.addImage(imgData, "PNG", 0, position, imgW, imgH);
        remaining -= pageH;
        if(remaining > 0){
          pdf.addPage();
          position -= pageH;
        }
      }
    }

    const safeTitle = ((rec.title||"سجل").trim() || "سجل").replace(/[\\/:*?"<>|]/g,"-");
    const filename = safeTitle + ".pdf";

    const blob = pdf.output("blob");
    const file = new File([blob], filename, {type:"application/pdf"});

    // iOS/Android share (Save to Files)
    if(navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
      await navigator.share({ files:[file], title: filename });
    } else if(navigator.share){
      try{ await navigator.share({ files:[file], title: filename }); }
      catch(_){
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
      }
    } else {
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank");
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 8000);
    }
  } finally {
    btn.disabled = false;
    btn.textContent = "حفظ/تصدير PDF";
  }
}

/* Records */
function addRecord(rec){
  state.records.push(rec);
  state.activeId = rec.id;
}
function ensureAtLeastOneRecord(){
  if(state.records.length === 0){
    const r = defaultRecord({title:"سجل أول"});
    addRecord(r);
  }
}

/* Login */
function showLoginOverlay(force=false){
  const overlay = el("loginOverlay");
  if(force) overlay.classList.add("show");
  else overlay.classList.toggle("show");
}
function redirectToUser(name){
  const u = (name||"").trim();
  const params = new URLSearchParams(location.search);
  if(u) params.set("user", u);
  else params.delete("user");
  location.search = params.toString();
}

/* Events */
function attachTopEvents(){
  el("recordSelect").addEventListener("change", (e)=>{
    state.activeId = e.target.value;
    saveLocal();
    syncUI();
    render();
  });

  el("btnNewRecord").addEventListener("click", ()=>{
    const base = getActiveRecord();
    const r = defaultRecord({
      school: base?.school || "",
      termAr: base?.termAr || "الأول",
      academicYearAr: base?.academicYearAr || "١٤٤٦هـ",
      teacherName: base?.signatures?.teacherName || "",
      principalName: base?.signatures?.principalName || "",
      formType: base?.formType || "yearwork"
    });
    r.title = "سجل جديد (اكتبي الاسم هنا)";
    addRecord(r);
    saveAll();
    syncUI();
    render();

    setTimeout(()=>{
      el("recordTitle").focus();
      el("recordTitle").select();
    }, 60);
  });

  el("btnFocusTitle").addEventListener("click", ()=>{
    el("recordTitle").focus();
    el("recordTitle").select();
  });

  el("btnDuplicateRecord").addEventListener("click", ()=>{
    const rec = getActiveRecord();
    if(!rec) return;
    const clone = JSON.parse(JSON.stringify(rec));
    clone.id = uid();
    clone.title = ((rec.title||"سجل") + " (نسخة)");
    clone.createdAt = new Date().toISOString();
    clone.updatedAt = new Date().toISOString();
    addRecord(clone);
    saveAll(); syncUI(); render();
  });

  el("btnDeleteRecord").addEventListener("click", ()=>{
    const rec = getActiveRecord();
    if(!rec) return;
    if(!confirm("تأكيد حذف السجل الحالي؟")) return;
    state.records = state.records.filter(r=>r.id !== rec.id);
    state.activeId = state.records[0]?.id || null;
    saveAll(); syncUI(); render();
  });

  el("btnCreateMany").addEventListener("click", ()=>{
    const txt = el("bulkRecords").value.trim();
    if(!txt) return;
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(lines.length === 0) return;

    const base = getActiveRecord();
    lines.forEach(line=>{
      const r = defaultRecord({
        school: base?.school || "",
        termAr: base?.termAr || "الأول",
        academicYearAr: base?.academicYearAr || "١٤٤٦هـ",
        classroom: line,
        teacherName: base?.signatures?.teacherName || "",
        principalName: base?.signatures?.principalName || "",
        formType: base?.formType || "yearwork"
      });
      r.title = `سجل ${line}`;
      addRecord(r);
    });
    saveAll(); syncUI(); render();
    alert("تم إنشاء السجلات: " + lines.length);
  });

  el("btnClearMany").addEventListener("click", ()=> el("bulkRecords").value = "");

  // Settings (بدون render على كل حرف إلا عند blur)
  el("formType").addEventListener("change", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.formType = e.target.value;
    if(!rec.title || rec.title.includes("اكتبي الاسم")) rec.title = buildRecordTitle(rec);
    touchRecord(rec); saveAll(); syncUI(); render();
  });

  el("subject").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.subject = e.target.value;
    touchRecord(rec); saveAll(); syncUI();
  });
  el("subject").addEventListener("blur", ()=> render());

  el("school").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.school = e.target.value;
    touchRecord(rec); saveAll(); syncUI();
  });
  el("school").addEventListener("blur", ()=> render());

  el("classroom").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.classroom = e.target.value;
    touchRecord(rec); saveAll(); syncUI();
  });
  el("classroom").addEventListener("blur", ()=> render());

  el("date").addEventListener("change", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.date = e.target.value;
    touchRecord(rec); saveAll(); syncUI(); render();
  });

  el("termAr").addEventListener("change", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.termAr = e.target.value;
    touchRecord(rec); saveAll(); syncUI(); render();
  });

  // إصلاح 1447: التحويل عند blur فقط
  el("academicYearAr").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.academicYearAr = e.target.value; // raw while typing
    touchRecord(rec); saveAll(); syncUI();
  });
  el("academicYearAr").addEventListener("blur", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.academicYearAr = normalizeAcademicYear(e.target.value);
    el("academicYearAr").value = rec.academicYearAr;
    touchRecord(rec); saveAll(); syncUI(); render();
  });

  el("recordTitle").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.title = e.target.value;
    touchRecord(rec); saveAll();
    refreshRecordSelect();
  });

  el("teacherName").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.signatures = rec.signatures || {};
    rec.signatures.teacherName = e.target.value;
    touchRecord(rec); saveAll(); syncUI();
  });
  el("principalName").addEventListener("input", (e)=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.signatures = rec.signatures || {};
    rec.signatures.principalName = e.target.value;
    touchRecord(rec); saveAll(); syncUI();
  });

  // Names
  el("btnApplyNames").addEventListener("click", ()=>{
    const rec = getActiveRecord(); if(!rec) return;
    const names = el("namesPaste").value.split(/\r?\n/);
    setStudentsFromNames(rec, names);
  });

  el("btnAddRow").addEventListener("click", ()=>{
    const rec = getActiveRecord(); if(!rec) return;
    rec.students = rec.students || [];
    rec.students.push({name:"", p1_a:0, p1_b:0, p2_a:0, p2_b:0, final:0, monthly:{}});
    touchRecord(rec); saveAll(); syncUI(); render();
  });

  el("csvFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const text = await f.text();
    const names = parseCSV(text);
    el("namesPaste").value = names.join("\n");
  });

  el("imgFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    await ocrNamesFromImage(f);
  });

  // Print/PDF
  el("btnPrint").addEventListener("click", doPrint);
  el("btnPDF").addEventListener("click", exportPDF);

  // Cloud
  el("btnCloudReload").addEventListener("click", async ()=>{
    await cloudLoad();
    await cloudVisit();
  });

  // JSON
  el("btnExportJSON").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `سجلات_${USER_KEY}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });
  el("btnImportJSON").addEventListener("click", ()=> el("jsonFile").click());
  el("jsonFile").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    try{
      const parsed = JSON.parse(await f.text());
      if(parsed && parsed.records){
        Object.assign(state, parsed);
        state.userKey = USER_KEY;
        state.records.forEach(r=>{ if(r.formType==="grades") r.formType="yearwork"; });
        ensureAtLeastOneRecord();
        saveAll(); syncUI(); render();
      }else alert("الملف لا يحتوي سجلات.");
    }catch(err){ alert("الملف غير صالح."); }
    finally{ e.target.value = ""; }
  });

  el("btnResetLocal").addEventListener("click", ()=>{
    if(!confirm("سيتم تصفير البيانات محليًا فقط (السحابة تبقى محفوظة).")) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  });

  el("btnSwitchUser").addEventListener("click", ()=> showLoginOverlay(true));
}

/* Init */
(function init(){
  if(getUserKey() === "default"){
    el("loginOverlay").classList.add("show");
  }
  el("btnLoginGo").onclick = ()=>{
    const nm = el("loginName").value.trim();
    if(!nm) return alert("اكتبي اسم المعلمة.");
    redirectToUser(nm);
  };
  el("btnLoginClose").onclick = ()=> el("loginOverlay").classList.remove("show");

  showUser();
  bumpLocalVisits();

  loadLocal();
  if(!state.records) state.records = [];
  if(!state.activeId) state.activeId = state.records[0]?.id || null;

  // ترقية قديم
  state.records.forEach(r=>{
    if(r.formType === "grades") r.formType = "yearwork";
  });

  if(state.records.length === 0){
    const r = defaultRecord({title:"سجل أول"});
    state.records.push(r);
    state.activeId = r.id;
  }

  saveLocal();
  attachTopEvents();
  syncUI();
  render();

  setCloudPill("جاري الاتصال…", null);
  cloudLoad();
  cloudVisit();

  window.addEventListener("beforeunload", saveLocal);
})();
</script>
</body>
</html>
